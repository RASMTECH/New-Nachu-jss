<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nachu Junior school</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .registration-form, .table-container {
            background: #90ee90;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
#reportGradeSelect {
  width: 100px;
}

      .form-group input, .form-group select, .form-group button {
    width: 25%;  /* reduced from 40% */
    padding: 8px;
    font-size: 15px;
    border: 1px solid #ccc;
    border-radius: 5px;
}
#recordMarksSection {
  background-color: #fff8dc; /* pale cream */
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #f0e0a0;
  margin-top: 20px;
}

        .form-group button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        .form-group button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        table th {
            background-color: #007bff;
            color: white;
        }
        table img {
            max-width: 50px;
            border-radius: 50%;
        }
  .filter-bar {
  display: flex;
  gap: 5px;
  margin-bottom: 20px;
}

.filter-bar input,
.filter-bar select {
  padding: 5px;
  font-size: 16px;
}

#reportGradeSelect {
  width: 200px; /* Or whatever fixed width you prefer */
  flex: 0 0 auto;
}
  
        .print-button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .print-button:hover {
            background-color: #218838;
        }

        /* Print-specific styles */
        @media print {
            .filter-bar, .form-group button, .print-button {
                display: none;
            }

            table {
                border: 1px solid #000;
            }

            table th, table td {
                border: 1px solid #000;
            }

            table th {
                background-color: black;
                color: white;
            }

            table td {
                background-color: #f2f2f2;
            }
        }
.modal {
  display: none; /* Hidden by default */
  position: fixed;
  z-index: 10;
  top: 50%; /* Position the modal at 50% of the viewport height */
  left: 50%; /* Position the modal at 50% of the viewport width */
  transform: translate(-50%, -50%); /* Offset by 50% of the modal's width and height to truly center */
  width: 60%;
  max-height: 100%; /* Adjust height to prevent overflow on smaller screens */
  overflow: auto; /* Add scroll if content overflows */
  background-color: rgba(0, 0, 0, 0.5); /* Background overlay */
  padding: 20px; /* Add some padding inside the modal */
  border-radius: 10px; /* Rounded corners for modern look */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow for elevation */
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 30px 30px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.close-btn {
  float: right;
  font-size: 24px;
  font-weight: bold;
  color: #aaa;
  cursor: pointer;
}

.close-btn:hover {
  color: #000;
}

.modal-title {
  text-align: center;
  margin-bottom: 25px;
  font-size: 1.5rem;
}

.form-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  margin-bottom: 5px;
  font-weight: 500;
}

.form-group input {
  padding: 8px 12px;
  border-radius: 5px;
  border: 1px solid #ccc;
}

.form-actions {
  text-align: center;
  margin-top: 20px;
}

.print-button {
  background-color: #2c3e50;
  color: white;
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
}

.print-button:hover {
  background-color: #1a252f;
}

.report-button {
  padding: 10px;
  font-size: 14px;
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 5px;
  text-align: left;
}

.report-button i {
  margin-right: 8px;
}

 .report-buttons-box {
  display: flex;
  flex-direction: column; /* Keeps buttons aligned vertically */
  align-items: flex-start; /* Aligns buttons to the left for natural width */
  gap: 10px; /* Space between buttons */
  padding: 10px;
  background: #f9f9f9;
  max-width: 45%; /* Allow buttons to dynamically resize within the container */
  border: 1px solid #ccc;
  border-radius: 10px;
  margin-top: 15px;
}

.report-button {
  display: inline-block; /* Ensures button width adapts to content */
  padding: 10px 15px; /* Adjust for height and inner spacing */
  font-size: 14px;
  font-weight: bold;
  color: white;
  border: none;
  border-radius: 5px;
  text-align: center;
  cursor: pointer;
  white-space: nowrap; /* Prevent text wrapping */
  width: auto; /* Let buttons size dynamically */
}

.report-button.red { background-color: #f44336; }
.report-button.blue { background-color: #2196f3; }
.report-button.green { background-color: #4caf50; }
.report-button.purple { background-color: #9c27b0; }
.report-button.orange { background-color: #ff9800; }
.report-button.teal { background-color: #009688; }
.report-button.gray { background-color: #607d8b; }

.report-button i {
  margin-right: 8px; /* Space between icon and text */
}


  /* Optional: Space between buttons */
  .report-button + .report-button {
    margin-left: 10px; /* Add spacing between buttons */
  }
/* LOGIN FORM STYLES */
#loginSection, #resetPasswordSection {
  max-width: 300px;
  margin: 60px auto;
  padding: 30px 25px;
  background-color: #ffffff;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  font-family: 'Segoe UI', sans-serif;
}

#loginSection h1, #resetPasswordSection h2 {
  font-size: 24px;
  margin-bottom: 10px;
  color: #333;
}

#loginSection p {
  margin-bottom: 20px;
  font-size: 14px;
  color: #c0392b;
}

#marksCountBadge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 20px;        /* Rounded pill shape */
  background-color: #28a745;  /* Bootstrap's green */
  color: white;
  font-weight: 600;
  font-size: 0.9rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  user-select: none;
  margin-top: 8px;
}

#loginForm input,
#resetPasswordForm input {
  width: 80%;
  padding: 12px 10px;
  margin-bottom: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 15px;
  transition: border-color 0.3s ease;
}

#loginForm input:focus,
#resetPasswordForm input:focus {
  border-color: #007bff;
  outline: none;
}

.btn-login,
#resetPasswordForm button {
  width: 80%;
  padding: 12px;
  background-color: #007bff;
  border: none;
  color: white;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
  transition: background-color 0.25s ease;
}

.btn-login:hover,
#resetPasswordForm button:hover {
  background-color: #0056b3;
}

button[onclick^="show"] {
  margin-top: 10px;
  background: none;
  border: none;
  color: #007bff;
  cursor: pointer;
  text-decoration: underline;
}

#loginError,
#resetError,
#resetSuccess {
  font-size: 14px;
  margin-top: 10px;
}
/* General Print Styling */
@media print {
    /* Prevent content from breaking across pages */
    .no-break {
        page-break-inside: avoid;
    }

    /* Adjust margins for printed pages */
    body {
        margin: 0;
        padding: 10px;
    }

    /* Ensure the layout fits within the page width */
    .container {
        width: 100%;
        max-width: 100%;
    }

    /* Optional: Hide elements like buttons or navigation during print */
    .no-print {
        display: none;
    }

    /* Tables: Add borders for clarity */
    table {
        border-collapse: collapse;
        width: 100%;
    }
    table th, table td {
        border: 1px solid #000;
        padding: 8px;
    }
}
.learners-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.learners-table th, 
.learners-table td {
  border: 1px solid #000;
  padding: 8px;
  text-align: left;
}

.learners-table th {
  background-color: #f0f0f0;
  font-weight: bold;
  color: #000;
}

.learners-table tr:nth-child(even) {
  background-color: #fafafa;
}

.learners-table tr:hover {
  background-color: #e0e0e0;
}
.marks-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.marks-table th, 
.marks-table td {
  border: 1px solid #000;
  padding: 8px;
  text-align: left;
}

.marks-table th {
  background-color: #f0f0f0;
  font-weight: bold;
  color: #000;
}

.marks-table tr:nth-child(even) {
  background-color: #fafafa;
}

.marks-table tr:hover {
  background-color: #e0e0e0;
}
.filter-bar input,
.filter-bar select,
.filter-bar button {
  height: 32px;
  padding: 4px 8px;
  font-size: 14px;
  border-radius: 4px;
  border: 1px solid #ccc;
  margin-right: 8px;
}

#marksExamPeriodSelect {
  width: 220px;
}
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  min-width: 250px;
  padding: 16px;
  background-color: #323232;
  color: #fff;
  border-radius: 6px;
  opacity: 0;
  transition: opacity 0.5s ease, bottom 0.5s ease;
  z-index: 9999;
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.toast.show {
  opacity: 1;
  bottom: 50px;
}

.toast.success {
  background-color: #4CAF50;
}

.toast.error {
  background-color: #F44336;
}

.toast.info {
  background-color: #2196F3;
}
#marksInputs {
  display: grid;
  grid-template-columns: 1fr 1fr; /* two equal columns */
  gap: 15px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  font-weight: bold;
  margin-bottom: 5px;
}

.form-group input {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
@media (max-width: 600px) {
  #marksInputs {
    grid-template-columns: 1fr;
  }
}

@keyframes blink {
  0%   { opacity: 1; }
  50%  { opacity: 0; }
  100% { opacity: 1; }
}

.blinking {
  animation: blink 1s infinite;
}

    .stamp {
            border: 2px solid blue; /* Border for stamp */
            color: blue; /* Text color for stamp */
            width: 200px; /* Adjusted width for visibility */
            height: 70px; /* Adjusted height for visibility */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            text-align: center;
            font-weight: bold;
        }
.print-only { display: none; }

@media print {
    .print-only {
        display: flex;
        border: 2px solid blue;
        color: blue;
        width: 220px;
        height: auto;
        align-items: center;
        justify-content: center;
        margin: 30px auto 0 auto;
        text-align: center;
        font-weight: bold;
        flex-direction: column;
        padding: 8px;
        font-size: 14px;
    }
}
.btn-blue {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.btn-blue:hover {
    background-color: #0056b3;
}

.btn-red {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.btn-red:hover {
    background-color: #a71d2a;
}
@media print {
  body {
    margin: 0;
    padding: 10px;
    zoom: 80%; /* Shrinks content to fit on one page */
  }

  .container {
    page-break-inside: avoid;
    break-inside: avoid;
    width: 100%;
    max-width: 100%;
  }

  table {
    page-break-inside: avoid;
  }

  .no-break, .marks-table, .learners-table {
    page-break-inside: avoid;
    break-inside: avoid;
  }

  .print-button, .filter-bar, .form-group button {
    display: none;
  }
}
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
/* General report/print button styles */
.report-button,
.print-button {
  width: 45%;          /* reduced width */
  margin-bottom: 12px;
  display: block;      /* ensures stacking */
  text-align: left;    /* keeps content aligned left */
  padding: 10px 14px;  /* consistent spacing */
  border: none;
  border-radius: 6px;
  cursor: pointer;
  display: flex;       /* aligns icon + text */
  align-items: center;
  gap: 8px;            /* space between icon and text */
}

/* Optional: keep gray theme */
.report-button.gray {
  background-color: #6c757d;
  color: #fff;
}

/* Optional: style print-button separately if needed */
.print-button {
  background-color: #28a745; /* green example */
  color: #fff;
}

/* Special case: blue button */
#showMarksStatusBtn {
  width: 45%;   /* shrink like others */
  background-color: #007bff;
  color: #fff;
}

    </style>
</head>
<body>
<!-- LOGIN SECTION -->
<div id="loginSection" style="display: block; text-align: center; margin-top: 50px; background-image: url('https://i.imgur.com/LJG5Eca.jpeg'); background-size: cover; background-position: center; background-repeat: no-repeat; padding: 40px; border-radius: 8px;">
 
  <h1 style="color: white;">RASM SCHOOL MANAGEMENT SYSTEM</h1>
  <p style="color: red; font-weight: bold; color: white;">NACHU JUNIOR SCHOOL</p>

  <form id="loginForm">
    <input type="text" id="username" placeholder="Username" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.7); border: none; border-radius: 4px;"><br><br>
    <input type="password" id="password" placeholder="Password" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.7); border: none; border-radius: 4px;"><br><br>
    <button type="submit" class="btn-login" style="padding: 10px 14px; background: #3F51B5; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;"> 
      <span class="material-icons">login</span> Login
    </button>
  </form>
  <div id="loginError" style="color: red; display: none;">Invalid username or password</div>
  <br>
  <button onclick="showResetPasswordForm()" style="background: #FF5722; color: white; border: none; border-radius: 4px; padding: 10px 14px; cursor: pointer;">Forgot Password?</button>
</div>

<!-- RESET PASSWORD SECTION -->
<div id="resetPasswordSection" style="display: none; text-align: center; margin-top: 50px; background-image: url('https://i.imgur.com/jixmLF9.jpeg'); background-size: cover; background-position: center; background-repeat: no-repeat; padding: 40px; border-radius: 8px;">
  <h2 style="color: white;">Reset Your Password</h2>
  <form id="resetPasswordForm">
    <input type="email" id="resetEmail" placeholder="Enter your email" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.7); border: none; border-radius: 4px;"><br><br>
    <button type="submit" style="padding: 10px 14px; background: #3F51B5; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Send Reset Link</button>
  </form>
  <div id="resetSuccess" style="color: green; display: none;">‚úÖ Reset email sent successfully!</div>
  <div id="resetError" style="color: red; display: none;">‚ùå Failed to send reset email. Try again.</div>
  <br>
  <button onclick="showLoginForm()" style="background: #FF5722; color: white; border: none; border-radius: 4px; padding: 10px 14px; cursor: pointer;">Back to Login</button>
</div>


<!-- MAIN CONTENT SECTION -->
<div id="mainContent" style="display: none; padding: 20px;">

  <!-- Learners Database Master Toggle -->
  <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 10px;">
    <button
      type="button"
      id="masterToggleBtn"
      style="background-color: #673AB7; color: white; height: 50px; padding: 0 20px; border: none; border-radius: 4px; font-size: 1rem; display: inline-flex; align-items: center; cursor: pointer;"
    >
      <i class="fas fa-database" style="margin-right: 8px; font-size: 1.2em;"></i>
      Learners Database
    </button>

    <div id="learnersButtons" style="display: none; flex-direction: column; gap: 8px; width: 100%;">
      <button
        type="button"
        id="toggleTableBtn"
        style="background-color: #2196F3; color: white; height: 48px; padding: 0 16px; border: none; border-radius: 4px; font-size: 1rem; display: inline-flex; align-items: center; cursor: pointer;"
      >
        <i class="fas fa-list" style="margin-right: 6px;"></i>
        Registered Learners
      </button>

      <button
        type="button"
        id="toggleFormBtn"
        style="background-color: #4CAF50; color: white; height: 50px; padding: 0 20px; border: none; border-radius: 4px; font-size: 1rem; display: inline-flex; align-items: center; cursor: pointer;"
      >
        <i class="fas fa-user-plus" style="margin-right: 8px;"></i>
        Register Learner
      </button>
    </div>
  </div>

  <div id="announcement" style="margin: 10px 0; padding: 10px 15px; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 4px; font-size: 0.95rem;">
    üì¢ <strong>Note:</strong> All new learners must be registered before entering marks.
  </div>

  <!-- Exam & Marks Controls Master Toggle -->
  <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 10px; margin-top: 20px;">
    <button
      type="button"
      id="masterReportsBtn"
      style="background-color: #9C27B0; color: white; height: 48px; padding: 0 20px; border: none; border-radius: 4px; font-size: 1rem; display: inline-flex; align-items: center; cursor: pointer;"
    >
      <i class="fas fa-chart-bar" style="margin-right: 8px;"></i>
      <span class="btn-label">Exam & Marks Controls</span>
    </button>
  </div>

  <div id="reportsControls" style="display: none; flex-direction: column; gap: 8px; width: 100%;">
    <button
      class="print-button"
      id="togglePerformanceReportsBtn"
      style="background-color: #03A9F4; color: white; height: 44px; padding: 0 16px; border: none; border-radius: 4px; font-size: 1rem; display: inline-flex; align-items: center; cursor: pointer;"
    >
      <i class="fas fa-chevron-down" style="margin-right: 6px;"></i>
      Exam Reports
    </button>

    <button
      class="print-button"
      id="toggleMarksSectionBtn"
      style="background-color: #03A9F4; color: white; height: 44px; padding: 0 16px; border: none; border-radius: 4px; font-size: 1rem; display: inline-flex; align-items: center; cursor: pointer;"
    >
      <i class="fas fa-chevron-down" style="margin-right: 6px;"></i>
      Marks Section
    </button>
  
  <!-- Online Safety Note -->
  <div id="onlineSafetyNote" style="position: relative; margin: 15px 0; padding: 14px 20px; background-color: #e0f7fa; border-left: 5px solid #00796b; color: #004d40; border-radius: 5px; font-size: 0.95rem; line-height: 1.5;">
    üîí <strong>Online Safety Tip:</strong> Always protect your personal information and avoid sharing passwords or sensitive data on public networks.<br><br>
    üå∏ <em>RASM Wishes you a productive and wonderful day ahead!</em>
    <span onclick="this.parentElement.style.display='none';" style="position: absolute; top: 10px; right: 14px; cursor: pointer; color: #004d40; font-weight: bold;">&times;</span>
  </div>

</div>

<!-- Wrapped form, hidden by default -->
<div id="registrationContainer" style="display: none; margin-top: 20px; max-width: 450px; margin: auto; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background-image: url('https://i.imgur.com/jixmLF9.jpeg'); background-size: cover; background-position: center; background-repeat: no-repeat;">
  <h2 style="color: white; background-color: rgba(255, 215, 0, 0.8); padding: 10px 12px; border-radius: 4px; text-align: center;">
    Register Learner
  </h2>

  <form id="learnerForm">
    <label style="color: white;">Name:</label>
    <input type="text" id="name" placeholder="Enter name" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 4px;"><br>

    <label style="color: white;">Gender:</label>
    <select id="gender" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 4px;">
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select><br>

    <label style="color: white;">Grade:</label>
    <input type="text" id="grade" placeholder="Enter grade e.g. Grade 9A" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 4px;"><br>

    <label style="color: white;">Age:</label>
    <input type="number" id="age" placeholder="Enter age" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 4px;"><br>

    <label style="color: white;">Parent Name:</label>
    <input type="text" id="parentName" placeholder="Enter parent name" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 4px;"><br>

    <label style="color: white;">Parent Phone:</label>
    <input type="tel" id="parentPhone" placeholder="Enter phone number" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 4px;"><br>

    <label style="color: white;">Birth Certificate No:</label>
    <input type="text" id="birthCert" placeholder="Enter birth certificate no" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 4px;"><br>

    <label style="color: white;">Admission Number:</label>
    <input type="text" id="admissionNo" placeholder="Enter admission number" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 4px;"><br>

    <label style="color: white;">Learner Photo:</label>
    <input type="file" id="photo" accept="image/*" required style="width: 100%; padding: 8px; margin: 6px 0; background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 4px;"><br>

    <button type="button" id="registerButton"
      style="padding: 10px 14px; background: #3F51B5; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 12px; width: 100%;">
      <i class="fas fa-user-plus" style="margin-right: 6px;"></i> Register Learner
    </button>
  </form>
</div>


  </div>
<div id="tableContainer" style="display: none; margin-top: 20px;">
  <h2>Registered Learners</h2>

<!-- Filter Bar Box -->
  <div class="filter-bar" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Search Name / Adm No"
      style="padding: 6px 8px; border: 2px solid #007BFF; border-radius: 5px; background-color: #e9f2ff; color: #333; font-size: 13px; min-width: 180px; outline: none;">
  
    <select 
      id="filterGrade"
      style="padding: 6px 8px; border: 2px solid #28a745; border-radius: 5px; background-color: #e9ffe9; color: #333; font-size: 13px; width: 130px;">
      <option value="">Filter by Grade</option>
    </select>
  
    <select 
      id="filterGender"
      style="padding: 6px 8px; border: 2px solid #ffc107; border-radius: 5px; background-color: #fff8e1; color: #333; font-size: 13px; width: 130px;">
      <option value="">Filter by Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>
  </div>



 <!-- Action Box -->
<div class="action-box" style="border: 2px solid #ccc; padding: 16px; border-radius: 8px; background-color: #f9f9f9; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
  <!-- Action Buttons -->
  <div class="action-buttons" style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px;">
    
    <button class="print-button action-btn" id="printButton" style="background-color: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">
      <i class="fas fa-print"></i> Print Filtered Learners
    </button>
    
    <button class="print-button action-btn" id="printGroupedByGenderButton" style="background-color: #2196F3; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">
      <i class="fas fa-venus-mars"></i> Print Grouped by Gender
    </button>
    
    <button class="print-button action-btn" id="generateParentsListBtn" style="background-color: #FF9800; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">
      <i class="fas fa-users"></i> Generate Parents List
    </button>
    
    <button class="print-button action-btn" id="toggleClassListSectionBtn" style="background-color: #9C27B0; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">
      <i class="fas fa-chevron-down"></i> Class List Generator
    </button>
    
    <button class="print-button action-btn" onclick="promoteLearners()" style="background-color: #FF5722; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">
      <i class="fas fa-level-up-alt"></i> Promote Learners
    </button>

  <select id="filterGradeSelect">
  <option value="">Select Grade</option>
</select>

<button id="deleteGradeBtn" class="btn-red">
  <i class="fas fa-trash"></i> Delete All In Selected Grade
</button>


    <button class="print-button action-btn" onclick="undoPromotion()" style="background-color: #607D8B; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer;">
      <i class="fas fa-undo-alt"></i> Undo Promotion
    </button>
  </div>
</div>

  </h2>
    <h2 style="background-color: rgba(255, 255, 255, 0.7); padding: 8px 16px; border-radius: 6px; display: inline-block; color: #2c3e50;">
      <span style="color: #e74c3c;">No More Manual School Management  Crunching!
Rasm Does It All ‚Äì Just Click and See It Done!.</span>
    </h2>
  <!-- Learners Table -->
  <table class="learners-table" style="margin-top: 20px;">
    <thead>
      <tr>
        <th>No.</th>
        <th>Photo</th>
        <th>Name</th>
        <th>Gender</th>
        <th>Grade</th>
        <th>Age</th>
        <th>Parent Name</th>
        <th>Parent Phone No</th>
        <th>Birth Certificate No</th>
        <th>Admission Number</th>
        <th>Photo Edit</th>
       <th>Action</th>
      </tr>
    </thead>
    <tbody id="learnersList"></tbody>
  </table>
<div id="spinnerContainer" style="text-align:center; margin: 20px 0; display: none;">
  <div class="spinner"></div>
  <p id="spinnerCountdown" style="font-size: 14px; color: #555; margin-top: 10px;">Loading... 0s</p>
</div>

  <!-- Class List Generator Section -->
  <div id="classListSection" class="table-container" style="display: none; margin-top: 20px;">
    <h2 style="background-color: #ffff00; padding: 8px 16px; border-radius: 6px; display: inline-block;">Generate Class List per Grade</h2>

    <div class="filter-bar" style="margin: 15px 0;">
      <select id="classListGradeSelect">
        <option value="">Select Grade</option>
      </select>
      <button class="print-button" id="generateClassListBtn">
        <i class="fas fa-list"></i> Generate Class List
      </button>
    </div>

    <div id="classListOutput"></div>
  </div>
</div>

<!-- Modal -->
<div id="learnerModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Learner Details</h3>
    <div id="modalDetails"></div>
  </div>
</div>
<!-- Record Marks Section -->
<div id="recordMarksSection" style="max-width: 400px; margin: auto; display: none; background-color: #8BC34A; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
  background-image: url('https://i.imgur.com/jvsjwnI.jpeg'), url('https://i.imgur.com/L38mwvO.jpeg'); 
  background-size: cover, cover; 
  background-position: center, bottom right; 
  height: auto;">

  <h2 style="color: white; background-color: gold; padding: 8px 8px; border-radius: 3px; text-align: center; font-size: 1.2rem;">
    Record Learner Marks
  </h2>

  <h3 style="background-color: rgba(255, 255, 255, 0.7); padding: 6px 12px; border-radius: 6px; display: inline-block; color: #2c3e50; text-align: center; margin-bottom: 15px;">
    <span style="color: #e74c3c; font-size: 1rem;">No More Manual Exam Crunching! Rasm Does It All ‚Äì Just Click and See It Done!</span>
  </h3>

  <form id="marksForm" style="font-size: 0.9rem;">

    <!-- Grade Selection -->
    <label><strong>Grade:</strong></label>
    <select id="gradeSelect" required 
      style="width: 100%; padding: 6px; margin: 6px 0; background-color: #fff8c6; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;">
      <option value="">Select Grade</option>
    </select><br>

    <!-- Learner Selection -->
    <label><strong>Learner:</strong></label>
    <select id="learnerSelect" required 
      style="width: 100%; padding: 6px; margin: 6px 0; background-color: #fff8c6; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;">
      <option value="">Select Learner</option>
    </select><br>

    <!-- Exam Period Selection -->
    <div class="form-group">
      <label for="examPeriod"><strong>Select Period</strong></label>
      <select id="examPeriod" required
        style="width: 100%; padding: 6px; margin: 6px 0; background-color: #fff8c6; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;">
        <option value="">-- Select Period --</option>
       <option value="2024, Term 1, Opener Exam">2024, Term 1, Opener Exam</option>
<option value="2024, Term 1, Midterm Exam">2024, Term 1, Midterm Exam</option>
<option value="2024, Term 1, End Term Exam">2024, Term 1, End Term Exam</option>
<option value="2024, Term 2, Opener Exam">2024, Term 2, Opener Exam</option>
<option value="2024, Term 2, Midterm Exam">2024, Term 2, Midterm Exam</option>
<option value="2024, Term 2, End Term Exam">2024, Term 2, End Term Exam</option>
<option value="2024, Term 3, Opener Exam">2024, Term 3, Opener Exam</option>
<option value="2024, Term 3, Midterm Exam">2024, Term 3, Midterm Exam</option>
<option value="2024, Term 3, End Term Exam">2024, Term 3, End Term Exam</option>

<option value="2025, Term 1, Opener Exam">2025, Term 1, Opener Exam</option>
<option value="2025, Term 1, Midterm Exam">2025, Term 1, Midterm Exam</option>
<option value="2025, Term 1, End Term Exam">2025, Term 1, End Term Exam</option>
<option value="2025, Term 2, Opener Exam">2025, Term 2, Opener Exam</option>
<option value="2025, Term 2, Midterm Exam">2025, Term 2, Midterm Exam</option>
<option value="2025, Term 2, End Term Exam">2025, Term 2, End Term Exam</option>
<option value="2025, Term 3, Opener Exam">2025, Term 3, Opener Exam</option>
<option value="2025, Term 3, Midterm Exam">2025, Term 3, Midterm Exam</option>
<option value="2025, Term 3, End Term Exam">2025, Term 3, End Term Exam</option>

<option value="2026, Term 1, Opener Exam">2026, Term 1, Opener Exam</option>
<option value="2026, Term 1, Midterm Exam">2026, Term 1, Midterm Exam</option>
<option value="2026, Term 1, End Term Exam">2026, Term 1, End Term Exam</option>
<option value="2026, Term 2, Opener Exam">2026, Term 2, Opener Exam</option>
<option value="2026, Term 2, Midterm Exam">2026, Term 2, Midterm Exam</option>
<option value="2026, Term 2, End Term Exam">2026, Term 2, End Term Exam</option>
<option value="2026, Term 3, Opener Exam">2026, Term 3, Opener Exam</option>
<option value="2026, Term 3, Midterm Exam">2026, Term 3, Midterm Exam</option>
<option value="2026, Term 3, End Term Exam">2026, Term 3, End Term Exam</option>

<option value="2027, Term 1, Opener Exam">2027, Term 1, Opener Exam</option>
<option value="2027, Term 1, Midterm Exam">2027, Term 1, Midterm Exam</option>
<option value="2027, Term 1, End Term Exam">2027, Term 1, End Term Exam</option>
<option value="2027, Term 2, Opener Exam">2027, Term 2, Opener Exam</option>
<option value="2027, Term 2, Midterm Exam">2027, Term 2, Midterm Exam</option>
<option value="2027, Term 2, End Term Exam">2027, Term 2, End Term Exam</option>
<option value="2027, Term 3, Opener Exam">2027, Term 3, Opener Exam</option>
<option value="2027, Term 3, Midterm Exam">2027, Term 3, Midterm Exam</option>
<option value="2027, Term 3, End Term Exam">2027, Term 3, End Term Exam</option>
<!-- 2028 -->
<option value="2028, Term 1, Opener Exam">2028, Term 1, Opener Exam</option>
<option value="2028, Term 1, Midterm Exam">2028, Term 1, Midterm Exam</option>
<option value="2028, Term 1, End Term Exam">2028, Term 1, End Term Exam</option>
<option value="2028, Term 2, Opener Exam">2028, Term 2, Opener Exam</option>
<option value="2028, Term 2, Midterm Exam">2028, Term 2, Midterm Exam</option>
<option value="2028, Term 2, End Term Exam">2028, Term 2, End Term Exam</option>
<option value="2028, Term 3, Opener Exam">2028, Term 3, Opener Exam</option>
<option value="2028, Term 3, Midterm Exam">2028, Term 3, Midterm Exam</option>
<option value="2028, Term 3, End Term Exam">2028, Term 3, End Term Exam</option>

<!-- 2029 -->
<option value="2029, Term 1, Opener Exam">2029, Term 1, Opener Exam</option>
<option value="2029, Term 1, Midterm Exam">2029, Term 1, Midterm Exam</option>
<option value="2029, Term 1, End Term Exam">2029, Term 1, End Term Exam</option>
<option value="2029, Term 2, Opener Exam">2029, Term 2, Opener Exam</option>
<option value="2029, Term 2, Midterm Exam">2029, Term 2, Midterm Exam</option>
<option value="2029, Term 2, End Term Exam">2029, Term 2, End Term Exam</option>
<option value="2029, Term 3, Opener Exam">2029, Term 3, Opener Exam</option>
<option value="2029, Term 3, Midterm Exam">2029, Term 3, Midterm Exam</option>
<option value="2029, Term 3, End Term Exam">2029, Term 3, End Term Exam</option>

<!-- 2030 -->
<option value="2030, Term 1, Opener Exam">2030, Term 1, Opener Exam</option>
<option value="2030, Term 1, Midterm Exam">2030, Term 1, Midterm Exam</option>
<option value="2030, Term 1, End Term Exam">2030, Term 1, End Term Exam</option>
<option value="2030, Term 2, Opener Exam">2030, Term 2, Opener Exam</option>
<option value="2030, Term 2, Midterm Exam">2030, Term 2, Midterm Exam</option>
<option value="2030, Term 2, End Term Exam">2030, Term 2, End Term Exam</option>
<option value="2030, Term 3, Opener Exam">2030, Term 3, Opener Exam</option>
<option value="2030, Term 3, Midterm Exam">2030, Term 3, Midterm Exam</option>
<option value="2030, Term 3, End Term Exam">2030, Term 3, End Term Exam</option>

<!-- 2031 -->
<option value="2031, Term 1, Opener Exam">2031, Term 1, Opener Exam</option>
<option value="2031, Term 1, Midterm Exam">2031, Term 1, Midterm Exam</option>
<option value="2031, Term 1, End Term Exam">2031, Term 1, End Term Exam</option>
<option value="2031, Term 2, Opener Exam">2031, Term 2, Opener Exam</option>
<option value="2031, Term 2, Midterm Exam">2031, Term 2, Midterm Exam</option>
<option value="2031, Term 2, End Term Exam">2031, Term 2, End Term Exam</option>
<option value="2031, Term 3, Opener Exam">2031, Term 3, Opener Exam</option>
<option value="2031, Term 3, Midterm Exam">2031, Term 3, Midterm Exam</option>
<option value="2031, Term 3, End Term Exam">2031, Term 3, End Term Exam</option>

<!-- 2032 -->
<option value="2032, Term 1, Opener Exam">2032, Term 1, Opener Exam</option>
<option value="2032, Term 1, Midterm Exam">2032, Term 1, Midterm Exam</option>
<option value="2032, Term 1, End Term Exam">2032, Term 1, End Term Exam</option>
<option value="2032, Term 2, Opener Exam">2032, Term 2, Opener Exam</option>
<option value="2032, Term 2, Midterm Exam">2032, Term 2, Midterm Exam</option>
<option value="2032, Term 2, End Term Exam">2032, Term 2, End Term Exam</option>
<option value="2032, Term 3, Opener Exam">2032, Term 3, Opener Exam</option>
<option value="2032, Term 3, Midterm Exam">2032, Term 3, Midterm Exam</option>
<option value="2032, Term 3, End Term Exam">2032, Term 3, End Term Exam</option>
<!-- 2033 -->
<option value="2033, Term 1, Opener Exam">2033, Term 1, Opener Exam</option>
<option value="2033, Term 1, Midterm Exam">2033, Term 1, Midterm Exam</option>
<option value="2033, Term 1, End Term Exam">2033, Term 1, End Term Exam</option>
<option value="2033, Term 2, Opener Exam">2033, Term 2, Opener Exam</option>
<option value="2033, Term 2, Midterm Exam">2033, Term 2, Midterm Exam</option>
<option value="2033, Term 2, End Term Exam">2033, Term 2, End Term Exam</option>
<option value="2033, Term 3, Opener Exam">2033, Term 3, Opener Exam</option>
<option value="2033, Term 3, Midterm Exam">2033, Term 3, Midterm Exam</option>
<option value="2033, Term 3, End Term Exam">2033, Term 3, End Term Exam</option>

<!-- 2034 -->
<option value="2034, Term 1, Opener Exam">2034, Term 1, Opener Exam</option>
<option value="2034, Term 1, Midterm Exam">2034, Term 1, Midterm Exam</option>
<option value="2034, Term 1, End Term Exam">2034, Term 1, End Term Exam</option>
<option value="2034, Term 2, Opener Exam">2034, Term 2, Opener Exam</option>
<option value="2034, Term 2, Midterm Exam">2034, Term 2, Midterm Exam</option>
<option value="2034, Term 2, End Term Exam">2034, Term 2, End Term Exam</option>
<option value="2034, Term 3, Opener Exam">2034, Term 3, Opener Exam</option>
<option value="2034, Term 3, Midterm Exam">2034, Term 3, Midterm Exam</option>
<option value="2034, Term 3, End Term Exam">2034, Term 3, End Term Exam</option>

<!-- 2035 -->
<option value="2035, Term 1, Opener Exam">2035, Term 1, Opener Exam</option>
<option value="2035, Term 1, Midterm Exam">2035, Term 1, Midterm Exam</option>
<option value="2035, Term 1, End Term Exam">2035, Term 1, End Term Exam</option>
<option value="2035, Term 2, Opener Exam">2035, Term 2, Opener Exam</option>
<option value="2035, Term 2, Midterm Exam">2035, Term 2, Midterm Exam</option>
<option value="2035, Term 2, End Term Exam">2035, Term 2, End Term Exam</option>
<option value="2035, Term 3, Opener Exam">2035, Term 3, Opener Exam</option>
<option value="2035, Term 3, Midterm Exam">2035, Term 3, Midterm Exam</option>
<option value="2035, Term 3, End Term Exam">2035, Term 3, End Term Exam</option>

<!-- 2036 -->
<option value="2036, Term 1, Opener Exam">2036, Term 1, Opener Exam</option>
<option value="2036, Term 1, Midterm Exam">2036, Term 1, Midterm Exam</option>
<option value="2036, Term 1, End Term Exam">2036, Term 1, End Term Exam</option>
<option value="2036, Term 2, Opener Exam">2036, Term 2, Opener Exam</option>
<option value="2036, Term 2, Midterm Exam">2036, Term 2, Midterm Exam</option>
<option value="2036, Term 2, End Term Exam">2036, Term 2, End Term Exam</option>
<option value="2036, Term 3, Opener Exam">2036, Term 3, Opener Exam</option>
<option value="2036, Term 3, Midterm Exam">2036, Term 3, Midterm Exam</option>
<option value="2036, Term 3, End Term Exam">2036, Term 3, End Term Exam</option>

<!-- 2037 -->
<option value="2037, Term 1, Opener Exam">2037, Term 1, Opener Exam</option>
<option value="2037, Term 1, Midterm Exam">2037, Term 1, Midterm Exam</option>
<option value="2037, Term 1, End Term Exam">2037, Term 1, End Term Exam</option>
<option value="2037, Term 2, Opener Exam">2037, Term 2, Opener Exam</option>
<option value="2037, Term 2, Midterm Exam">2037, Term 2, Midterm Exam</option>
<option value="2037, Term 2, End Term Exam">2037, Term 2, End Term Exam</option>
<option value="2037, Term 3, Opener Exam">2037, Term 3, Opener Exam</option>
<option value="2037, Term 3, Midterm Exam">2037, Term 3, Midterm Exam</option>
<option value="2037, Term 3, End Term Exam">2037, Term 3, End Term Exam</option>

<option value="2038, Term 1, Opener Exam">2038, Term 1, Opener Exam</option>
<option value="2038, Term 1, Midterm Exam">2038, Term 1, Midterm Exam</option>
<option value="2038, Term 1, End Term Exam">2038, Term 1, End Term Exam</option>
<option value="2038, Term 2, Opener Exam">2038, Term 2, Opener Exam</option>
<option value="2038, Term 2, Midterm Exam">2038, Term 2, Midterm Exam</option>
<option value="2038, Term 2, End Term Exam">2038, Term 2, End Term Exam</option>
<option value="2038, Term 3, Opener Exam">2038, Term 3, Opener Exam</option>
<option value="2038, Term 3, Midterm Exam">2038, Term 3, Midterm Exam</option>
<option value="2038, Term 3, End Term Exam">2038, Term 3, End Term Exam</option>


<option value="2039, Term 1, Opener Exam">2039, Term 1, Opener Exam</option>
<option value="2039, Term 1, Midterm Exam">2039, Term 1, Midterm Exam</option>
<option value="2039, Term 1, End Term Exam">2039, Term 1, End Term Exam</option>
<option value="2039, Term 2, Opener Exam">2039, Term 2, Opener Exam</option>
<option value="2039, Term 2, Midterm Exam">2039, Term 2, Midterm Exam</option>
<option value="2039, Term 2, End Term Exam">2039, Term 2, End Term Exam</option>
<option value="2039, Term 3, Opener Exam">2039, Term 3, Opener Exam</option>
<option value="2039, Term 3, Midterm Exam">2039, Term 3, Midterm Exam</option>
<option value="2039, Term 3, End Term Exam">2039, Term 3, End Term Exam</option>

<option value="2040, Term 1, Opener Exam">2040, Term 1, Opener Exam</option>
<option value="2040, Term 1, Midterm Exam">2040, Term 1, Midterm Exam</option>
<option value="2040, Term 1, End Term Exam">2040, Term 1, End Term Exam</option>
<option value="2040, Term 2, Opener Exam">2040, Term 2, Opener Exam</option>
<option value="2040, Term 2, Midterm Exam">2040, Term 2, Midterm Exam</option>
<option value="2040, Term 2, End Term Exam">2040, Term 2, End Term Exam</option>
<option value="2040, Term 3, Opener Exam">2040, Term 3, Opener Exam</option>
<option value="2040, Term 3, Midterm Exam">2040, Term 3, Midterm Exam</option>
<option value="2040, Term 3, End Term Exam">2040, Term 3, End Term Exam</option>

      </select>
    </div>

    <!-- Marks Inputs with Placeholder Text for Subjects -->
    <div id="marksInputs">
      <div class="form-group">
        <input type="number" id="eng" required placeholder="Eng" style="width: 100%; padding: 6px;">
      </div>
      <div class="form-group">
        <input type="number" id="math" required placeholder="Math" style="width: 100%; padding: 6px;">
      </div>
      <div class="form-group">
        <input type="number" id="preTech" required placeholder="Pre-Tech" style="width: 100%; padding: 6px;">
      </div>
      <div class="form-group">
        <input type="number" id="kiswahili" required placeholder="Kiswahili" style="width: 100%; padding: 6px;">
      </div>
      <div class="form-group">
        <input type="number" id="science" required placeholder="Science" style="width: 100%; padding: 6px;">
      </div>
      <div class="form-group">
        <input type="number" id="social" required placeholder="Social" style="width: 100%; padding: 6px;">
      </div>
      <div class="form-group">
        <input type="number" id="agriculture" required placeholder="Agriculture" style="width: 100%; padding: 6px;">
      </div>
      <div class="form-group">
        <input type="number" id="cre" required placeholder="CRE" style="width: 100%; padding: 6px;">
      </div>
      <div class="form-group">
        <input type="number" id="creativeArt" required placeholder="Creative Art" style="width: 100%; padding: 6px;">
      </div>
    </div>

    <!-- Submit Button -->
    <div class="form-group" style="text-align: center; margin-top: 10px;">
      <button type="button" id="saveMarksButton" style="background-color: #4CAF50; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 1rem; border-radius: 4px;">
        <i class="fas fa-save"></i> Save Marks
      </button>
      <div id="marksCountBadge" style="margin: 8px 0; font-weight: bold; color: #333;"></div>
    </div>
  </form>
</div>




<!-- Action Box for Marks Display -->
<div id="marksSection" style="display: none; margin-top: 20px;">
  <div class="action-box" style="display: flex; flex-wrap: wrap; gap: 20px; padding: 20px; background-image: url('https://i.imgur.com/h7ijdv9.jpeg'); background-size: cover; background-position: center; border-radius: 8px; color: white;">
    <h2 style="background-color: rgba(255, 255, 255, 0.7); padding: 8px 16px; border-radius: 6px; display: inline-block; color: #2c3e50;">
      <span style="color: #e74c3c;">Power Up Your Exams with Rasm!
Fast, Secure, and Reliable.</span>
    </h2>

    <!-- Search Input -->
    <div class="form-group" style="flex: 1; min-width: 220px;">
      <label for="searchMarksInput" style="font-weight: bold; color: #3498db;"><strong>Search by Name or Admission Number</strong></label>
      <input 
        type="text" 
        id="searchMarksInput" 
        placeholder="Enter learner name or admission number"
        style="width: 100%; background-color: rgba(255, 255, 255, 0.8); border: 1px solid #ccc; padding: 6px; border-radius: 4px; color: #333;">
    </div>

    <!-- Filter by Grade -->
    <div class="form-group" style="flex: 1; min-width: 220px;">
      <label for="filterMarksGrade" style="font-weight: bold; color: #3498db;"><strong>Filter by Grade</strong></label>
      <select id="filterMarksGrade" 
        style="width: 100%; background-color: rgba(255, 255, 255, 0.8); border: 1px solid #ccc; padding: 6px; border-radius: 4px; color: #333;">
        <option value="">-- Select Grade --</option>
        <!-- Add Grade Options Dynamically -->
      </select>
    </div>

    <!-- Filter by Exam Period -->
    <div class="form-group" style="flex: 1; min-width: 220px;">
      <label for="marksExamPeriodSelect" style="font-weight: bold; color: #3498db;"><strong>Filter by Exam Period</strong></label>
      <select id="marksExamPeriodSelect" 
        style="width: 100%; background-color: rgba(255, 255, 255, 0.8); border: 1px solid #ccc; padding: 6px; border-radius: 4px; color: #333;">
        <option value="">-- Select Exam Period --</option>
    <option value="2024, Term 1, Opener Exam">2024, Term 1, Opener Exam</option>
<option value="2024, Term 1, Midterm Exam">2024, Term 1, Midterm Exam</option>
<option value="2024, Term 1, End Term Exam">2024, Term 1, End Term Exam</option>
<option value="2024, Term 2, Opener Exam">2024, Term 2, Opener Exam</option>
<option value="2024, Term 2, Midterm Exam">2024, Term 2, Midterm Exam</option>
<option value="2024, Term 2, End Term Exam">2024, Term 2, End Term Exam</option>
<option value="2024, Term 3, Opener Exam">2024, Term 3, Opener Exam</option>
<option value="2024, Term 3, Midterm Exam">2024, Term 3, Midterm Exam</option>
<option value="2024, Term 3, End Term Exam">2024, Term 3, End Term Exam</option>

<option value="2025, Term 1, Opener Exam">2025, Term 1, Opener Exam</option>
<option value="2025, Term 1, Midterm Exam">2025, Term 1, Midterm Exam</option>
<option value="2025, Term 1, End Term Exam">2025, Term 1, End Term Exam</option>
<option value="2025, Term 2, Opener Exam">2025, Term 2, Opener Exam</option>
<option value="2025, Term 2, Midterm Exam">2025, Term 2, Midterm Exam</option>
<option value="2025, Term 2, End Term Exam">2025, Term 2, End Term Exam</option>
<option value="2025, Term 3, Opener Exam">2025, Term 3, Opener Exam</option>
<option value="2025, Term 3, Midterm Exam">2025, Term 3, Midterm Exam</option>
<option value="2025, Term 3, End Term Exam">2025, Term 3, End Term Exam</option>

<option value="2026, Term 1, Opener Exam">2026, Term 1, Opener Exam</option>
<option value="2026, Term 1, Midterm Exam">2026, Term 1, Midterm Exam</option>
<option value="2026, Term 1, End Term Exam">2026, Term 1, End Term Exam</option>
<option value="2026, Term 2, Opener Exam">2026, Term 2, Opener Exam</option>
<option value="2026, Term 2, Midterm Exam">2026, Term 2, Midterm Exam</option>
<option value="2026, Term 2, End Term Exam">2026, Term 2, End Term Exam</option>
<option value="2026, Term 3, Opener Exam">2026, Term 3, Opener Exam</option>
<option value="2026, Term 3, Midterm Exam">2026, Term 3, Midterm Exam</option>
<option value="2026, Term 3, End Term Exam">2026, Term 3, End Term Exam</option>

<option value="2027, Term 1, Opener Exam">2027, Term 1, Opener Exam</option>
<option value="2027, Term 1, Midterm Exam">2027, Term 1, Midterm Exam</option>
<option value="2027, Term 1, End Term Exam">2027, Term 1, End Term Exam</option>
<option value="2027, Term 2, Opener Exam">2027, Term 2, Opener Exam</option>
<option value="2027, Term 2, Midterm Exam">2027, Term 2, Midterm Exam</option>
<option value="2027, Term 2, End Term Exam">2027, Term 2, End Term Exam</option>
<option value="2027, Term 3, Opener Exam">2027, Term 3, Opener Exam</option>
<option value="2027, Term 3, Midterm Exam">2027, Term 3, Midterm Exam</option>
<option value="2027, Term 3, End Term Exam">2027, Term 3, End Term Exam</option>
<!-- 2028 -->
<option value="2028, Term 1, Opener Exam">2028, Term 1, Opener Exam</option>
<option value="2028, Term 1, Midterm Exam">2028, Term 1, Midterm Exam</option>
<option value="2028, Term 1, End Term Exam">2028, Term 1, End Term Exam</option>
<option value="2028, Term 2, Opener Exam">2028, Term 2, Opener Exam</option>
<option value="2028, Term 2, Midterm Exam">2028, Term 2, Midterm Exam</option>
<option value="2028, Term 2, End Term Exam">2028, Term 2, End Term Exam</option>
<option value="2028, Term 3, Opener Exam">2028, Term 3, Opener Exam</option>
<option value="2028, Term 3, Midterm Exam">2028, Term 3, Midterm Exam</option>
<option value="2028, Term 3, End Term Exam">2028, Term 3, End Term Exam</option>

<!-- 2029 -->
<option value="2029, Term 1, Opener Exam">2029, Term 1, Opener Exam</option>
<option value="2029, Term 1, Midterm Exam">2029, Term 1, Midterm Exam</option>
<option value="2029, Term 1, End Term Exam">2029, Term 1, End Term Exam</option>
<option value="2029, Term 2, Opener Exam">2029, Term 2, Opener Exam</option>
<option value="2029, Term 2, Midterm Exam">2029, Term 2, Midterm Exam</option>
<option value="2029, Term 2, End Term Exam">2029, Term 2, End Term Exam</option>
<option value="2029, Term 3, Opener Exam">2029, Term 3, Opener Exam</option>
<option value="2029, Term 3, Midterm Exam">2029, Term 3, Midterm Exam</option>
<option value="2029, Term 3, End Term Exam">2029, Term 3, End Term Exam</option>

<!-- 2030 -->
<option value="2030, Term 1, Opener Exam">2030, Term 1, Opener Exam</option>
<option value="2030, Term 1, Midterm Exam">2030, Term 1, Midterm Exam</option>
<option value="2030, Term 1, End Term Exam">2030, Term 1, End Term Exam</option>
<option value="2030, Term 2, Opener Exam">2030, Term 2, Opener Exam</option>
<option value="2030, Term 2, Midterm Exam">2030, Term 2, Midterm Exam</option>
<option value="2030, Term 2, End Term Exam">2030, Term 2, End Term Exam</option>
<option value="2030, Term 3, Opener Exam">2030, Term 3, Opener Exam</option>
<option value="2030, Term 3, Midterm Exam">2030, Term 3, Midterm Exam</option>
<option value="2030, Term 3, End Term Exam">2030, Term 3, End Term Exam</option>

<!-- 2031 -->
<option value="2031, Term 1, Opener Exam">2031, Term 1, Opener Exam</option>
<option value="2031, Term 1, Midterm Exam">2031, Term 1, Midterm Exam</option>
<option value="2031, Term 1, End Term Exam">2031, Term 1, End Term Exam</option>
<option value="2031, Term 2, Opener Exam">2031, Term 2, Opener Exam</option>
<option value="2031, Term 2, Midterm Exam">2031, Term 2, Midterm Exam</option>
<option value="2031, Term 2, End Term Exam">2031, Term 2, End Term Exam</option>
<option value="2031, Term 3, Opener Exam">2031, Term 3, Opener Exam</option>
<option value="2031, Term 3, Midterm Exam">2031, Term 3, Midterm Exam</option>
<option value="2031, Term 3, End Term Exam">2031, Term 3, End Term Exam</option>

<!-- 2032 -->
<option value="2032, Term 1, Opener Exam">2032, Term 1, Opener Exam</option>
<option value="2032, Term 1, Midterm Exam">2032, Term 1, Midterm Exam</option>
<option value="2032, Term 1, End Term Exam">2032, Term 1, End Term Exam</option>
<option value="2032, Term 2, Opener Exam">2032, Term 2, Opener Exam</option>
<option value="2032, Term 2, Midterm Exam">2032, Term 2, Midterm Exam</option>
<option value="2032, Term 2, End Term Exam">2032, Term 2, End Term Exam</option>
<option value="2032, Term 3, Opener Exam">2032, Term 3, Opener Exam</option>
<option value="2032, Term 3, Midterm Exam">2032, Term 3, Midterm Exam</option>
<option value="2032, Term 3, End Term Exam">2032, Term 3, End Term Exam</option>
<!-- 2033 -->
<option value="2033, Term 1, Opener Exam">2033, Term 1, Opener Exam</option>
<option value="2033, Term 1, Midterm Exam">2033, Term 1, Midterm Exam</option>
<option value="2033, Term 1, End Term Exam">2033, Term 1, End Term Exam</option>
<option value="2033, Term 2, Opener Exam">2033, Term 2, Opener Exam</option>
<option value="2033, Term 2, Midterm Exam">2033, Term 2, Midterm Exam</option>
<option value="2033, Term 2, End Term Exam">2033, Term 2, End Term Exam</option>
<option value="2033, Term 3, Opener Exam">2033, Term 3, Opener Exam</option>
<option value="2033, Term 3, Midterm Exam">2033, Term 3, Midterm Exam</option>
<option value="2033, Term 3, End Term Exam">2033, Term 3, End Term Exam</option>

<!-- 2034 -->
<option value="2034, Term 1, Opener Exam">2034, Term 1, Opener Exam</option>
<option value="2034, Term 1, Midterm Exam">2034, Term 1, Midterm Exam</option>
<option value="2034, Term 1, End Term Exam">2034, Term 1, End Term Exam</option>
<option value="2034, Term 2, Opener Exam">2034, Term 2, Opener Exam</option>
<option value="2034, Term 2, Midterm Exam">2034, Term 2, Midterm Exam</option>
<option value="2034, Term 2, End Term Exam">2034, Term 2, End Term Exam</option>
<option value="2034, Term 3, Opener Exam">2034, Term 3, Opener Exam</option>
<option value="2034, Term 3, Midterm Exam">2034, Term 3, Midterm Exam</option>
<option value="2034, Term 3, End Term Exam">2034, Term 3, End Term Exam</option>

<!-- 2035 -->
<option value="2035, Term 1, Opener Exam">2035, Term 1, Opener Exam</option>
<option value="2035, Term 1, Midterm Exam">2035, Term 1, Midterm Exam</option>
<option value="2035, Term 1, End Term Exam">2035, Term 1, End Term Exam</option>
<option value="2035, Term 2, Opener Exam">2035, Term 2, Opener Exam</option>
<option value="2035, Term 2, Midterm Exam">2035, Term 2, Midterm Exam</option>
<option value="2035, Term 2, End Term Exam">2035, Term 2, End Term Exam</option>
<option value="2035, Term 3, Opener Exam">2035, Term 3, Opener Exam</option>
<option value="2035, Term 3, Midterm Exam">2035, Term 3, Midterm Exam</option>
<option value="2035, Term 3, End Term Exam">2035, Term 3, End Term Exam</option>

<!-- 2036 -->
<option value="2036, Term 1, Opener Exam">2036, Term 1, Opener Exam</option>
<option value="2036, Term 1, Midterm Exam">2036, Term 1, Midterm Exam</option>
<option value="2036, Term 1, End Term Exam">2036, Term 1, End Term Exam</option>
<option value="2036, Term 2, Opener Exam">2036, Term 2, Opener Exam</option>
<option value="2036, Term 2, Midterm Exam">2036, Term 2, Midterm Exam</option>
<option value="2036, Term 2, End Term Exam">2036, Term 2, End Term Exam</option>
<option value="2036, Term 3, Opener Exam">2036, Term 3, Opener Exam</option>
<option value="2036, Term 3, Midterm Exam">2036, Term 3, Midterm Exam</option>
<option value="2036, Term 3, End Term Exam">2036, Term 3, End Term Exam</option>

<!-- 2037 -->
<option value="2037, Term 1, Opener Exam">2037, Term 1, Opener Exam</option>
<option value="2037, Term 1, Midterm Exam">2037, Term 1, Midterm Exam</option>
<option value="2037, Term 1, End Term Exam">2037, Term 1, End Term Exam</option>
<option value="2037, Term 2, Opener Exam">2037, Term 2, Opener Exam</option>
<option value="2037, Term 2, Midterm Exam">2037, Term 2, Midterm Exam</option>
<option value="2037, Term 2, End Term Exam">2037, Term 2, End Term Exam</option>
<option value="2037, Term 3, Opener Exam">2037, Term 3, Opener Exam</option>
<option value="2037, Term 3, Midterm Exam">2037, Term 3, Midterm Exam</option>
<option value="2037, Term 3, End Term Exam">2037, Term 3, End Term Exam</option>

<option value="2038, Term 1, Opener Exam">2038, Term 1, Opener Exam</option>
<option value="2038, Term 1, Midterm Exam">2038, Term 1, Midterm Exam</option>
<option value="2038, Term 1, End Term Exam">2038, Term 1, End Term Exam</option>
<option value="2038, Term 2, Opener Exam">2038, Term 2, Opener Exam</option>
<option value="2038, Term 2, Midterm Exam">2038, Term 2, Midterm Exam</option>
<option value="2038, Term 2, End Term Exam">2038, Term 2, End Term Exam</option>
<option value="2038, Term 3, Opener Exam">2038, Term 3, Opener Exam</option>
<option value="2038, Term 3, Midterm Exam">2038, Term 3, Midterm Exam</option>
<option value="2038, Term 3, End Term Exam">2038, Term 3, End Term Exam</option>


<option value="2039, Term 1, Opener Exam">2039, Term 1, Opener Exam</option>
<option value="2039, Term 1, Midterm Exam">2039, Term 1, Midterm Exam</option>
<option value="2039, Term 1, End Term Exam">2039, Term 1, End Term Exam</option>
<option value="2039, Term 2, Opener Exam">2039, Term 2, Opener Exam</option>
<option value="2039, Term 2, Midterm Exam">2039, Term 2, Midterm Exam</option>
<option value="2039, Term 2, End Term Exam">2039, Term 2, End Term Exam</option>
<option value="2039, Term 3, Opener Exam">2039, Term 3, Opener Exam</option>
<option value="2039, Term 3, Midterm Exam">2039, Term 3, Midterm Exam</option>
<option value="2039, Term 3, End Term Exam">2039, Term 3, End Term Exam</option>

<option value="2040, Term 1, Opener Exam">2040, Term 1, Opener Exam</option>
<option value="2040, Term 1, Midterm Exam">2040, Term 1, Midterm Exam</option>
<option value="2040, Term 1, End Term Exam">2040, Term 1, End Term Exam</option>
<option value="2040, Term 2, Opener Exam">2040, Term 2, Opener Exam</option>
<option value="2040, Term 2, Midterm Exam">2040, Term 2, Midterm Exam</option>
<option value="2040, Term 2, End Term Exam">2040, Term 2, End Term Exam</option>
<option value="2040, Term 3, Opener Exam">2040, Term 3, Opener Exam</option>
<option value="2040, Term 3, Midterm Exam">2040, Term 3, Midterm Exam</option>
<option value="2040, Term 3, End Term Exam">2040, Term 3, End Term Exam</option>

      </select>
    </div>

    <!-- Load Marks Button -->
    <div class="form-group" style="flex: 1; min-width: 220px;">
      <label>&nbsp;</label> <!-- Empty label for alignment -->
      <button id="loadMarksByPeriodBtn" class="print-button" style="width: 100%; padding: 10px; background-color: #1abc9c; border: 1px solid #16a085; border-radius: 4px; display: block; color: white;">
        <i class="fas fa-download"></i> Load Marks
      </button>
    </div>

    <!-- Print Marks Button -->
    <div class="form-group" style="flex: 1; min-width: 220px;">
      <label>&nbsp;</label> <!-- Empty label for alignment -->
      <button id="printFilteredMarksBtn" class="print-button" style="width: 100%; padding: 10px; background-color: #f39c12; border: 1px solid #e67e22; border-radius: 4px; display: block; color: white;">
        <i class="fas fa-print"></i> Print Merit List
      </button>
    </div>
  </div>
    <h2 style="background-color: rgba(255, 255, 255, 0.7); padding: 8px 16px; border-radius: 6px; display: inline-block; color: #2c3e50;">
      <span style="color: #e74c3c;">Rasm: Redefining Exam Management Through ICT!
Accuracy and Efficiency in Every Click.</span>
    </h2>

  <!-- Marks Table -->
  <table class="marks-table" style="margin-top: 20px;">
    <thead>
      <tr>
        <th>No.</th>
        <th>Name</th>
        <th>Grade</th>
        <th>Eng</th><th>Lev</th>
        <th>Math</th><th>Lev</th>
        <th>Pre-Tech</th><th>Lev</th>
        <th>Kiswa</th><th>Lev</th>
        <th>Scie</th><th>Lev</th>
        <th>Sst</th><th>Lev</th>
        <th>Agric</th><th>Lev</th>
        <th>Cre</th><th>Lev</th>
        <th>C/A</th><th>Lev</th>
        <th>Total Marks</th>
         <th>Points</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="marksList"></tbody>
    <tfoot>
      <tr id="totalsRow"></tr>
      <tr id="averagesRow"></tr>
    </tfoot>
  </table>
</div>


<!-- Performance Reports Section -->
<div id="performanceReportsSection" style="display: none;">

  <h2 style="background-color: #ffff00; padding: 8px 16px; border-radius: 6px; display: inline-block;">
    Exam Reports
  </h2>

  <!-- RASM Reminder FIRST -->
  <div style="
    background-color: #2ecc71;
    color: #5a5300;
    border: 1px solid #ffe58f;
    padding: 12px 16px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    margin: 20px 0;
    font-size: 16px;
  ">
    <i class="fas fa-bullhorn" style="color: #000; font-size: 24px; margin-right: 10px;"></i>
    <strong>RASM Reminder:</strong>&nbsp;Please select  grade,exam period and subject before generating any report ,Thankyou.
  </div>
<!-- Action Box Container -->
<div style="background-image: url('https://i.imgur.com/Ax6XN4u.jpeg'); background-size: cover; background-position: center; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); max-width: 400px; margin: auto;">

  <!-- Grade Selection Section -->
  <div style="margin-bottom: 16px;">
    <label for="reportGradeSelect" style="font-weight: bold; display: block; margin-bottom: 4px; color: white;">Select Grade:</label>
    <select id="reportGradeSelect" style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; width: 100%; background-color: rgba(255, 255, 255, 0.7);">
      <option value="">Select Grade</option>
    </select>
    <div style="font-size: 13px; color: #fff; margin-top: 4px;">
      <i class="fas fa-info-circle" style="margin-right: 5px; color: #333;"></i>
      Select the learner grade whose report you wish to generate.
    </div>
  </div>

  <!-- Exam Period Selection Section -->
  <div style="margin-bottom: 16px;">
    <label for="reportExamPeriodSelect" style="font-weight: bold; display: block; margin-bottom: 4px; color: white;">Select Exam Period:</label>
    <select id="reportExamPeriodSelect" style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; width: 100%; background-color: rgba(255, 255, 255, 0.7);">
      <option value="">-- Select Exam Period --</option>
  <option value="2024, Term 1, Opener Exam">2024, Term 1, Opener Exam</option>
<option value="2024, Term 1, Midterm Exam">2024, Term 1, Midterm Exam</option>
<option value="2024, Term 1, End Term Exam">2024, Term 1, End Term Exam</option>
<option value="2024, Term 2, Opener Exam">2024, Term 2, Opener Exam</option>
<option value="2024, Term 2, Midterm Exam">2024, Term 2, Midterm Exam</option>
<option value="2024, Term 2, End Term Exam">2024, Term 2, End Term Exam</option>
<option value="2024, Term 3, Opener Exam">2024, Term 3, Opener Exam</option>
<option value="2024, Term 3, Midterm Exam">2024, Term 3, Midterm Exam</option>
<option value="2024, Term 3, End Term Exam">2024, Term 3, End Term Exam</option>

<option value="2025, Term 1, Opener Exam">2025, Term 1, Opener Exam</option>
<option value="2025, Term 1, Midterm Exam">2025, Term 1, Midterm Exam</option>
<option value="2025, Term 1, End Term Exam">2025, Term 1, End Term Exam</option>
<option value="2025, Term 2, Opener Exam">2025, Term 2, Opener Exam</option>
<option value="2025, Term 2, Midterm Exam">2025, Term 2, Midterm Exam</option>
<option value="2025, Term 2, End Term Exam">2025, Term 2, End Term Exam</option>
<option value="2025, Term 3, Opener Exam">2025, Term 3, Opener Exam</option>
<option value="2025, Term 3, Midterm Exam">2025, Term 3, Midterm Exam</option>
<option value="2025, Term 3, End Term Exam">2025, Term 3, End Term Exam</option>

<option value="2026, Term 1, Opener Exam">2026, Term 1, Opener Exam</option>
<option value="2026, Term 1, Midterm Exam">2026, Term 1, Midterm Exam</option>
<option value="2026, Term 1, End Term Exam">2026, Term 1, End Term Exam</option>
<option value="2026, Term 2, Opener Exam">2026, Term 2, Opener Exam</option>
<option value="2026, Term 2, Midterm Exam">2026, Term 2, Midterm Exam</option>
<option value="2026, Term 2, End Term Exam">2026, Term 2, End Term Exam</option>
<option value="2026, Term 3, Opener Exam">2026, Term 3, Opener Exam</option>
<option value="2026, Term 3, Midterm Exam">2026, Term 3, Midterm Exam</option>
<option value="2026, Term 3, End Term Exam">2026, Term 3, End Term Exam</option>

<option value="2027, Term 1, Opener Exam">2027, Term 1, Opener Exam</option>
<option value="2027, Term 1, Midterm Exam">2027, Term 1, Midterm Exam</option>
<option value="2027, Term 1, End Term Exam">2027, Term 1, End Term Exam</option>
<option value="2027, Term 2, Opener Exam">2027, Term 2, Opener Exam</option>
<option value="2027, Term 2, Midterm Exam">2027, Term 2, Midterm Exam</option>
<option value="2027, Term 2, End Term Exam">2027, Term 2, End Term Exam</option>
<option value="2027, Term 3, Opener Exam">2027, Term 3, Opener Exam</option>
<option value="2027, Term 3, Midterm Exam">2027, Term 3, Midterm Exam</option>
<option value="2027, Term 3, End Term Exam">2027, Term 3, End Term Exam</option>
<!-- 2028 -->
<option value="2028, Term 1, Opener Exam">2028, Term 1, Opener Exam</option>
<option value="2028, Term 1, Midterm Exam">2028, Term 1, Midterm Exam</option>
<option value="2028, Term 1, End Term Exam">2028, Term 1, End Term Exam</option>
<option value="2028, Term 2, Opener Exam">2028, Term 2, Opener Exam</option>
<option value="2028, Term 2, Midterm Exam">2028, Term 2, Midterm Exam</option>
<option value="2028, Term 2, End Term Exam">2028, Term 2, End Term Exam</option>
<option value="2028, Term 3, Opener Exam">2028, Term 3, Opener Exam</option>
<option value="2028, Term 3, Midterm Exam">2028, Term 3, Midterm Exam</option>
<option value="2028, Term 3, End Term Exam">2028, Term 3, End Term Exam</option>

<!-- 2029 -->
<option value="2029, Term 1, Opener Exam">2029, Term 1, Opener Exam</option>
<option value="2029, Term 1, Midterm Exam">2029, Term 1, Midterm Exam</option>
<option value="2029, Term 1, End Term Exam">2029, Term 1, End Term Exam</option>
<option value="2029, Term 2, Opener Exam">2029, Term 2, Opener Exam</option>
<option value="2029, Term 2, Midterm Exam">2029, Term 2, Midterm Exam</option>
<option value="2029, Term 2, End Term Exam">2029, Term 2, End Term Exam</option>
<option value="2029, Term 3, Opener Exam">2029, Term 3, Opener Exam</option>
<option value="2029, Term 3, Midterm Exam">2029, Term 3, Midterm Exam</option>
<option value="2029, Term 3, End Term Exam">2029, Term 3, End Term Exam</option>

<!-- 2030 -->
<option value="2030, Term 1, Opener Exam">2030, Term 1, Opener Exam</option>
<option value="2030, Term 1, Midterm Exam">2030, Term 1, Midterm Exam</option>
<option value="2030, Term 1, End Term Exam">2030, Term 1, End Term Exam</option>
<option value="2030, Term 2, Opener Exam">2030, Term 2, Opener Exam</option>
<option value="2030, Term 2, Midterm Exam">2030, Term 2, Midterm Exam</option>
<option value="2030, Term 2, End Term Exam">2030, Term 2, End Term Exam</option>
<option value="2030, Term 3, Opener Exam">2030, Term 3, Opener Exam</option>
<option value="2030, Term 3, Midterm Exam">2030, Term 3, Midterm Exam</option>
<option value="2030, Term 3, End Term Exam">2030, Term 3, End Term Exam</option>

<!-- 2031 -->
<option value="2031, Term 1, Opener Exam">2031, Term 1, Opener Exam</option>
<option value="2031, Term 1, Midterm Exam">2031, Term 1, Midterm Exam</option>
<option value="2031, Term 1, End Term Exam">2031, Term 1, End Term Exam</option>
<option value="2031, Term 2, Opener Exam">2031, Term 2, Opener Exam</option>
<option value="2031, Term 2, Midterm Exam">2031, Term 2, Midterm Exam</option>
<option value="2031, Term 2, End Term Exam">2031, Term 2, End Term Exam</option>
<option value="2031, Term 3, Opener Exam">2031, Term 3, Opener Exam</option>
<option value="2031, Term 3, Midterm Exam">2031, Term 3, Midterm Exam</option>
<option value="2031, Term 3, End Term Exam">2031, Term 3, End Term Exam</option>

<!-- 2032 -->
<option value="2032, Term 1, Opener Exam">2032, Term 1, Opener Exam</option>
<option value="2032, Term 1, Midterm Exam">2032, Term 1, Midterm Exam</option>
<option value="2032, Term 1, End Term Exam">2032, Term 1, End Term Exam</option>
<option value="2032, Term 2, Opener Exam">2032, Term 2, Opener Exam</option>
<option value="2032, Term 2, Midterm Exam">2032, Term 2, Midterm Exam</option>
<option value="2032, Term 2, End Term Exam">2032, Term 2, End Term Exam</option>
<option value="2032, Term 3, Opener Exam">2032, Term 3, Opener Exam</option>
<option value="2032, Term 3, Midterm Exam">2032, Term 3, Midterm Exam</option>
<option value="2032, Term 3, End Term Exam">2032, Term 3, End Term Exam</option>
<!-- 2033 -->
<option value="2033, Term 1, Opener Exam">2033, Term 1, Opener Exam</option>
<option value="2033, Term 1, Midterm Exam">2033, Term 1, Midterm Exam</option>
<option value="2033, Term 1, End Term Exam">2033, Term 1, End Term Exam</option>
<option value="2033, Term 2, Opener Exam">2033, Term 2, Opener Exam</option>
<option value="2033, Term 2, Midterm Exam">2033, Term 2, Midterm Exam</option>
<option value="2033, Term 2, End Term Exam">2033, Term 2, End Term Exam</option>
<option value="2033, Term 3, Opener Exam">2033, Term 3, Opener Exam</option>
<option value="2033, Term 3, Midterm Exam">2033, Term 3, Midterm Exam</option>
<option value="2033, Term 3, End Term Exam">2033, Term 3, End Term Exam</option>

<!-- 2034 -->
<option value="2034, Term 1, Opener Exam">2034, Term 1, Opener Exam</option>
<option value="2034, Term 1, Midterm Exam">2034, Term 1, Midterm Exam</option>
<option value="2034, Term 1, End Term Exam">2034, Term 1, End Term Exam</option>
<option value="2034, Term 2, Opener Exam">2034, Term 2, Opener Exam</option>
<option value="2034, Term 2, Midterm Exam">2034, Term 2, Midterm Exam</option>
<option value="2034, Term 2, End Term Exam">2034, Term 2, End Term Exam</option>
<option value="2034, Term 3, Opener Exam">2034, Term 3, Opener Exam</option>
<option value="2034, Term 3, Midterm Exam">2034, Term 3, Midterm Exam</option>
<option value="2034, Term 3, End Term Exam">2034, Term 3, End Term Exam</option>

<!-- 2035 -->
<option value="2035, Term 1, Opener Exam">2035, Term 1, Opener Exam</option>
<option value="2035, Term 1, Midterm Exam">2035, Term 1, Midterm Exam</option>
<option value="2035, Term 1, End Term Exam">2035, Term 1, End Term Exam</option>
<option value="2035, Term 2, Opener Exam">2035, Term 2, Opener Exam</option>
<option value="2035, Term 2, Midterm Exam">2035, Term 2, Midterm Exam</option>
<option value="2035, Term 2, End Term Exam">2035, Term 2, End Term Exam</option>
<option value="2035, Term 3, Opener Exam">2035, Term 3, Opener Exam</option>
<option value="2035, Term 3, Midterm Exam">2035, Term 3, Midterm Exam</option>
<option value="2035, Term 3, End Term Exam">2035, Term 3, End Term Exam</option>

<!-- 2036 -->
<option value="2036, Term 1, Opener Exam">2036, Term 1, Opener Exam</option>
<option value="2036, Term 1, Midterm Exam">2036, Term 1, Midterm Exam</option>
<option value="2036, Term 1, End Term Exam">2036, Term 1, End Term Exam</option>
<option value="2036, Term 2, Opener Exam">2036, Term 2, Opener Exam</option>
<option value="2036, Term 2, Midterm Exam">2036, Term 2, Midterm Exam</option>
<option value="2036, Term 2, End Term Exam">2036, Term 2, End Term Exam</option>
<option value="2036, Term 3, Opener Exam">2036, Term 3, Opener Exam</option>
<option value="2036, Term 3, Midterm Exam">2036, Term 3, Midterm Exam</option>
<option value="2036, Term 3, End Term Exam">2036, Term 3, End Term Exam</option>

<!-- 2037 -->
<option value="2037, Term 1, Opener Exam">2037, Term 1, Opener Exam</option>
<option value="2037, Term 1, Midterm Exam">2037, Term 1, Midterm Exam</option>
<option value="2037, Term 1, End Term Exam">2037, Term 1, End Term Exam</option>
<option value="2037, Term 2, Opener Exam">2037, Term 2, Opener Exam</option>
<option value="2037, Term 2, Midterm Exam">2037, Term 2, Midterm Exam</option>
<option value="2037, Term 2, End Term Exam">2037, Term 2, End Term Exam</option>
<option value="2037, Term 3, Opener Exam">2037, Term 3, Opener Exam</option>
<option value="2037, Term 3, Midterm Exam">2037, Term 3, Midterm Exam</option>
<option value="2037, Term 3, End Term Exam">2037, Term 3, End Term Exam</option>

<option value="2038, Term 1, Opener Exam">2038, Term 1, Opener Exam</option>
<option value="2038, Term 1, Midterm Exam">2038, Term 1, Midterm Exam</option>
<option value="2038, Term 1, End Term Exam">2038, Term 1, End Term Exam</option>
<option value="2038, Term 2, Opener Exam">2038, Term 2, Opener Exam</option>
<option value="2038, Term 2, Midterm Exam">2038, Term 2, Midterm Exam</option>
<option value="2038, Term 2, End Term Exam">2038, Term 2, End Term Exam</option>
<option value="2038, Term 3, Opener Exam">2038, Term 3, Opener Exam</option>
<option value="2038, Term 3, Midterm Exam">2038, Term 3, Midterm Exam</option>
<option value="2038, Term 3, End Term Exam">2038, Term 3, End Term Exam</option>


<option value="2039, Term 1, Opener Exam">2039, Term 1, Opener Exam</option>
<option value="2039, Term 1, Midterm Exam">2039, Term 1, Midterm Exam</option>
<option value="2039, Term 1, End Term Exam">2039, Term 1, End Term Exam</option>
<option value="2039, Term 2, Opener Exam">2039, Term 2, Opener Exam</option>
<option value="2039, Term 2, Midterm Exam">2039, Term 2, Midterm Exam</option>
<option value="2039, Term 2, End Term Exam">2039, Term 2, End Term Exam</option>
<option value="2039, Term 3, Opener Exam">2039, Term 3, Opener Exam</option>
<option value="2039, Term 3, Midterm Exam">2039, Term 3, Midterm Exam</option>
<option value="2039, Term 3, End Term Exam">2039, Term 3, End Term Exam</option>

<option value="2040, Term 1, Opener Exam">2040, Term 1, Opener Exam</option>
<option value="2040, Term 1, Midterm Exam">2040, Term 1, Midterm Exam</option>
<option value="2040, Term 1, End Term Exam">2040, Term 1, End Term Exam</option>
<option value="2040, Term 2, Opener Exam">2040, Term 2, Opener Exam</option>
<option value="2040, Term 2, Midterm Exam">2040, Term 2, Midterm Exam</option>
<option value="2040, Term 2, End Term Exam">2040, Term 2, End Term Exam</option>
<option value="2040, Term 3, Opener Exam">2040, Term 3, Opener Exam</option>
<option value="2040, Term 3, Midterm Exam">2040, Term 3, Midterm Exam</option>
<option value="2040, Term 3, End Term Exam">2040, Term 3, End Term Exam</option>

    </select>
    <div style="font-size: 13px; color: #fff; margin-top: 4px;">
      <i class="fas fa-info-circle" style="margin-right: 5px; color: #333;"></i>
      Select the exam period for the report generation.
    </div>
  </div>

  <!-- Subject Selection Section -->
  <div style="margin-bottom: 16px;">
    <label for="rankingSubjectSelect" style="font-weight: bold; display: block; margin-bottom: 4px; color: white;">Select Subject:</label>
    <select id="rankingSubjectSelect" style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; width: 100%; background-color: rgba(255, 255, 255, 0.7);">
      <option value="">Select Subject</option>
      <option value="eng">English</option>
      <option value="math">Mathematics</option>
      <option value="preTech">Pre-Technical Studies</option>
      <option value="kiswahili">Kiswahili</option>
      <option value="science">Integrated Science</option>
      <option value="social">Social Studies</option>
      <option value="agriculture">Agriculture</option>
      <option value="cre">Religious Education</option>
      <option value="creativeArt">Creative Art</option>
    </select>
    <div style="font-size: 13px; color: #fff; margin-top: 4px;">
      <i class="fas fa-info-circle" style="margin-right: 5px; color: #333;"></i>
      Select the subject you want to analyze performance for.
    </div>
  </div>
  
</div> <!-- End of Action Box Container -->
    <h2 style="background-color: rgba(255, 255, 255, 0.7); padding: 8px 16px; border-radius: 6px; display: inline-block; color: #2c3e50;">
      <span style="color: #e74c3c;">Say No to Manual Grading!
Rasm Does It All ‚Äì One Click and You‚Äôre Done!.</span>
    </h2>
<!-- Button Container with Two Boxes -->
<div class="button-container" style="display: flex; gap: 20px; flex-wrap: wrap;">
  <!-- First Box with Background Image and Equal Height -->
  <div class="button-box" style="flex: 1; background-image: url('https://i.imgur.com/O65vJEI.jpeg'); background-size: cover; background-position: center; background-repeat: no-repeat; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); height: 100%; display: flex; flex-direction: column; justify-content: space-between; margin-bottom: 20px;">
    
   <button class="report-button red" id="subjectChampionsBtn">
  <i class="fas fa-trophy"></i> Subjects Champions
</button>

<button class="report-button blue" id="subjectPerformanceBtn">
  <i class="fas fa-chart-line"></i> Subject Performance
</button>

<button class="report-button green" id="genderPerformanceBtn">
  <i class="fas fa-venus-mars"></i> Gender Performance
</button>

<button class="report-button purple" id="levelSummaryBtn">
  <i class="fas fa-layer-group"></i> Subject Level Summary
</button>

<button class="report-button orange" id="combineMarksByGradeBtn">
  <i class="fas fa-object-group"></i> Combine Marks Per Grade
</button>

<button class="report-button teal" id="groupByPathwaysBtn">
  <i class="fas fa-project-diagram"></i> Group Learners Per Pathways
</button>

<button class="report-button green" id="generateAssessmentReportsBtn">
  <i class="fas fa-file-alt"></i> Generate Assessment Reports
</button>


  </div> <!-- End of First Button Box -->

  <!-- Second Box with Background Image and Equal Height -->
  <div class="button-box" style="flex: 1; background-image: url('https://i.imgur.com/EJoyk7N.jpeg'); background-size: cover; background-position: center; background-repeat: no-repeat; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); height: 100%; display: flex; flex-direction: column; justify-content: space-between; margin-bottom: 20px;">
    
   <button class="report-button gray" id="subjectRankingReportBtn">
  <i class="fas fa-list-ol"></i> Track Learner Progress
</button>

<button class="report-button gray" id="generateBlankMeritBtn">
  <i class="fas fa-file-alt"></i> Generate Blank Merit Lists
</button>

<button onclick="countMarksStatusPerGrade()" class="report-button">
  <i class="fas fa-file-alt"></i> Generate Marks Summary
</button>

<button class="print-button" id="generateSubjectRankBtn">
  <i class="fas fa-list-ol"></i> Generate Subject Tracker Analysis
</button>

<button id="printAssessmentReportBtn" class="print-button">
  <i class="fas fa-print"></i> Print Assessment Report
</button>

<button onclick="countMarksStatusPerGrade()" class="print-button">
  <i class="fas fa-eye"></i> View Summary by Grade & Period
</button>

<button id="showMarksStatusBtn">
  <i id="toggleIcon" class="fas fa-eye"></i>
  Show Marks Recording Status Per Grade
</button>


  </div> <!-- End of Second Button Box -->
</div> <!-- End of Button Container -->

<!-- Output Containers Outside the Button Box (Below the Second Box) -->
<div id="reportOutput" style="margin-top: 20px; max-width: 800px; margin-left: auto; margin-right: auto;"></div>
<div id="assessmentReportsContainer" style="margin-top: 30px; max-width: 800px; margin-left: auto; margin-right: auto;"></div>

<!-- Teacher Modal -->
<div id="teacherModal" class="modal">
  <div class="modal-content" style="background-image: url('https://i.imgur.com/WKwJ73A.jpeg'); background-size: cover; background-position: center; border-radius: 10px; padding: 20px; color: #fff;">
    <span class="close-btn" onclick="closeTeacherModal()" style="color: #fff; font-size: 1.5rem; cursor: pointer; font-weight: bold;">&times;</span>
    
    <h3 class="modal-title" style="font-size: 24px; font-weight: 600; margin-bottom: 20px;">
      Enter Term and Subject Teacher Details
    </h3>

    <form id="teacherForm" style="display: flex; flex-direction: column; gap: 15px;">
      <!-- Dynamic Inputs -->
      <div id="teacherInputs" class="dynamic-inputs" style="display: flex; flex-direction: column; gap: 10px;">
        <!-- Dynamic fields will be injected here -->
      </div>

      <!-- Static Fields -->
      <div class="form-section" style="display: flex; flex-direction: column; gap: 15px; background-color: rgba(0, 0, 0, 0.6); padding: 20px; border-radius: 10px;">
        <div class="form-group">
          <label for="year" style="font-size: 1rem; font-weight: 500;">Year</label>
          <input type="number" id="year" required style="padding: 10px; border-radius: 6px; border: none; font-size: 1rem;">
        </div>
        <div class="form-group">
          <label for="term" style="font-size: 1rem; font-weight: 500;">Term</label>
          <input type="text" id="term" required style="padding: 10px; border-radius: 6px; border: none; font-size: 1rem;">
        </div>
        <div class="form-group">
          <label for="closingDate" style="font-size: 1rem; font-weight: 500;">Closing Date</label>
          <input type="date" id="closingDate" required style="padding: 10px; border-radius: 6px; border: none; font-size: 1rem;">
        </div>
        <div class="form-group">
          <label for="openingDate" style="font-size: 1rem; font-weight: 500;">Opening Date</label>
          <input type="date" id="openingDate" required style="padding: 10px; border-radius: 6px; border: none; font-size: 1rem;">
        </div>
        <div class="form-group">
          <label for="classTeacherSignature" style="font-size: 1rem; font-weight: 500;">Class Teacher Signature</label>
          <input type="text" id="classTeacherSignature" placeholder="Type your name or signature" required style="padding: 10px; border-radius: 6px; border: none; font-size: 1rem;">
        </div>
        <div class="form-group">
          <label for="principalSignature" style="font-size: 1rem; font-weight: 500;">Principal Signature</label>
          <input type="text" id="principalSignature" placeholder="Type your name or signature" required style="padding: 10px; border-radius: 6px; border: none; font-size: 1rem;">
        </div>
      </div>

      <!-- Submit Button -->
      <div class="form-actions" style="display: flex; justify-content: flex-end; margin-top: 20px;">
        <button type="submit" class="print-button" style="padding: 12px 25px; background-color: #f39c12; color: #fff; border: none; border-radius: 5px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background-color 0.3s;">
          <i class="fas fa-arrow-right"></i> Continue to Reports
        </button>
      </div>
    </form>
  </div>
</div>

<div id="marksStatusSummary" style="margin-top: 20px; padding: 10px; background: #eef; border-radius: 6px;"></div>

<div id="customPrompt" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; max-width:300px; text-align:center;">
    <h3 style="margin-top:0;">Combine Marks by Grade</h3>
    <input type="text" id="gradeInput" placeholder="e.g., 7 or 8" style="padding:8px; width:90%; margin-bottom:15px; border:1px solid #ccc; border-radius:5px;" />
    <div>
      <button id="confirmGradeBtn" style="padding:8px 15px; margin-right:10px; border:none; background:#3498db; color:white; border-radius:5px;">Combine</button>
      <button id="cancelGradeBtn" style="padding:8px 15px; border:none; background:#e74c3c; color:white; border-radius:5px;">Cancel</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<div id="spinner" style="
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
  background: rgba(255,255,255,0.9);
  padding: 30px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
">
  <i class="fas fa-spinner fa-spin fa-3x" style="color:#007bff;"></i>
  <p style="margin-top: 10px;">Generating Report...</p>
</div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";
  const firebaseConfig = {
    apiKey: "AIzaSyDhTehL7VIaGG-bC2n1AFILZeJJ-drmSC0",
    authDomain: "rasm-school-management.firebaseapp.com",
    databaseURL: "https://rasm-school-management-default-rtdb.firebaseio.com",
    projectId: "rasm-school-management",
    storageBucket: "rasm-school-management.appspot.com",
    messagingSenderId: "1015313561987",
    appId: "1:1015313561987:web:4329664df844c17ae59eb6",
    measurementId: "G-MHKTNPG712"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const learnersRef = ref(database, "learners");


document.getElementById('registerButton').addEventListener('click', () => {
    const name = document.getElementById('name').value.trim();
    const gender = document.getElementById('gender').value;
    const grade = document.getElementById('grade').value;
    const age = document.getElementById('age').value;
    const parentName = document.getElementById('parentName').value.trim();
    const parentPhone = document.getElementById('parentPhone').value.trim();
    const birthCert = document.getElementById('birthCert').value.trim();
    const admissionNo = document.getElementById('admissionNo').value.trim();
    const photo = document.getElementById('photo').files[0];

    if (!name || !gender || !grade) {
        Swal.fire({
            icon: 'error',
            title: 'Missing Required Fields',
            text: 'Please fill in Name, Gender, and Grade before submitting.',
            confirmButtonColor: '#d33'
        });
        return;
    }

    const learnerData = {
        name,
        gender,
        grade,
        ...(age && { age }),
        ...(parentName && { parentName }),
        ...(parentPhone && { parentPhone }),
        ...(birthCert && { birthCert }),
        ...(admissionNo && { admissionNo }),
        ...(photo && { photo: URL.createObjectURL(photo) }),
    };

    const newLearnerRef = push(learnersRef);
    set(newLearnerRef, learnerData)
        .then(() => {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Learner registered successfully.',
                confirmButtonColor: '#28a745'
            });
            document.getElementById('learnerForm').reset();
        })
        .catch(err => {
            console.error("Error adding learner: ", err);
            Swal.fire({
                icon: 'error',
                title: 'Registration Failed',
                text: 'There was an issue saving learner data. Please try again.',
                confirmButtonColor: '#d33'
            });
        });
});
const tableBody = document.getElementById('learnersList');
const filterGradeSelect = document.getElementById('filterGrade');
const spinnerContainer = document.getElementById('spinnerContainer');
const spinnerCountdown = document.getElementById('spinnerCountdown');
const loadMoreBtn = document.getElementById('loadMoreBtn');
const scrollContainer = document.getElementById('tableScrollContainer');

// ================= GLOBAL STATE =================
let allLearners = [];
let currentIndex = 0;
const pageSize = 250;
let countdownInterval;
let seconds = 0;
let filteredLearners = [];


// ================= LOADING SPINNER =================
function showLoadingSpinner() {
  if (spinnerContainer) {
    spinnerContainer.style.display = 'block';
    seconds = 0;
    spinnerCountdown.innerHTML = `Loading... <span>${seconds}</span>s`;

    countdownInterval = setInterval(() => {
      seconds++;
      spinnerCountdown.innerHTML = `Loading... <span>${seconds}</span>s`;
    }, 1000);
  }
  tableBody.innerHTML = "";
}

function hideLoadingSpinner() {
  if (spinnerContainer) {
    spinnerContainer.style.display = 'none';
    clearInterval(countdownInterval);
  }
}

// ================= LOAD LEARNERS (FAST) =================
async function loadLearners() {
  try {
    showLoadingSpinner();

    const snapshot = await get(learnersRef);
    allLearners = [];
    const grades = new Set();

    snapshot.forEach(childSnapshot => {
      const data = childSnapshot.val();
      if (data?.name && data?.grade) {
        allLearners.push({
          key: childSnapshot.key,
          ...data
        });
        grades.add(data.grade);
      }
    });

    // Populate grade filter + attach filter logic
if (filterGradeSelect) {
  filterGradeSelect.innerHTML = `<option value="">Filter by Grade</option>`;

  grades.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    filterGradeSelect.appendChild(opt);
  });

  // üî• Filter by grade & reset numbering
  filterGradeSelect.onchange = () => {
    const selectedGrade = filterGradeSelect.value;

    if (!selectedGrade) {
      filteredLearners = [...allLearners]; // show all learners
    } else {
      filteredLearners = allLearners.filter(
        learner => learner.grade === selectedGrade
      );
    }

    // üîÅ Reset pagination & numbering
    currentIndex = 0;
    tableBody.innerHTML = "";
    loadNextBatch();
  };
}

// ===== Default load (no filter) =====
filteredLearners = [...allLearners];
currentIndex = 0;
tableBody.innerHTML = "";
loadNextBatch();
hideLoadingSpinner();

} catch (err) {
  console.error("Error loading learners:", err);
  showToast("Failed to load learners", "error");
  hideLoadingSpinner();
}
}

loadLearners(); // ‚úÖ INITIAL FETCH


filteredLearners = [...allLearners];
currentIndex = 0;
tableBody.innerHTML = "";
loadNextBatch();


// ================= PAGINATION =================
function loadNextBatch() {
  const fragment = document.createDocumentFragment();
  const end = Math.min(currentIndex + pageSize, filteredLearners.length);

  let index = currentIndex + 1; // pagination-safe, filter-safe


  for (let i = currentIndex; i < end; i++) {
    const data = filteredLearners[i];

    const learnerKey = data.key;

    const newRow = document.createElement("tr");
    newRow.dataset.key = learnerKey;
    newRow.dataset.grade = data.grade || "";

    newRow.innerHTML = `
      <td>${index++}</td>
      <td><img src="${data.photo || 'default.png'}" width="60" height="60" class="learner-photo"></td>
      <td contenteditable="true" class="editable">${data.name || ''}</td>
      <td contenteditable="true" class="editable">${data.gender || ''}</td>
      <td contenteditable="true" class="editable">${data.grade || ''}</td>
      <td contenteditable="true" class="editable">${data.age || ''}</td>
      <td contenteditable="true" class="editable">${data.parentName || ''}</td>
      <td contenteditable="true" class="editable">${data.parentPhone || ''}</td>
      <td contenteditable="true" class="editable">${data.birthCert || ''}</td>
      <td contenteditable="true" class="editable">${data.admissionNo || ''}</td>
      <td><button class="edit-photo-btn btn-blue"><i class="fas fa-camera"></i></button></td>
      <td><button class="delete-btn btn-red"><i class="fas fa-trash-alt"></i></button></td>
    `;

    // ================= INLINE EDIT =================
    const fields = ['name','gender','grade','age','parentName','parentPhone','birthCert','admissionNo'];
    newRow.querySelectorAll(".editable").forEach((cell, idx) => {
      const field = fields[idx];

      cell.addEventListener("blur", () => {
        if (!isAdminLoggedIn) {
          showToast("Admins only", "error");
          cell.textContent = data[field] || '';
          return;
        }

        const value = cell.textContent.trim();
        if (!value) {
          cell.textContent = data[field] || '';
          showToast("Field cannot be empty", "error");
          return;
        }

        set(ref(database, `learners/${learnerKey}`), { ...data, [field]: value })
          .then(() => showToast(`${field} updated`, "success"))
          .catch(() => showToast("Update failed", "error"));
      });
    });

    // ================= PHOTO UPDATE =================
    newRow.querySelector(".edit-photo-btn").onclick = () => {
      if (!isAdminLoggedIn) return Swal.fire("Access Denied","Admins only","error");

      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.click();

      input.onchange = () => {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
          set(ref(database, `learners/${learnerKey}`), { ...data, photo: reader.result })
            .then(() => {
              newRow.querySelector("img").src = reader.result;
              showToast("Photo updated", "success");
            });
        };
        reader.readAsDataURL(file);
      };
    };

    // ================= DELETE (PERMANENT FIX) =================
    newRow.querySelector(".delete-btn").onclick = () => {
      if (!isAdminLoggedIn) {
        Swal.fire("Access Denied","Admins only","error");
        return;
      }

      Swal.fire({
        title: "Confirm Deletion",
        text: "This learner will be permanently removed",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33"
      }).then(result => {
        if (!result.isConfirmed) return;

        // üî• Remove locally first
        newRow.remove();
        allLearners = allLearners.filter(l => l.key !== learnerKey);

        currentIndex = 0;
        tableBody.innerHTML = "";
        loadNextBatch();

        // üî• Remove from Firebase
        remove(ref(database, `learners/${learnerKey}`))
          .then(() => Swal.fire("Deleted","Learner permanently removed","success"))
          .catch(() => Swal.fire("Error","Delete failed","error"));
      });
    };

    fragment.appendChild(newRow);
  }

  tableBody.appendChild(fragment);
  currentIndex = end;
}

// ================= INFINITE SCROLL =================
if (scrollContainer) {
  scrollContainer.addEventListener("scroll", () => {
    if (
      scrollContainer.scrollTop + scrollContainer.clientHeight >=
      scrollContainer.scrollHeight - 10 &&
      currentIndex < allLearners.length
    ) {
      loadNextBatch();
    }
  });
}


// üîç Search filter
document.getElementById("searchInput").addEventListener("input", function () {
  const query = this.value.toLowerCase();
  const rows = document.querySelectorAll("#learnersList tr");

  rows.forEach(row => {
    const name = row.cells[2].textContent.toLowerCase();
    const admissionNo = row.cells[9].textContent.toLowerCase();
    row.style.display = name.includes(query) || admissionNo.includes(query) ? "" : "none";
  });
});



printButton.addEventListener('click', () => {
    const schoolName = "NACHU JUNIOR SCHOOL ";
    const year = "202...";
    const term = " ....";

    // Get the selected grade for filtering
    const selectedGrade = filterGrade.value;

    // Get the learners data for printing, only filtered by grade
    const learners = [];
    tableBody.querySelectorAll('tr').forEach((row, index) => {
        const grade = row.getAttribute('data-grade');
        if (selectedGrade === "" || grade === selectedGrade) {
            const learner = {
                name: row.cells[2].textContent,
                gender: row.cells[3].textContent,
                grade: row.cells[4].textContent,
                age: row.cells[5].textContent,
                parentName: row.cells[6].textContent,
                phone: row.cells[7].textContent,
                birthCertificateNo: row.cells[8].textContent,
                admissionNumber: row.cells[9].textContent,
                photo: "placeholder.jpg" // Placeholder image path
            };
            learners.push(learner);
        }
    });

    printRegisteredLearners(schoolName, year, term, learners);
});

function printRegisteredLearners(schoolName, year, term, learners) {
    const logoUrl ="https://i.imgur.com/VSAh48K.jpeg"; // Logo URL
    const today = new Date();
    const printDate = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;

    const tableHtml = `
        <table class="learners-table">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Photo</th>
                    <th>Name</th>
                    <th>Gender</th>
                    <th>Grade</th>
                    <th>Age</th>
                    <th>Parent Name</th>
                    <th>Parent Phone No</th>
                    <th>Birth Certificate No</th>
                    <th>Admission Number</th>
                </tr>
            </thead>
            <tbody>
                ${learners.map((learner, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td><img src="${learner.photo}" alt="Photo" width="50" height="50"></td>
                        <td>${learner.name}</td>
                        <td>${learner.gender}</td>
                        <td>${learner.grade}</td>
                        <td>${learner.age}</td>
                        <td>${learner.parentName}</td>
                        <td>${learner.phone}</td>
                        <td>${learner.birthCertificateNo}</td>
                        <td>${learner.admissionNumber}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Registered Learners</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header-info { text-align: left; margin-bottom: 20px; font-weight: bold; }
                    .learners-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    .learners-table th, .learners-table td { border: 1px solid black; padding: 8px; text-align: center; }
                    img { max-width: 100px; }
                    .stamp {
                        border: 2px solid blue;
                        color: blue;
                        text-align: center;
                        width: 200px;
                        height: 70px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 30px auto;
                        font-weight: bold;
                        font-size: 14px;
                    }
                    @media screen {
                        .stamp { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header-info">
                    <img src="${logoUrl}" alt="Logo" width="50" height="50">
                    <p>School: ${schoolName}</p>
                    <p>Year: ${year} | Term: ${term}</p>
                </div>
                ${tableHtml}
                <div class="stamp">
                    Nachu Junior School<br>
                    P.O. Box 561-00902, Kikuyu<br>
                    ICT Department<br>
                    Date: ${printDate}
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}


document.addEventListener('DOMContentLoaded', () => {
    // Get modal and close button
    const modal = document.getElementById('learnerModal');
    const closeBtn = document.querySelector('.close');

    // Function to open the modal with learner details
    function openModal(learnerData) {
        const modalDetails = document.getElementById('modalDetails');
        modalDetails.innerHTML = `
            <p><strong>Name:</strong> ${learnerData.name}</p>
            <p><strong>Gender:</strong> ${learnerData.gender}</p>
            <p><strong>Grade:</strong> ${learnerData.grade}</p>
            <p><strong>Age:</strong> ${learnerData.age}</p>
            <p><strong>Parent Name:</strong> ${learnerData.parentName}</p>
            <p><strong>Parent Phone:</strong> ${learnerData.parentPhone}</p>
            <p><strong>Birth Certificate No:</strong> ${learnerData.birthCert}</p>
            <p><strong>Admission No:</strong> ${learnerData.admissionNo}</p>
            <p><strong>Photo:</strong> <img src="${learnerData.photo}" alt="Learner Photo" style="max-width: 150px; border-radius: 50%;"></p>
        `;
        modal.style.display = "block"; // Show the modal
    }

    // Function to close the modal
    closeBtn.addEventListener('click', () => {
        modal.style.display = "none"; // Hide the modal
    });

    // Click event for learner names
    tableBody.addEventListener('click', (e) => {
        if (e.target && e.target.nodeName === "TD" && e.target.cellIndex === 2) {
            const row = e.target.closest('tr');
            const learnerKey = row.getAttribute('data-key');
            
            // Fetch learner data from Firebase or get the data from `row`
            const learnerData = {
                name: row.cells[2].textContent,
                gender: row.cells[3].textContent,
                grade: row.cells[4].textContent,
                age: row.cells[5].textContent,
                parentName: row.cells[6].textContent,
                parentPhone: row.cells[7].textContent,
                birthCert: row.cells[8].textContent,
                admissionNo: row.cells[9].textContent,
                photo: row.cells[1].querySelector('img').src // Assuming photo is in the second cell
            };
            
            openModal(learnerData); // Open the modal and pass learner data
        }
    });

    // Close the modal when clicking outside the modal content
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
});
// Populate grades and learner dropdowns
onValue(learnersRef, (snapshot) => {
    const gradeSelect = document.getElementById("gradeSelect");
    const learnerSelect = document.getElementById("learnerSelect");
    const grades = new Set();

    learnerSelect.innerHTML = `<option value="">Select Learner</option>`;
    gradeSelect.innerHTML = `<option value="">Select Grade</option>`;

    snapshot.forEach(childSnapshot => {
        const learner = childSnapshot.val();
        grades.add(learner.grade);
    });

    grades.forEach(grade => {
        const option = document.createElement("option");
        option.value = grade;
        option.textContent = grade;
        gradeSelect.appendChild(option);
    });
});

// Update learners dropdown based on selected grade
document.getElementById('filterGrade').addEventListener('change', () => {
  const selectedGrade = document.getElementById('filterGrade').value;
  const allRows = document.querySelectorAll('#learnersList tr');

  allRows.forEach(row => {
    const rowGrade = row.getAttribute('data-grade');
    if (selectedGrade === "" || rowGrade === selectedGrade) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
});

  // Attach event listeners
  document.getElementById("gradeSelect").addEventListener("change", filterLearnersByGradeOnly);
  document.getElementById("examPeriod").addEventListener("change", filterLearnersByGradeOnly);

  // Filter learners by grade + disable or mark learners who already have marks for selected exam period
  function filterLearnersByGradeOnly() {
    const selectedGrade = document.getElementById("gradeSelect").value;
    const examPeriod = document.getElementById("examPeriod").value;
    const learnerSelect = document.getElementById("learnerSelect");
    learnerSelect.innerHTML = "<option value=''>Select Learner</option>";

    if (!selectedGrade || !examPeriod) return;

    db.collection("learners")
      .where("grade", "==", selectedGrade)
      .get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const learner = doc.data();
          const option = document.createElement("option");
          option.value = learner.name;
          option.text = learner.name;

          // Check if marks exist for this learner & exam period
          db.collection("marks")
            .where("name", "==", learner.name)
            .where("examPeriod", "==", examPeriod)
            .get()
            .then((marksSnapshot) => {
              if (!marksSnapshot.empty) {
                option.disabled = true;
                option.text = `? ${learner.name}`;
                option.style.color = "red";
              }
              learnerSelect.appendChild(option);
            });
        });
      })
      .catch((error) => {
        console.error("Error fetching learners: ", error);
      });
  }

// üîÅ Restore selected grade and exam period on page load
window.addEventListener("DOMContentLoaded", () => {
  const savedGrade = localStorage.getItem("selectedGrade");
  const savedExamPeriod = localStorage.getItem("selectedExamPeriod");

  if (savedGrade) document.getElementById("gradeSelect").value = savedGrade;
  if (savedExamPeriod) document.getElementById("examPeriod").value = savedExamPeriod;
});

// üíæ Save marks handler
document.getElementById("saveMarksButton").addEventListener("click", () => {
  const learnerKey = document.getElementById("learnerSelect").value;
  if (!learnerKey) {
    Swal.fire({
      icon: 'error',
      title: 'Missing Learner',
      text: 'Please select a learner before saving marks.',
      confirmButtonColor: '#d33'
    });
    return;
  }

  const examPeriod = document.getElementById("examPeriod").value;
  if (!examPeriod) {
    Swal.fire({
      icon: 'error',
      title: 'Missing Exam Period',
      text: 'Please select the exam period before saving marks.',
      confirmButtonColor: '#d33'
    });
    return;
  }

  const grade = document.getElementById("gradeSelect").value;
  if (!grade) {
    Swal.fire({
      icon: 'error',
      title: 'Missing Grade',
      text: 'Please select a grade before saving marks.',
      confirmButtonColor: '#d33'
    });
    return;
  }

  // ‚úÖ Save selected grade and exam period to localStorage
  localStorage.setItem("selectedExamPeriod", examPeriod);
  localStorage.setItem("selectedGrade", grade);

  // üßÆ Collect marks and calculate levels
  const marksData = {
    eng: document.getElementById("eng").value,
    engLev: getLevel(document.getElementById("eng").value),
    math: document.getElementById("math").value,
    mathLev: getLevel(document.getElementById("math").value),
    preTech: document.getElementById("preTech").value,
    preTechLev: getLevel(document.getElementById("preTech").value),
    kiswahili: document.getElementById("kiswahili").value,
    kiswahiliLev: getLevel(document.getElementById("kiswahili").value),
    science: document.getElementById("science").value,
    scienceLev: getLevel(document.getElementById("science").value),
    social: document.getElementById("social").value,
    socialLev: getLevel(document.getElementById("social").value),
    agriculture: document.getElementById("agriculture").value,
    agricultureLev: getLevel(document.getElementById("agriculture").value),
    cre: document.getElementById("cre").value,
    creLev: getLevel(document.getElementById("cre").value),
    creativeArt: document.getElementById("creativeArt").value,
    creativeArtLev: getLevel(document.getElementById("creativeArt").value)
  };

  // ‚úÖ Save to Firebase
  set(ref(database, `learners/${learnerKey}/marks/${examPeriod}`), marksData)
    .then(() => {
      Swal.fire({
        icon: 'success',
        title: 'Marks Saved',
        text: `Marks recorded successfully for ${examPeriod}!`,
        confirmButtonColor: '#28a745'
      });
     document.getElementById("marksForm").reset();

// ‚úÖ Restore selected grade and examPeriod after reset
document.getElementById("gradeSelect").value = localStorage.getItem("selectedGrade") || "";
document.getElementById("examPeriod").value = localStorage.getItem("selectedExamPeriod") || "";

filterLearnersWithMarks(); // Refresh learner list

    })
    .catch(err => {
      console.error("Error saving marks: ", err);
      Swal.fire({
        icon: 'error',
        title: 'Save Failed',
        text: 'Failed to record marks. Please try again.',
        confirmButtonColor: '#d33'
      });
    });
});


function filterLearnersWithMarks() {
  const gradeSelect = document.getElementById("gradeSelect");
  const learnerSelect = document.getElementById("learnerSelect");
  const selectedGrade = gradeSelect.value;
  const examPeriod = document.getElementById("examPeriod").value;
  const marksCountBadge = document.getElementById("marksCountBadge");

  learnerSelect.innerHTML = `<option value="">Select Learner</option>`; // Clear dropdown
  marksCountBadge.innerHTML = ""; // Clear badge initially

  if (!selectedGrade || !examPeriod) return;

  let totalLearners = 0;
  let learnersWithMarks = 0;

  onValue(learnersRef, (snapshot) => {
    learnerSelect.innerHTML = `<option value="">Select Learner</option>`; // Clear again inside

    snapshot.forEach(childSnapshot => {
      const learner = childSnapshot.val();

      if (learner.grade === selectedGrade) {
        totalLearners++;

        const option = document.createElement("option");
        option.value = childSnapshot.key;
        option.textContent = `${learner.name} (${learner.admissionNo})`;

        // Check if marks exist for this learner and period
        if (childSnapshot.child(`marks/${examPeriod}`).exists()) {
          option.disabled = true;
          option.textContent = ` ${learner.name} (${learner.admissionNo})`;
          option.style.color = "red";
          learnersWithMarks++;
        }

        learnerSelect.appendChild(option);
      }
    });

    // Update count badge after processing
    if (totalLearners > 0) {
      marksCountBadge.innerHTML = ` ${learnersWithMarks} / ${totalLearners} learners recorded for ${examPeriod}`;
    } else {
      marksCountBadge.innerHTML = `No learners found in ${selectedGrade}`;
    }
  });
}



// Update learner dropdown on grade change
document.getElementById("gradeSelect").addEventListener("change", filterLearnersWithMarks);

// Populate the initial dropdown
filterLearnersWithMarks();
const marksTableBody = document.getElementById("marksList");
const filterMarksGrade = document.getElementById("filterMarksGrade");
const marksExamPeriodSelect = document.getElementById("marksExamPeriodSelect");

function calculateTotalLevel(marks) {
  return (
    parseInt(getLevel(marks.eng)) +
    parseInt(getLevel(marks.math)) +
    parseInt(getLevel(marks.preTech)) +
    parseInt(getLevel(marks.kiswahili)) +
    parseInt(getLevel(marks.science)) +
    parseInt(getLevel(marks.social)) +
    parseInt(getLevel(marks.agriculture)) +
    parseInt(getLevel(marks.cre)) +
    parseInt(getLevel(marks.creativeArt))
  );
}
function loadMarksFromFirebase() {
  const examPeriod = marksExamPeriodSelect.value;
  const selectedGrade = filterMarksGrade.value;
  const spinner = document.getElementById("marksSpinner");

  if (!examPeriod || !selectedGrade) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select both grade and exam period to load marks.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  if (spinner) spinner.style.display = "block";
  marksTableBody.innerHTML = "";

  let noMarksFound = true; // Flag to check if no marks are found

  onValue(learnersRef, (snapshot) => {
    marksTableBody.innerHTML = "";
    const grades = new Set();

    let sums = {
      eng: 0, math: 0, preTech: 0, kiswahili: 0,
      science: 0, social: 0, agriculture: 0,
      cre: 0, creativeArt: 0, totalMarks: 0, totalLevel: 0
    };

    const learnersArray = [];

    snapshot.forEach(childSnapshot => {
      const data = childSnapshot.val();
      const marksData = data.marks || {};
      const marks = marksData[examPeriod] || null;

      if (data.grade) grades.add(data.grade);

      if (marks && data.grade === selectedGrade) {
        noMarksFound = false; // Marks found, set the flag to false

        const rowTotal =
          (parseFloat(marks.eng) || 0) +
          (parseFloat(marks.math) || 0) +
          (parseFloat(marks.preTech) || 0) +
          (parseFloat(marks.kiswahili) || 0) +
          (parseFloat(marks.science) || 0) +
          (parseFloat(marks.social) || 0) +
          (parseFloat(marks.agriculture) || 0) +
          (parseFloat(marks.cre) || 0) +
          (parseFloat(marks.creativeArt) || 0);

        learnersArray.push({
          key: childSnapshot.key,
          data,
          marks,
          rowTotal
        });
      }
    });

    learnersArray.sort((a, b) => b.rowTotal - a.rowTotal);

    learnersArray.forEach((learner, index) => {
      const { data, marks, rowTotal } = learner;
      const rowLevelTotal = calculateTotalLevel(marks);

      sums.eng += (parseFloat(marks.eng) || 0);
      sums.math += (parseFloat(marks.math) || 0);
      sums.preTech += (parseFloat(marks.preTech) || 0);
      sums.kiswahili += (parseFloat(marks.kiswahili) || 0);
      sums.science += (parseFloat(marks.science) || 0);
      sums.social += (parseFloat(marks.social) || 0);
      sums.agriculture += (parseFloat(marks.agriculture) || 0);
      sums.cre += (parseFloat(marks.cre) || 0);
      sums.creativeArt += (parseFloat(marks.creativeArt) || 0);
      sums.totalMarks += rowTotal;
      sums.totalLevel += rowLevelTotal;

      const row = document.createElement("tr");
      row.setAttribute("data-grade", data.grade);
      row.setAttribute("data-exam-period", examPeriod);
      row.setAttribute("data-key", learner.key);

      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${data.name}</td>
        <td>${data.grade}</td>
        <td data-editable="true">${marks.eng || ''}</td><td>${marks.engLev || ''}</td>
        <td data-editable="true">${marks.math || ''}</td><td>${marks.mathLev || ''}</td>
        <td data-editable="true">${marks.preTech || ''}</td><td>${marks.preTechLev || ''}</td>
        <td data-editable="true">${marks.kiswahili || ''}</td><td>${marks.kiswahiliLev || ''}</td>
        <td data-editable="true">${marks.science || ''}</td><td>${marks.scienceLev || ''}</td>
        <td data-editable="true">${marks.social || ''}</td><td>${marks.socialLev || ''}</td>
        <td data-editable="true">${marks.agriculture || ''}</td><td>${marks.agricultureLev || ''}</td>
        <td data-editable="true">${marks.cre || ''}</td><td>${marks.creLev || ''}</td>
        <td data-editable="true">${marks.creativeArt || ''}</td><td>${marks.creativeArtLev || ''}</td>
        <td><strong>${rowTotal}</strong></td>
        <td><strong>${rowLevelTotal}</strong></td>
        <td>
          <button class="deleteMarksBtn" data-key="${learner.key}" data-exam="${examPeriod}">
            <i class="fas fa-trash-alt"></i> Delete Marks
          </button>
        </td>
      `;

      marksTableBody.appendChild(row);
    });

    if (isAdminLoggedIn) enableMarksEditing();

    populateGradeSelectors(grades);
    updateTotalsAndAverages(sums, learnersArray.length);

    // Check if no marks found
    if (noMarksFound) {
      Swal.fire({
        icon: 'info',
        title: 'No Marks Found',
        text: `No marks found for ${selectedGrade} in ${examPeriod}. Please ensure that marks have been recorded.`,
        confirmButtonColor: '#d33'
      });
    }

    if (spinner) spinner.style.display = "none";
  });
}


document.getElementById("loadMarksByPeriodBtn").addEventListener("click", loadMarksFromFirebase);

function loadAllGrades() {
  const grades = new Set();
  onValue(learnersRef, (snapshot) => {
    snapshot.forEach(childSnapshot => {
      const data = childSnapshot.val();
      if (data.grade) grades.add(data.grade);
    });
    populateGradeSelectors(grades);
  });
}

window.addEventListener("DOMContentLoaded", loadAllGrades);

function populateGradeSelectors(grades) {
  const selectors = [
    document.getElementById("filterMarksGrade"),
    document.getElementById("reportGradeSelect")
  ];
  selectors.forEach(select => {
    if (select) {
      select.innerHTML = `<option value="">Select Grade</option>`;
      grades.forEach(grade => {
        const option = document.createElement("option");
        option.value = grade;
        option.textContent = grade;
        select.appendChild(option);
      });
    }
  });
}

// Get the level based on the score
function getLevel(score) {
  if (score >= 90) return 8;
  if (score >= 75) return 7;
  if (score >= 58) return 6;
  if (score >= 41) return 5;
  if (score >= 31) return 4;
  if (score >= 21) return 3;
  if (score >= 11) return 2;
  return 1;
}

// Update totals and averages for the filtered data
function updateTotalsAndAverages(sums, count) {
  const divisor = count > 0 ? count : 1;

  // Update totals row including total levels
  document.getElementById("totalsRow").innerHTML = `
    <td colspan="3"><strong>Totals</strong></td>
    <td>${sums.eng}</td><td></td>
    <td>${sums.math}</td><td></td>
    <td>${sums.preTech}</td><td></td>
    <td>${sums.kiswahili}</td><td></td>
    <td>${sums.science}</td><td></td>
    <td>${sums.social}</td><td></td>
    <td>${sums.agriculture}</td><td></td>
    <td>${sums.cre}</td><td></td>
    <td>${sums.creativeArt}</td><td></td>
    <td><strong>${sums.totalMarks}</strong></td>
    <td><strong>${sums.totalLevel}</strong></td> <!-- Add totalLevel here -->
    <td></td>
  `;

  // Update averages row including average of levels
  document.getElementById("averagesRow").innerHTML = `
    <td colspan="3"><strong>Averages</strong></td>
    <td>${(sums.eng / divisor).toFixed(2)}</td><td></td>
    <td>${(sums.math / divisor).toFixed(2)}</td><td></td>
    <td>${(sums.preTech / divisor).toFixed(2)}</td><td></td>
    <td>${(sums.kiswahili / divisor).toFixed(2)}</td><td></td>
    <td>${(sums.science / divisor).toFixed(2)}</td><td></td>
    <td>${(sums.social / divisor).toFixed(2)}</td><td></td>
    <td>${(sums.agriculture / divisor).toFixed(2)}</td><td></td>
    <td>${(sums.cre / divisor).toFixed(2)}</td><td></td>
    <td>${(sums.creativeArt / divisor).toFixed(2)}</td><td></td>
    <td><strong>${(sums.totalMarks / divisor).toFixed(2)}</strong></td>
    <td><strong>${(sums.totalLevel / divisor).toFixed(2)}</strong></td> <!-- Add average level here -->
    <td></td>
  `;
}

// Grade filter listener to recalculate on selection
filterMarksGrade.addEventListener("change", () => {
  const selectedGrade = filterMarksGrade.value;
  const rows = marksTableBody.querySelectorAll("tr");

  let sums = {
    eng: 0, math: 0, preTech: 0, kiswahili: 0,
    science: 0, social: 0, agriculture: 0, cre: 0, creativeArt: 0, totalMarks: 0, totalLevel: 0
  };
  let filteredCount = 0;

  rows.forEach(row => {
    const rowGrade = row.getAttribute("data-grade");
    const visible = selectedGrade === "" || rowGrade === selectedGrade;
    row.style.display = visible ? "" : "none";

    if (visible) {
      const cells = row.querySelectorAll("td");
      sums.eng += parseFloat(cells[3].textContent) || 0;
      sums.math += parseFloat(cells[5].textContent) || 0;
      sums.preTech += parseFloat(cells[7].textContent) || 0;
      sums.kiswahili += parseFloat(cells[9].textContent) || 0;
      sums.science += parseFloat(cells[11].textContent) || 0;
      sums.social += parseFloat(cells[13].textContent) || 0;
      sums.agriculture += parseFloat(cells[15].textContent) || 0;
      sums.cre += parseFloat(cells[17].textContent) || 0;
      sums.creativeArt += parseFloat(cells[19].textContent) || 0;
      sums.totalMarks += parseFloat(cells[21].textContent) || 0;

      // Calculate levels for each subject and accumulate them
      sums.totalLevel += getLevel(parseFloat(cells[3].textContent) || 0); // English level
      sums.totalLevel += getLevel(parseFloat(cells[5].textContent) || 0); // Math level
      sums.totalLevel += getLevel(parseFloat(cells[7].textContent) || 0); // PreTech level
      sums.totalLevel += getLevel(parseFloat(cells[9].textContent) || 0); // Kiswahili level
      sums.totalLevel += getLevel(parseFloat(cells[11].textContent) || 0); // Science level
      sums.totalLevel += getLevel(parseFloat(cells[13].textContent) || 0); // Social level
      sums.totalLevel += getLevel(parseFloat(cells[15].textContent) || 0); // Agriculture level
      sums.totalLevel += getLevel(parseFloat(cells[17].textContent) || 0); // CRE level
      sums.totalLevel += getLevel(parseFloat(cells[19].textContent) || 0); // CreativeArt level

      filteredCount++;
    }
  });

  // Update totals and averages with the filtered data
  updateTotalsAndAverages(sums, filteredCount);
});



document.addEventListener("click", function (e) {
  if (e.target.classList.contains("deleteMarksBtn")) {
    if (!isAdminLoggedIn) {
      Swal.fire({
        icon: "error",
        title: "Access Denied",
        text: "Only admins can delete learner marks.",
        confirmButtonColor: "#d33"
      });
      return;
    }

    const button = e.target;
    const learnerKey = button.getAttribute("data-key");
    const examPeriod = button.getAttribute("data-exam");

    if (!learnerKey || !examPeriod) {
      console.warn("Missing learner key or exam period.");
      return;
    }

    Swal.fire({
      title: "Are you sure?",
      text: "You want to delete this learner's marks for this exam?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, delete it!"
    }).then((result) => {
      if (result.isConfirmed) {
        const learnerMarksRef = ref(database, `learners/${learnerKey}/marks/${examPeriod}`);

        set(learnerMarksRef, null)
          .then(() => {
            Swal.fire({
              toast: true,
              position: 'top-end',
              icon: 'success',
              title: "Marks deleted successfully!",
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true
            });
            loadMarksFromFirebase(); // Refresh table
          })
          .catch(err => {
            console.error("Error deleting marks: ", err);
            Swal.fire({
              toast: true,
              position: 'top-end',
              icon: 'error',
              title: "Failed to delete marks.",
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true
            });
          });
      }
    });
  }
});

// Subject Champions button event ‚Äî optionally toast if no selection
document.getElementById("subjectChampionsBtn").addEventListener("click", () => {
  const grade = document.getElementById("reportGradeSelect").value;
  const examPeriod = document.getElementById("reportExamPeriodSelect").value;

  if (!grade || !examPeriod) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select both grade and exam period first.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  generateSubjectChampionsReport(grade, examPeriod);
});
document.getElementById("subjectPerformanceBtn").addEventListener("click", () => {
    const grade = document.getElementById("reportGradeSelect").value;
    const examPeriod = document.getElementById("reportExamPeriodSelect").value;
    generateSubjectPerformance(grade, examPeriod);
});

document.getElementById("genderPerformanceBtn").addEventListener("click", () => {
    const grade = document.getElementById("reportGradeSelect").value;
    const examPeriod = document.getElementById("reportExamPeriodSelect").value;
    generateGenderPerformance(grade, examPeriod);
});

document.getElementById("levelSummaryBtn").addEventListener("click", () => {
    const grade = document.getElementById("reportGradeSelect").value;
    const examPeriod = document.getElementById("reportExamPeriodSelect").value;
    generateLevelSummary(grade, examPeriod);
});
function generateSubjectChampionsReport(selectedGrade, selectedExamPeriod) {
    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];

    const subjectKeys = [
        'eng', 'math', 'preTech',
        'kiswahili', 'science', 'social',
        'agriculture', 'cre', 'creativeArt'
    ];

    const champions = {};
    subjects.forEach(subject => {
        champions[subject] = { name: 'N/A', score: -1 };
    });

    const marksTableBody = document.getElementById("marksList");

    marksTableBody.querySelectorAll("tr").forEach(row => {
        const grade = row.getAttribute("data-grade");
        const examPeriod = row.getAttribute("data-exam-period");

        if (selectedGrade && grade !== selectedGrade) return;
        if (selectedExamPeriod && examPeriod !== selectedExamPeriod) return;

        const learnerName = row.cells[1].textContent;

        subjectKeys.forEach((key, i) => {
            const score = parseFloat(row.cells[3 + i * 2].textContent);
            if (!isNaN(score) && score > champions[subjects[i]].score) {
                champions[subjects[i]] = { name: learnerName, score };
            }
        });
    });

    function getLevel(score) {
        if (score >= 90) return "EE 1";
        if (score >= 75) return "EE 2";
        if (score >= 58) return "ME 1";
        if (score >= 41) return "ME 2";
        if (score >= 31) return "AE 1";
        if (score >= 21) return "AE 2";
        if (score >= 11) return "BE 1";
        return "BE 2";
    }

    function getPoints(level) {
        switch (level) {
            case "EE 1": return 8;
            case "EE 2": return 7;
            case "ME 1": return 6;
            case "ME 2": return 5;
            case "AE 1": return 4;
            case "AE 2": return 3;
            case "BE 1": return 2;
            case "BE 2": return 1;
            default: return 0;
        }
    }

    const sortedChampions = Object.entries(champions)
        .map(([subject, data]) => ({ subject, ...data }))
        .sort((a, b) => b.score - a.score);

    const top3 = sortedChampions.slice(0, 3);
    const medals = ['ü•á', 'ü•à', 'ü•â'];
    const year = new Date().getFullYear();
    const today = new Date();
    const printDate = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;

    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/VSAh48K.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL SUBJECT CHAMPIONS REPORT</h2>
            <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p style="margin: 5px 0;">Phone: +254-700-123456</p>
            <p style="margin: 5px 0;">School Motto: "My Talent My Passion"</p>
            <p style="margin: 5px 0;">Year: ${year}</p>
            <p style="margin: 5px 0;">Grade: ${selectedGrade || 'All Grades'}</p>
            <p style="margin: 5px 0;">Exam Period: ${selectedExamPeriod || 'All Periods'}</p>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px; background-color: white; color: black; font-size: 16px;">
            <thead>
                <tr style="background: #f2f2f2;">
                    <th style="border: 2px solid black; padding: 10px;">No.</th>
                    <th style="border: 2px solid black; padding: 10px;">Subject</th>
                    <th style="border: 2px solid black; padding: 10px;">Champion</th>
                    <th style="border: 2px solid black; padding: 10px;">Score</th>
                    <th style="border: 2px solid black; padding: 10px;">Performance Level</th>
                    <th style="border: 2px solid black; padding: 10px;">Points</th>
                </tr>
            </thead>
            <tbody>`;

    let count = 1;
    sortedChampions.forEach(({ subject, name, score }, index) => {
        const level = getLevel(score);
        const points = getPoints(level);
        const isTop = index < 3;
        const medal = isTop ? medals[index] + ' üéâ' : '‚ú®';
        const rowStyle = isTop ? 'background: #FFD700; font-weight: bold;' : '';
        html += `<tr style="${rowStyle}">
            <td style="border: 2px solid black; padding: 10px;">${count++}</td>
            <td style="border: 2px solid black; padding: 10px;">${subject}</td>
            <td style="border: 2px solid black; padding: 10px;">${medal} ${name}</td>
            <td style="border: 2px solid black; padding: 10px;">${score >= 0 ? score : 'N/A'}</td>
            <td style="border: 2px solid black; padding: 10px;">${level}</td>
            <td style="border: 2px solid black; padding: 10px;">${points}</td>
        </tr>`;
    });

    html += `</tbody></table>`;

    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = html;


    // üåÄ Create animated style (once)
    if (!document.getElementById("celebrationStyles")) {
        const style = document.createElement("style");
        style.id = "celebrationStyles";
        style.textContent = `
            @keyframes floatEffect {
                0% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
                100% { opacity: 0; transform: translateY(-100px) scale(1.5) rotate(720deg); }
            }
            @keyframes fadeZoomIn {
                from { transform: scale(0.5); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }

    // üéá Floating emoji celebration
    function launchCelebration() {
        const emojis = ['‚ú®', 'üéâ', 'ü•á', 'ü•à', 'ü•â', 'üåü', 'üî•', 'üí´'];
        for (let i = 0; i < 60; i++) {
            const span = document.createElement('span');
            span.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            span.style.position = 'fixed';
            span.style.zIndex = 9999;
            span.style.fontSize = `${Math.random() * 20 + 20}px`;
            span.style.left = `${Math.random() * 100}vw`;
            span.style.top = `${Math.random() * 100}vh`;
            span.style.color = `hsl(${Math.random() * 360}, 100%, 60%)`;
            span.style.pointerEvents = 'none';
            span.style.animation = 'floatEffect 3s ease-out forwards';
            document.body.appendChild(span);
            setTimeout(() => span.remove(), 10000);
        }
    }

    // üèÜ Pop-up champion names
    function showChampionNamesPopup() {
        const popup = document.createElement("div");
        popup.style.position = "fixed";
        popup.style.top = "50%";
        popup.style.left = "50%";
        popup.style.transform = "translate(-50%, -50%)";
        popup.style.zIndex = 10000;
        popup.style.background = "linear-gradient(to right, #fff8dc, #ffe680)";
        popup.style.border = "4px solid gold";
        popup.style.padding = "25px";
        popup.style.borderRadius = "20px";
        popup.style.fontSize = "22px";
        popup.style.fontWeight = "bold";
        popup.style.boxShadow = "0 0 25px gold";
        popup.style.textAlign = "center";
        popup.style.animation = "fadeZoomIn 1s ease, fadeOut 1s ease 9s";
        popup.style.transition = "all 0.5s ease";

        let content = `<div>üèÜ Subject Champions üèÜ<br><br>`;
        sortedChampions.forEach(champ => {
            content += `üéñÔ∏è <strong>${champ.subject}</strong>: ${champ.name}<br>`;
        });
        content += `</div>`;
        popup.innerHTML = content;

        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 10000);
    }

    // üöÄ Trigger visuals
    launchCelebration();
    showChampionNamesPopup();

    // üñ®Ô∏è Print button
    let printButton = document.getElementById("printSubjectChampionsBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printSubjectChampionsBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Subject Champions Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            table, th, td { border: 2px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; font-weight: bold; }
                            img { max-width: 100px; }
                            .stamp {
                                border: 2px solid blue;
                                color: blue;
                                text-align: center;
                                width: 200px;
                                height: 70px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 30px auto;
                                font-weight: bold;
                                font-size: 14px;
                            }
                            @media screen {
                                .stamp { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                        <div class="stamp">
                            Nachu Junior School<br>
                            P.O. Box 561-00902, Kikuyu<br>
                            Exam Department<br>
                            Date: ${printDate}
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}



function generateLevelSummary(selectedGrade, selectedExamPeriod) {
    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];

    const subjectKeys = [
        'engLev', 'mathLev', 'preTechLev',
        'kiswahiliLev', 'scienceLev', 'socialLev',
        'agricultureLev', 'creLev', 'creativeArtLev'
    ];

    const levels = ['8', '7', '6', '5', '4', '3', '2', '1'];
    const summary = {};
    const topPerformers = {};

    subjects.forEach(subject => {
        summary[subject] = {};
        levels.forEach(level => summary[subject][level] = 0);
        topPerformers[subject] = null;
    });

    const marksTableBody = document.getElementById("marksList");
    marksTableBody.querySelectorAll("tr").forEach(row => {
        const rowGrade = row.getAttribute("data-grade");
        const rowPeriod = row.getAttribute("data-exam-period");

        if (selectedGrade && rowGrade !== selectedGrade) return;
        if (selectedExamPeriod && rowPeriod !== selectedExamPeriod) return;

        const learnerName = row.cells[1].textContent;

        subjectKeys.forEach((key, i) => {
            const level = row.querySelector(`td:nth-child(${4 + i * 2 + 1})`)?.textContent;
            if (levels.includes(level)) {
                summary[subjects[i]][level]++;
                // Track top performer as first 8 or 7 found
                if (!topPerformers[subjects[i]] && (level === '8' || level === '7')) {
                    topPerformers[subjects[i]] = learnerName;
                }
            }
        });
    });

    const year = new Date().getFullYear();
    const today = new Date();
    const printDate = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;

    let html = `
        <div class="header" style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/VSAh48K.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px;">
            <h2>NACHU JUNIOR SCHOOL SUBJECT LEVEL SUMMARY REPORT</h2>
            <p>Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p>Phone: +254-700-123456</p>
            <p>School Motto: "My Talent My Passion"</p>
            <p>Year: ${year}</p>
            <p>Grade: ${selectedGrade || 'All Grades'}</p>
            <p>Exam Period: ${selectedExamPeriod || 'All Periods'}</p>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px; background: white; color: black; font-size: 16px;">
            <thead>
                <tr style="background: #f2f2f2;">
                    <th style="border: 2px solid black; padding: 10px;">Subject</th>`;

    levels.forEach(level => {
        html += `<th style="border: 2px solid black; padding: 10px;">${level}</th>`;
    });

    html += `</tr></thead><tbody>`;

    subjects.forEach(subject => {
        html += `<tr>
            <td style="border: 2px solid black; padding: 10px;">${subject}</td>`;
        levels.forEach(level => {
            html += `<td style="border: 2px solid black; padding: 10px;">${summary[subject][level]}</td>`;
        });
        html += `</tr>`;
    });

    html += `</tbody></table>
        <div class="stamp print-only" style="margin-top:40px;">
            Nachu Junior School<br>
            P.O. Box 561-00902, Kikuyu<br>
            Exam Department<br>
            Date: ${printDate}
        </div>`;

    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = html;

    // Celebration Styles
    if (!document.getElementById("levelSummaryStyles")) {
        const style = document.createElement("style");
        style.id = "levelSummaryStyles";
        style.textContent = `
            @keyframes floatUp {
                0% { transform: translateY(0) scale(1); opacity: 1; }
                100% { transform: translateY(-150px) scale(1.5); opacity: 0; }
            }
            @keyframes fadeZoom {
                from { transform: scale(0.5); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            @keyframes fadeAway {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }

    // Floating emoji
    function floatCelebration() {
        const emojis = ['üéá', 'üéâ', 'üéä', 'üèÜ', 'üåü', 'ü•á', '‚ú®', 'üí´'];
        for (let i = 0; i < 60; i++) {
            const span = document.createElement('span');
            span.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            span.style.position = 'fixed';
            span.style.left = `${Math.random() * 100}vw`;
            span.style.top = `${Math.random() * 100}vh`;
            span.style.fontSize = `${20 + Math.random() * 20}px`;
            span.style.color = `hsl(${Math.random() * 360}, 100%, 60%)`;
            span.style.zIndex = 9999;
            span.style.pointerEvents = 'none';
            span.style.animation = 'floatUp 3s ease-out forwards';
            document.body.appendChild(span);
            setTimeout(() => span.remove(), 10000);
        }
    }

    // Popup with top level learners
    function showTopPopup() {
        const popup = document.createElement("div");
        popup.style.position = "fixed";
        popup.style.top = "50%";
        popup.style.left = "50%";
        popup.style.transform = "translate(-50%, -50%)";
        popup.style.background = "linear-gradient(to right, #fff8dc, #ffe680)";
        popup.style.border = "4px solid gold";
        popup.style.padding = "25px";
        popup.style.borderRadius = "20px";
        popup.style.fontSize = "22px";
        popup.style.fontWeight = "bold";
        popup.style.zIndex = 10000;
        popup.style.boxShadow = "0 0 25px gold";
        popup.style.animation = "fadeZoom 1s ease, fadeAway 1s ease 9s";
        popup.innerHTML = `<div>üåü Top Level Performers üåü<br><br>` +
            subjects.map(sub => `üèÖ <strong>${sub}</strong>: ${topPerformers[sub] || 'None'}`).join("<br>") +
            `</div>`;

        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 10000);
    }

    floatCelebration();
    showTopPopup();

    // Print button
    let printButton = document.getElementById("printLevelSummaryBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printLevelSummaryBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Subject Level Summary Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom:20px; }
                            table, th, td { border: 2px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; font-weight: bold; }
                            img { max-width: 100px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .stamp {
                                border: 2px solid blue;
                                color: blue;
                                width: 200px;
                                height: 70px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 10px auto;
                                text-align: center;
                                font-weight: bold;
                                font-size: 14px;
                            }
                            @media screen {
                                .stamp { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}


function showSubjectRanking(selectedGrade, selectedExamPeriod) {
    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];

    const rankings = {};
    subjects.forEach(subject => rankings[subject] = []);

    const marksTableBody = document.getElementById("marksList");

    marksTableBody.querySelectorAll("tr").forEach(row => {
        const rowGrade = row.getAttribute("data-grade");
        const rowPeriod = row.getAttribute("data-exam-period");

        if (selectedGrade && rowGrade !== selectedGrade) return;
        if (selectedExamPeriod && rowPeriod !== selectedExamPeriod) return;

        const learnerName = row.cells[1].textContent;

        subjects.forEach((subject, i) => {
            const score = parseFloat(row.cells[3 + i * 2].textContent);
            if (!isNaN(score)) {
                rankings[subject].push({ name: learnerName, score });
            }
        });
    });

    for (const subject in rankings) {
        rankings[subject].sort((a, b) => b.score - a.score);
    }

    function getPerformanceLevel(score) {
        if (score >= 90) return "EE 1";
        if (score >= 75) return "EE 2";
        if (score >= 58) return "ME 1";
        if (score >= 41) return "ME 2";
        if (score >= 31) return "AE 1";
        if (score >= 21) return "AE 2";
        if (score >= 11) return "BE 1";
        return "BE 2";
    }

    function getPoints(level) {
        switch (level) {
            case "EE 1": return 8;
            case "EE 2": return 7;
            case "ME 1": return 6;
            case "ME 2": return 5;
            case "AE 1": return 4;
            case "AE 2": return 3;
            case "BE 1": return 2;
            case "BE 2": return 1;
            default: return 0;
        }
    }

    const today = new Date();
    const printDate = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;

    let rankingsHtml = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin-bottom: 5px;">Subject Rankings</h2>
            <p style="margin: 0;">Grade: ${selectedGrade || 'All Grades'}</p>
            <p style="margin: 0;">Exam Period: ${selectedExamPeriod || 'All Periods'}</p>
        </div>
    `;

    for (const subject in rankings) {
        rankingsHtml += `
            <h4>${subject}</h4>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background: #f2f2f2;">
                        <th style="border: 1px solid black; padding: 8px;">Rank</th>
                        <th style="border: 1px solid black; padding: 8px;">Name</th>
                        <th style="border: 1px solid black; padding: 8px;">Score</th>
                        <th style="border: 1px solid black; padding: 8px;">Performance Level</th>
                        <th style="border: 1px solid black; padding: 8px;">Points</th>
                    </tr>
                </thead>
                <tbody>
        `;

        rankings[subject].forEach((entry, index) => {
            const level = getPerformanceLevel(entry.score);
            const points = getPoints(level);
            rankingsHtml += `
                <tr>
                    <td style="border: 1px solid black; padding: 8px;">${index + 1}</td>
                    <td style="border: 1px solid black; padding: 8px;">${entry.name}</td>
                    <td style="border: 1px solid black; padding: 8px;">${entry.score}</td>
                    <td style="border: 1px solid black; padding: 8px;">${level}</td>
                    <td style="border: 1px solid black; padding: 8px;">${points}</td>
                </tr>
            `;
        });

        rankingsHtml += `</tbody></table>`;
    }

    rankingsHtml += `
        <div class="stamp print-only" style="margin-top: 40px;">
            Nachu Junior School<br>
            P.O. Box 561-00902, Kikuyu<br>
            Exam Department<br>
            Date: ${printDate}
        </div>
    `;

    const reportDiv = document.getElementById("report");
    reportDiv.innerHTML = rankingsHtml;

    // Celebration popup + emojis
    const styleId = "rankingCelebrationStyle";
    if (!document.getElementById(styleId)) {
        const style = document.createElement("style");
        style.id = styleId;
        style.textContent = `
            @keyframes floatUpRank {
                0% { transform: translateY(0); }
                100% { transform: translateY(-120px); opacity: 0; }
            }
            @keyframes zoomInFade {
                from { transform: scale(0.5); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    function showFloatingEmojis() {
        const emojis = ['üéâ', 'üèÖ', 'ü•á', '‚ú®', 'üåü', 'üéä', 'üèÜ', 'ü•à', 'ü•â'];
        for (let i = 0; i < 50; i++) {
            const e = document.createElement("span");
            e.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            const size = 20 + Math.random() * 20;
            e.style = `
                position:fixed;left:${Math.random() * 100}vw;top:${Math.random() * 100}vh;
                font-size:${size}px;z-index:9999;pointer-events:none;
                color:hsl(${Math.random() * 360},100%,70%);
                animation:floatUpRank 3s ease-out forwards;
            `;
            document.body.appendChild(e);
            setTimeout(() => e.remove(), 5000);
        }
    }

    async function showTop5Popups() {
        for (const subject in rankings) {
            const top5 = rankings[subject].slice(0, 5);
            if (!top5.length) continue;
            const popup = document.createElement("div");
            popup.style = `
                position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
                background:linear-gradient(to right,#fff8dc,#ffe680);
                border:4px solid gold;padding:20px 30px;border-radius:20px;
                font:bold 18px sans-serif;text-align:left;box-shadow:0 0 25px gold;
                animation:zoomInFade 1s ease, fadeOut 1s ease 9s;
                z-index:10000;
            `;
            popup.innerHTML = `<div>üéØ <strong>Top 5 in ${subject}</strong><br><br>${
                top5.map((entry, i) =>
                    `${i + 1}. <strong>${entry.name}</strong> - ${entry.score} (${getPerformanceLevel(entry.score)})`
                ).join("<br>")
            }</div>`;
            document.body.appendChild(popup);
            showFloatingEmojis();
            await new Promise(resolve => setTimeout(() => {
                popup.remove();
                resolve();
            }, 10000));
        }
    }

    showTop5Popups();

    // Print button
    let printButton = document.getElementById("printRankingBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printRankingBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Rankings';
        reportDiv.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Subject Rankings</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            table, th, td { border: 2px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; font-weight: bold; }
                            h2, h4, p { margin: 5px 0; }
                            .stamp {
                                border: 2px solid blue;
                                color: blue;
                                width: 200px;
                                height: 70px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 10px auto;
                                text-align: center;
                                font-weight: bold;
                                font-size: 14px;
                            }
                            @media screen {
                                .stamp { display: none; }
                            }
                        </style>
                    </head>
                    <body>${reportDiv.innerHTML}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}

function generateSubjectPerformance(selectedGrade, selectedExamPeriod) {
    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];
    const subjectKeys = [
        'eng', 'math', 'preTech',
        'kiswahili', 'science', 'social',
        'agriculture', 'cre', 'creativeArt'
    ];
    const subjectScores = {};
    const marks = document.getElementById("marksList");

    marks.querySelectorAll("tr").forEach(row => {
        const g = row.getAttribute("data-grade");
        const p = row.getAttribute("data-exam-period");
        if (selectedGrade && g !== selectedGrade) return;
        if (selectedExamPeriod && p !== selectedExamPeriod) return;

        subjectKeys.forEach((key, i) => {
            const sc = parseFloat(row.cells[3 + i * 2].textContent);
            if (!isNaN(sc)) {
                if (!subjectScores[subjects[i]]) {
                    subjectScores[subjects[i]] = { total: 0, count: 0 };
                }
                subjectScores[subjects[i]].total += sc;
                subjectScores[subjects[i]].count++;
            }
        });
    });

    function getLevel(score) {
        if (score >= 90) return "EE 1";
        if (score >= 75) return "EE 2";
        if (score >= 58) return "ME 1";
        if (score >= 41) return "ME 2";
        if (score >= 31) return "AE 1";
        if (score >= 21) return "AE 2";
        if (score >= 11) return "BE 1";
        return "BE 2";
    }

    function getPoints(level) {
        switch (level) {
            case "EE 1": return 8;
            case "EE 2": return 7;
            case "ME 1": return 6;
            case "ME 2": return 5;
            case "AE 1": return 4;
            case "AE 2": return 3;
            case "BE 1": return 2;
            case "BE 2": return 1;
            default: return 0;
        }
    }

    const means = Object.keys(subjectScores).map(sub => {
        const { total, count } = subjectScores[sub];
        const mean = count > 0 ? total / count : 0;
        const level = getLevel(mean);
        const points = getPoints(level);
        return { subject: sub, mean: parseFloat(mean.toFixed(2)), level, points };
    }).sort((a, b) => b.mean - a.mean);

    const top5 = means.slice(0, 5);
    const year = new Date().getFullYear();
    const today = new Date();
    const printDate = `${today.getDate()}-${today.getMonth() + 1}-${year}`;

    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/VSAh48K.jpeg" alt="Logo" style="max-width:80px;margin:0 auto 10px;">
            <h2>NACHU JUNIOR SCHOOL SUBJECT TRACKER ANALYSIS REPORT</h2>
            <p>Year: ${year} | Grade: ${selectedGrade || 'All'} | Period: ${selectedExamPeriod || 'All'}</p>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:16px;">
            <thead><tr style="background:#f2f2f2;">
                <th style="border:2px solid black;padding:10px;">No.</th>
                <th style="border:2px solid black;padding:10px;">Subject</th>
                <th style="border:2px solid black;padding:10px;">Mean Score</th>
                <th style="border:2px solid black;padding:10px;">Level</th>
                <th style="border:2px solid black;padding:10px;">Points</th>
            </tr></thead><tbody>`;

    means.forEach((m, i) => {
        const isTop = top5.find(t => t.subject === m.subject);
        const style = isTop ? 'background:#FFD700;font-weight:bold;' : '';
        html += `<tr style="${style}">
            <td style="border:2px solid black;padding:10px;">${i + 1}</td>
            <td style="border:2px solid black;padding:10px;">${m.subject}</td>
            <td style="border:2px solid black;padding:10px;">${m.mean}</td>
            <td style="border:2px solid black;padding:10px;">${m.level}</td>
            <td style="border:2px solid black;padding:10px;">${m.points}</td>
        </tr>`;
    });

    html += `</tbody></table>
        <div class="stamp print-only" style="margin-top:30px;">
            Nachu Junior School<br>Exam Dept ‚Äî Date: ${printDate}
        </div>`;

    const out = document.getElementById("reportOutput");
    out.innerHTML = html;

    // üé® Styles (once)
    if (!document.getElementById("perfCelebrationStyles")) {
        const s = document.createElement("style");
        s.id = "perfCelebrationStyles";
        s.textContent = `
            @keyframes floatUpP {0%{transform:translateY(0) scale(1);}100%{transform:translateY(-150px) scale(1.5);opacity:0;}}
            @keyframes zoomInFade {from{transform:scale(0.5);opacity:0;} to{transform:scale(1);opacity:1;}}
            @keyframes fadeOut {from{opacity:1;}to{opacity:0;}}
        `;
        document.head.appendChild(s);
    }

    function showEmojis() {
        const list = ['üéá','üéâ','ü•á','üí´','üèÜ','üåü','ü•à','ü•â','‚ú®'];
        for (let i=0;i<60;i++){
            const e = document.createElement("span");
            const em = list[Math.floor(Math.random()*list.length)];
            const size = 20 + Math.random() * 20;
            e.textContent = em;
            e.style = `position:fixed;left:${Math.random()*100}vw;top:${Math.random()*100}vh;
                       font-size:${size}px;color:hsl(${Math.random()*360},100%,60%);
                       animation:floatUpP 3s ease-out forwards;pointer-events:none;z-index:9999`;
            document.body.appendChild(e);
            setTimeout(() => e.remove(), 10000);
        }
    }

    function showTop5Popup() {
        const p = document.createElement("div");
        p.style = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
                   background:linear-gradient(to right,#fff8dc,#ffe680);
                   border:4px solid gold;padding:25px;border-radius:20px;
                   font:bold 20px sans-serif;box-shadow:0 0 25px gold;
                   animation:zoomInFade 1s ease,fadeOut 1s ease 9s;z-index:10000`;
        p.innerHTML = `<div>üèÖ Top 5 Subject Performance üèÖ<br><br>${
            top5.map((t,i)=>`${i+1}. <strong>${t.subject}</strong>: ${t.mean} (${t.level})`).join("<br>")
        }</div>`;
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 10000);
    }

    showEmojis();
    showTop5Popup();

    // üñ®Ô∏è Print
    if (!document.getElementById("printSubjectPerformanceBtn")) {
        const btn = document.createElement("button");
        btn.id = "printSubjectPerformanceBtn";
        btn.className = "print-button";
        btn.innerHTML = '<i class="fas fa-print"></i> Print Report';
        out.appendChild(btn);
        btn.addEventListener("click", () => {
            const w = window.open('', '_blank');
            w.document.write(`
                <html><head><title>Subject Performance Report</title>
                <style>body{font-family:Arial;margin:20px}
                    table{width:100%;border-collapse:collapse;margin-bottom:20px}
                    th,td{border:2px solid black;padding:8px}
                    th{background:#f4f4f4;font-weight:bold}
                    img{max-width:100px}
                    .stamp{text-align:center;border:2px solid blue;color:blue;margin:20px auto;
                          width:200px;height:70px;display:flex;align-items:center;
                          justify-content:center;font-weight:bold;font-size:14px}
                    @media screen{.stamp{display:none}}
                </style></head><body>
                    ${out.innerHTML}
                </body></html>`);
            w.document.close();
            w.print();
        });
    }
}

function generateReport(reportType, selectedGrade, examPeriod) {
    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = ""; // Clear any existing content

    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];

    const levels = ['8', '7', '6', '5', '5', '4', '3', '2' ,'1'];

    const summary = {};

    // Initialize summary counters (if applicable for this report type)
    if (reportType === 'subjectChampions' || reportType === 'levelSummary') {
        subjects.forEach(subject => {
            summary[subject] = {};
            levels.forEach(level => summary[subject][level] = 0);
        });
    }

    // Process rows (e.g., marks table or database rows)
    marksTableBody.querySelectorAll("tr").forEach(row => {
        if (selectedGrade && row.getAttribute("data-grade") !== selectedGrade) return;
        if (examPeriod && row.getAttribute("data-period") !== examPeriod) return;

        // Example: Populate summary based on report type
        if (reportType === 'levelSummary') {
            subjects.forEach((subject, i) => {
                const level = row.querySelector(`td:nth-child(${4 + i * 2 + 1})`)?.textContent;
                if (levels.includes(level)) {
                    summary[subject][level]++;
                }
            });
        }

        // Add other report-specific data processing logic here
    });

    // Generate HTML
    const year = new Date().getFullYear();
    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/VSAh48K.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px; height: auto;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL REPORT</h2>
            <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p style="margin: 5px 0;">School Motto: "My Talent My Passion"</p>
            <p style="margin: 5px 0;">Year: ${year}</p>
            <p style="margin: 5px 0;">Grade: ${selectedGrade || 'All'}</p>
            <p style="margin: 5px 0;">Exam Period: ${examPeriod || 'All'}</p>
        </div>`;

    // Add table for level summary
    if (reportType === 'levelSummary') {
        html += `<table style="width: 100%; border-collapse: collapse; margin-top: 15px; background-color: white; color: black; font-size: 16px;">
            <thead>
                <tr style="background: #f2f2f2;">
                    <th style="border: 1px solid black; padding: 10px;">Subject</th>`;
        levels.forEach(level => {
            html += `<th style="border: 1px solid black; padding: 10px;">${level}</th>`;
        });
        html += `</tr></thead><tbody>`;

        subjects.forEach(subject => {
            html += `<tr>
                <td style="border: 1px solid black; padding: 10px;">${subject}</td>`;
            levels.forEach(level => {
                html += `<td style="border: 1px solid black; padding: 10px;">${summary[subject][level]}</td>`;
            });
            html += `</tr>`;
        });

        html += `</tbody></table>`;
    }

    // Add other report-specific HTML here (e.g., charts, summaries, etc.)

    reportOutput.innerHTML = html;

    // Add Print Button
    let printButton = document.getElementById("printReportBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printReportBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>${reportType} Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            table, th, td { border: 1px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; }
                            img { max-width: 100px; }
                            .stamp {
                                border: 2px solid blue;
                                color: blue;
                                text-align: center;
                                width: 200px;
                                height: 70px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 20px auto;
                                font-weight: bold;
                            }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                        <div class="stamp">
                            Nachu Junior School<br>
                            P.O. Box 561-00902<br>
                            Kikuyu...Exam Department
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
   }
function generateGenderPerformance(selectedGrade, selectedExamPeriod) {
  const marksTableBody = document.getElementById("marksList");
  const learnersTableBody = document.getElementById("learnersList");
  const reportOutput = document.getElementById("reportOutput");

  if (!marksTableBody || !learnersTableBody) {
    alert("Marks or learners table not found.");
    return;
  }

  function getLevel(score) {
    if (score >= 90) return "8";
    if (score >= 75) return "7";
    if (score >= 58) return "6";
    if (score >= 41) return "5";
    if (score >= 31) return "4";
    if (score >= 21) return "3";
    if (score >= 11) return "2";
    return "1";
  }

  function getTotalLevel(entry) {
    return (
      parseInt(getLevel(entry.english)) +
      parseInt(getLevel(entry.math)) +
      parseInt(getLevel(entry.preTech)) +
      parseInt(getLevel(entry.kiswahili)) +
      parseInt(getLevel(entry.science)) +
      parseInt(getLevel(entry.social)) +
      parseInt(getLevel(entry.agriculture)) +
      parseInt(getLevel(entry.cre)) +
      parseInt(getLevel(entry.art))
    );
  }

  const gradeValue = selectedGrade || "All Grades";
  const examPeriodValue = selectedExamPeriod || "All Periods";

  // Get all learners with their grade and gender information
  const learners = Array.from(learnersTableBody.querySelectorAll("tr")).map(row => {
    const cells = row.querySelectorAll("td");
    return {
      name: cells[2]?.textContent.trim(),
      gender: cells[3]?.textContent.trim().toLowerCase(),
      grade: cells[2]?.textContent.trim() // Capture the grade for each learner
    };
  });

  // Modify the marks filtering to include all streams that start with the same grade prefix (e.g., 8A, 8B, 8C for "8")
  const marks = Array.from(marksTableBody.querySelectorAll("tr"))
    .filter(row => {
      const grade = row.getAttribute("data-grade");
      const period = row.getAttribute("data-exam-period");
      // If a grade like "8B" is selected, include all grades starting with "8"
      return (!selectedGrade || grade.startsWith(selectedGrade.slice(0, -1))) &&
             (!selectedExamPeriod || period === selectedExamPeriod);
    })
    .map(row => {
      const cells = row.querySelectorAll("td");
      const english = parseInt(cells[3]?.textContent.trim()) || 0;
      const math = parseInt(cells[5]?.textContent.trim()) || 0;
      const preTech = parseInt(cells[7]?.textContent.trim()) || 0;
      const kiswahili = parseInt(cells[9]?.textContent.trim()) || 0;
      const science = parseInt(cells[11]?.textContent.trim()) || 0;
      const social = parseInt(cells[13]?.textContent.trim()) || 0;
      const agriculture = parseInt(cells[15]?.textContent.trim()) || 0;
      const cre = parseInt(cells[17]?.textContent.trim()) || 0;
      const art = parseInt(cells[19]?.textContent.trim()) || 0;

      const totalMarks = english + math + preTech + kiswahili + science + social + agriculture + cre + art;

      return {
        learner: cells[1]?.textContent.trim(),
        grade: cells[2]?.textContent.trim(),
        english,
        math,
        preTech,
        kiswahili,
        science,
        social,
        agriculture,
        cre,
        art,
        totalMarks,
      };
    });

  const genderPerformance = { male: [], female: [] };
  marks.forEach(entry => {
    const learner = learners.find(l => l.name === entry.learner);
    if (learner) {
      entry.totalLevel = getTotalLevel(entry); // Add total level to entry
      genderPerformance[learner.gender]?.push(entry);
    }
  });

  genderPerformance.male.sort((a, b) => b.totalMarks - a.totalMarks);
  genderPerformance.female.sort((a, b) => b.totalMarks - a.totalMarks);

  const top5Male = genderPerformance.male.slice(0, 5);
  const top5Female = genderPerformance.female.slice(0, 5);

  function createTable(data, gender, top5) {
    if (!data.length) return `<h3 style="color:red;">No ${gender} learners found for selected criteria.</h3>`;

    const color = gender === "male" ? "blue" : "purple";

    const totals = {
      english: 0, math: 0, preTech: 0, kiswahili: 0,
      science: 0, social: 0, agriculture: 0, cre: 0,
      art: 0, totalMarks: 0, totalLevel: 0
    };

    let html = `
      <div id="${gender}-section" style="margin-top:40px;">
      <h2 style="text-align:center; color:${color};">${gender.toUpperCase()} LEARNERS REPORT</h2>
      <table style="width:100%; border-collapse:collapse; font-size:15px;">
        <thead>
          <tr style="background:#f4f4f4;">
            <th style="border:2px solid black;">No.</th>
            <th style="border:2px solid black;">Name</th>
            <th style="border:2px solid black;">Grade</th>
            <th style="border:2px solid black;">Eng</th><th>Lev</th>
            <th style="border:2px solid black;">Math</th><th>Lev</th>
            <th style="border:2px solid black;">PreTech</th><th>Lev</th>
            <th style="border:2px solid black;">Kisw</th><th>Lev</th>
            <th style="border:2px solid black;">Scie</th><th>Lev</th>
            <th style="border:2px solid black;">SST</th><th>Lev</th>
            <th style="border:2px solid black;">Agric</th><th>Lev</th>
            <th style="border:2px solid black;">CRE</th><th>Lev</th>
            <th style="border:2px solid black;">C/A</th><th>Lev</th>
            <th style="border:2px solid black;">Total Marks</th>
            <th style="border:2px solid black;">Points</th>
          </tr>
        </thead><tbody>`;

    data.forEach((entry, index) => {
      const isTop = top5.find(t => t.learner === entry.learner);
      const rowStyle = isTop ? "background:#FFD700;font-weight:bold;" : "";
      const totalLevel = entry.totalLevel;

      html += `<tr style="${rowStyle}">
        <td>${index + 1}</td>
        <td>${entry.learner}</td>
        <td>${entry.grade}</td>
        <td>${entry.english}</td><td>${getLevel(entry.english)}</td>
        <td>${entry.math}</td><td>${getLevel(entry.math)}</td>
        <td>${entry.preTech}</td><td>${getLevel(entry.preTech)}</td>
        <td>${entry.kiswahili}</td><td>${getLevel(entry.kiswahili)}</td>
        <td>${entry.science}</td><td>${getLevel(entry.science)}</td>
        <td>${entry.social}</td><td>${getLevel(entry.social)}</td>
        <td>${entry.agriculture}</td><td>${getLevel(entry.agriculture)}</td>
        <td>${entry.cre}</td><td>${getLevel(entry.cre)}</td>
        <td>${entry.art}</td><td>${getLevel(entry.art)}</td>
        <td><strong>${entry.totalMarks}</strong></td>
        <td><strong>${totalLevel}</strong></td>
      </tr>`;

      totals.english += entry.english;
      totals.math += entry.math;
      totals.preTech += entry.preTech;
      totals.kiswahili += entry.kiswahili;
      totals.science += entry.science;
      totals.social += entry.social;
      totals.agriculture += entry.agriculture;
      totals.cre += entry.cre;
      totals.art += entry.art;
      totals.totalMarks += entry.totalMarks;
      totals.totalLevel += totalLevel;
    });

    const count = data.length;
    html += `
      <tr style="background:yellow;font-weight:bold;"><td colspan="3">Totals</td>
        <td>${totals.english}</td><td>-</td><td>${totals.math}</td><td>-</td>
        <td>${totals.preTech}</td><td>-</td><td>${totals.kiswahili}</td><td>-</td>
        <td>${totals.science}</td><td>-</td><td>${totals.social}</td><td>-</td>
        <td>${totals.agriculture}</td><td>-</td><td>${totals.cre}</td><td>-</td>
        <td>${totals.art}</td><td>-</td>
        <td>${totals.totalMarks}</td><td>${totals.totalLevel}</td>
      </tr>
      <tr style="background:lightblue;font-weight:bold;"><td colspan="3">Averages</td>
        <td>${(totals.english/count).toFixed(1)}</td><td>-</td><td>${(totals.math/count).toFixed(1)}</td><td>-</td>
        <td>${(totals.preTech/count).toFixed(1)}</td><td>-</td><td>${(totals.kiswahili/count).toFixed(1)}</td><td>-</td>
        <td>${(totals.science/count).toFixed(1)}</td><td>-</td><td>${(totals.social/count).toFixed(1)}</td><td>-</td>
        <td>${(totals.agriculture/count).toFixed(1)}</td><td>-</td><td>${(totals.cre/count).toFixed(1)}</td><td>-</td>
        <td>${(totals.art/count).toFixed(1)}</td><td>-</td>
        <td>${(totals.totalMarks/count).toFixed(1)}</td><td>${(totals.totalLevel/count).toFixed(1)}</td>
      </tr>
    </tbody></table>
    <div style="text-align:center;margin-top:15px;">
      <button onclick="printSection('${gender}-section','${gradeValue}','${examPeriodValue}')" class="print-button">üñ®Ô∏è Print ${gender} Report</button>
    </div></div>`;
    return html;
  }

  reportOutput.innerHTML =
    createTable(genderPerformance.male, "male", top5Male) +
    createTable(genderPerformance.female, "female", top5Female);

  // Celebration styles
  if (!document.getElementById("genderPerfStyles")) {
    const style = document.createElement("style");
    style.id = "genderPerfStyles";
    style.textContent = `
      @keyframes floatUpG {0%{transform:translateY(0) scale(1);}100%{transform:translateY(-150px) scale(1.5);opacity:0;}}
      @keyframes zoomInFade {from{transform:scale(0.5);opacity:0;} to{transform:scale(1);opacity:1;}}
      @keyframes fadeOut {from{opacity:1;}to{opacity:0;}}
    `;
    document.head.appendChild(style);
  }

  function showCelebrationPopup(title, topList) {
    const popup = document.createElement("div");
    popup.style = `
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:linear-gradient(to right,#fff8dc,#ffe680);border:4px solid gold;
      padding:25px;border-radius:20px;font:bold 18px sans-serif;
      box-shadow:0 0 25px gold;animation:zoomInFade 1s ease,fadeOut 1s ease 9s;
      z-index:10000;text-align:center;line-height:1.6
    `;
    popup.innerHTML = `<div>üèÖ ${title} üèÖ<br><br>${
      topList.map((t, i) => `${i + 1}. <strong>${t.learner}</strong>: ${t.totalMarks} marks`).join("<br>")
    }</div>`;
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 10000);
  }

  function showFloatingEmojis() {
    const emojis = ['üéâ','üèÖ','üéá','üèÜ','üåü','‚ú®','ü•á','ü•à','ü•â'];
    for (let i = 0; i < 60; i++) {
      const e = document.createElement("span");
      const em = emojis[Math.floor(Math.random() * emojis.length)];
      const size = 20 + Math.random() * 20;
      e.textContent = em;
      e.style = `
        position:fixed;left:${Math.random() * 100}vw;top:${Math.random() * 100}vh;
        font-size:${size}px;color:hsl(${Math.random() * 360},100%,60%);
        animation:floatUpG 3s ease-out forwards;pointer-events:none;z-index:9999;
      `;
      document.body.appendChild(e);
      setTimeout(() => e.remove(), 10000);
    }
  }

  // üéâ Celebration: emojis + delayed popups
  showFloatingEmojis();
  showCelebrationPopup("Top 5 Female Performers", top5Female);
  setTimeout(() => {
    showCelebrationPopup("Top 5 Male Performers", top5Male);
  }, 10000); // Delay male popup by 10 seconds

}


function printSection(sectionId, grade, examPeriod) {
  const section = document.getElementById(sectionId);
  const year = new Date().getFullYear();
  const today = new Date();
  const printDate = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;

  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head>
        <title>Gender Performance Report</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; color: #000; }
          h2, h3, p { margin: 5px 0; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { border: 2px solid black; padding: 8px; font-size: 14px; }
          th { background-color: #f4f4f4; font-weight: bold; }
          .header { text-align: center; margin-bottom: 20px; }
          .header img { max-width: 100px; display: block; margin: 0 auto 10px; }
          .stamp {
            border: 2px solid blue;
            color: blue;
            width: 200px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px auto;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
          }
          @media screen {
            .stamp { display: none; }
          }
        </style>
      </head>
      <body>
        <div class="header">
          <img src="https://i.imgur.com/VSAh48K.jpeg" alt="School Logo">
          <h2><b>NACHU JUNIOR SCHOOL GENDER PERFORMANCE REPORT</b></h2>
          <p><b>Address:</b> P.O. Box 561-00902, Kikuyu, Kenya</p>
          <p><b>Phone:</b> +254-700-123456</p>
          <p><b>School Motto:</b> "My Talent My Passion"</p>
          <p><b>Year:</b> ${year}</p>
          <p><b>Grade:</b> ${grade}</p>
          <p><b>Exam Period:</b> ${examPeriod}</p>
        </div>

        ${section.innerHTML}

        <div class="stamp">
          Nachu Junior School<br>
          P.O. Box 561-00902, Kikuyu<br>
          Exam Department<br>
          Date: ${printDate}
        </div>

      </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  printWindow.close();
}

window.printSection = printSection;



document.getElementById("generateAssessmentReportsBtn").addEventListener("click", function () {
    const grade = document.getElementById("reportGradeSelect").value;

    // Handle missing grade selection
    if (!grade || grade === "Select Grade") {
        createCustomAlert(
            "Oops! You forgot to select a grade. Please choose a grade from the dropdown before generating the assessment reports.",
            "#f8d7da",
            "#721c24"
        );
        return;
    }

    // Collect term details from form inputs
    const year = document.getElementById("year").value.trim();
    const term = document.getElementById("term").value.trim();
    const closingDate = document.getElementById("closingDate").value.trim();
    const openingDate = document.getElementById("openingDate").value.trim();
    const classTeacherSignature = document.getElementById("classTeacherSignature").value.trim();
    const principalSignature = document.getElementById("principalSignature").value.trim();

    // Handle missing term details
    if (!year || !term || !closingDate || !openingDate || !classTeacherSignature || !principalSignature) {
        createCustomAlert(
            "Please fill in all the term details before generating the reports.",
            "#ffeeba",
            "#856404"
        );
        return;
    }

    // Pass term details and selected grade to the report generator
    const termDetails = { year, term, closingDate, openingDate, classTeacherSignature, principalSignature };
    generateLearnerAssessmentReports(termDetails, grade); // Pass grade for filtered reports
});

/**
 * Creates a custom alert.
 * @param {string} message - The alert message to display.
 * @param {string} bgColor - The background color for the alert.
 * @param {string} textColor - The text color for the alert.
 */
function createCustomAlert(message, bgColor, textColor) {
    // Create the custom alert element
    const customAlert = document.createElement("div");
    customAlert.style.display = "flex";
    customAlert.style.flexDirection = "column";
    customAlert.style.alignItems = "center";
    customAlert.style.position = "fixed";
    customAlert.style.top = "50%";
    customAlert.style.left = "50%";
    customAlert.style.transform = "translate(-50%, -50%)";
    customAlert.style.backgroundColor = bgColor;
    customAlert.style.color = textColor;
    customAlert.style.padding = "20px";
    customAlert.style.borderRadius = "10px";
    customAlert.style.boxShadow = "0 4px 10px rgba(0, 0, 0, 0.2)";
    customAlert.style.zIndex = "9999";
    customAlert.style.width = "90%";
    customAlert.style.maxWidth = "400px";

    // Add the alert message
    const alertMessage = document.createElement("span");
    alertMessage.style.textAlign = "center";
    alertMessage.style.marginBottom = "10px";
    alertMessage.textContent = message;
    customAlert.appendChild(alertMessage);

    // Add a close button
    const closeButton = document.createElement("button");
    closeButton.textContent = "Close";
    closeButton.style.marginTop = "10px";
    closeButton.style.backgroundColor = textColor;
    closeButton.style.color = "white";
    closeButton.style.border = "none";
    closeButton.style.padding = "10px 20px";
    closeButton.style.borderRadius = "5px";
    closeButton.style.cursor = "pointer";
    closeButton.addEventListener("click", function () {
        document.body.removeChild(customAlert); // Remove the alert on click
    });
    customAlert.appendChild(closeButton);

    // Append the custom alert to the body
    document.body.appendChild(customAlert);
}

function generateLearnerAssessmentReports(termDetails) {
  const { year, term, closingDate, openingDate, classTeacherSignature, principalSignature } = termDetails;

  const rows = document.querySelectorAll("#marksList tr");
  const learnerRows = document.querySelectorAll("#learnersList tr");
  const container = document.getElementById("assessmentReportsContainer");
  container.innerHTML = "";

  const govtLogo = "https://i.imgur.com/KkbIFjL.png";
  const schoolLogo = "https://i.imgur.com/VSAh48K.jpeg";
  const defaultAvatar = "https://i.imgur.com/AXrekYa.jpeg";
  const date = new Date().toLocaleDateString("en-GB");
  const footerDate = new Date().toLocaleDateString("en-GB");

  const gradeFilter = document.getElementById("reportGradeSelect").value;

  function getPoints(level) {
    switch (level) {
      case "EE 1": return 8;
      case "EE 2": return 7;
      case "ME 1": return 6;
      case "ME 2": return 5;
      case "AE 1": return 4;
      case "AE 2": return 3;
      case "BE 1": return 2;
      case "BE 2": return 1;
      default: {
        const numeric = parseInt(level);
        return isNaN(numeric) ? 0 : numeric;
      }
    }
  }

  function getLevelFromPoints(points) {
    switch (String(points)) {
      case "8": return "EE 1";
      case "7": return "EE 2";
      case "6": return "ME 1";
      case "5": return "ME 2";
      case "4": return "AE 1";
      case "3": return "AE 2";
      case "2": return "BE 1";
      case "1": return "BE 2";
      default: return "N/A";
    }
  }

  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    if (cells.length < 22) return;

    const learnerName = cells[1].textContent.trim();
    const grade = cells[2].textContent.trim();
    if (grade !== gradeFilter) return;

    const rawTotalMarks = cells[21].textContent.trim();
    const totalMarks = parseInt(rawTotalMarks) || 0;
    const performance = getPerformanceLevel(totalMarks);

    let learnerPhoto = defaultAvatar;
    learnerRows.forEach(lr => {
      if (lr.cells[2]?.textContent.trim() === learnerName) {
        const imgTag = lr.querySelector("img");
        learnerPhoto = imgTag?.src || defaultAvatar;
      }
    });

    const subjects = [
      { name: "English", mark: cells[3].textContent.trim(), level: cells[4].textContent.trim() },
      { name: "Mathematics", mark: cells[5].textContent.trim(), level: cells[6].textContent.trim() },
      { name: "Pre-Technical Studies", mark: cells[7].textContent.trim(), level: cells[8].textContent.trim() },
      { name: "Kiswahili", mark: cells[9].textContent.trim(), level: cells[10].textContent.trim() },
      { name: "Integrated Science", mark: cells[11].textContent.trim(), level: cells[12].textContent.trim() },
      { name: "Social Studies", mark: cells[13].textContent.trim(), level: cells[14].textContent.trim() },
      { name: "Agriculture", mark: cells[15].textContent.trim(), level: cells[16].textContent.trim() },
      { name: "Religious Education", mark: cells[17].textContent.trim(), level: cells[18].textContent.trim() },
      { name: "Creative Arts & Sports", mark: cells[19].textContent.trim(), level: cells[20].textContent.trim() },
    ].map(s => {
      let level = s.level;
      if (!isNaN(level)) {
        level = getLevelFromPoints(level);
      }
      const points = getPoints(level);
      return { ...s, level, points };
    });

    const totalPoints = subjects.reduce((sum, s) => sum + s.points, 0);
    const maxTotalMarks = subjects.length * 100;
    const maxTotalPoints = subjects.length * 8;

    const report = document.createElement("div");
    report.style.pageBreakAfter = "always";
    report.style.border = "3px solid #000";
    report.style.padding = "20px";
    report.style.marginBottom = "30px";
    report.style.background = "#fff";
    report.style.color = "#000";

    report.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <img src="${govtLogo}" alt="Gov Logo" style="height: 80px;">
        <div style="text-align: center; flex-grow: 1; color: #000;">
          <h2 style="margin: 0;">NACHU JUNIOR SCHOOL</h2>
          <p style="margin: 2px;">PO BOX 561-00902 KIKUYU, KENYA</p>
          <p style="margin: 2px;">MINISTRY OF EDUCATION SCIENCE AND TECHNOLOGY</p>
          <strong style="font-size: 14px;">SCHOOL MOTTO: MY TALENT MY PASSION</strong>
        </div>
        <img src="${schoolLogo}" alt="School Logo" style="height: 80px;">
      </div>

      <hr style="margin: 10px 0;">

      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex: 1;">
          <p><strong>GRADE:</strong> ${grade} &emsp; <strong>TERM:</strong> ${term} &emsp; <strong>YEAR:</strong> ${year}</p>
          <p><strong>Learner's Name:</strong> ${learnerName}</p>
        </div>
        <div>
          <img src="${learnerPhoto}" alt="Learner Photo" style="height: 100px; border-radius: 10px; border: 1px solid #333;">
        </div>
      </div>

      <table style="width: 100%; border-collapse: collapse; margin-top: 10px; color: #000;">
       <thead>
  <tr style="background: #f2f2f2;">
    <th style="border: 3px solid #000; padding: 8px; color: #000;">Subject</th>
    <th style="border: 3px solid #000; padding: 8px; color: #000;">Score</th>
    <th style="border: 3px solid #000; padding: 8px; color: #000;">Level</th>
    <th style="border: 3px solid #000; padding: 8px; color: #000;">Points</th>
    <th style="border: 3px solid #000; padding: 8px; color: #000;">Subject Teacher</th>
    <th style="border: 3px solid #000; padding: 8px; color: #000;">Signature</th>
  </tr>
</thead>

        <tbody>
          ${subjects.map(sub => `
            <tr>
              <td style="border: 3px solid #000; padding: 8px;">${sub.name}</td>
              <td style="border: 3px solid #000; padding: 8px;">${sub.mark}</td>
              <td style="border: 3px solid #000; padding: 8px;">${sub.level}</td>
              <td style="border: 3px solid #000; padding: 8px;">${sub.points}</td>
              <td style="border: 3px solid #000; padding: 8px;">${subjectTeachers[sub.name] || "N/A"}</td>
              <td style="border: 3px solid #000; padding: 8px;">${getInitials(subjectTeachers[sub.name]) || "N/A"}</td>
            </tr>
          `).join("")}
          <tr>
            <td colspan="6" style="border: 3px solid #000; padding: 10px; text-align: center; font-weight: bold; background: #f9f9f9;">
              TOTAL MARKS: ${totalMarks} / ${maxTotalMarks} &nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp;&nbsp;
              TOTAL POINTS: ${totalPoints} / ${maxTotalPoints}
            </td>
          </tr>
        </tbody>
      </table>

      <p style="font-size: 14px; margin-top: 10px;"><strong>KEY:</strong><br>
        1‚Äì10: BE2,&nbsp;&nbsp;11‚Äì20: BE1,&nbsp;&nbsp;21‚Äì30: AE2,&nbsp;&nbsp;31‚Äì40: AE1,<br>
        41‚Äì57: ME2,&nbsp;&nbsp;58‚Äì74: ME1,&nbsp;&nbsp;75‚Äì89: EE2,&nbsp;&nbsp;90‚Äì99: EE1
      </p>

      <p><strong>Teacher Comments:</strong><br>${getComment(totalMarks)}</p>
      <p><strong>Learner's General Performance Level:</strong> ${performance}</p>

      <div style="margin-top: 20px;">
        <p><strong>CLOSING DATE:</strong> ${closingDate} &emsp; <strong>OPENING DATE:</strong> ${openingDate}</p>
        <p><strong>Class Teacher Signature:</strong> ${classTeacherSignature} &emsp; <strong>Principal Signature:</strong> ${principalSignature}</p>

        <div style="border: 2px solid blue; color: blue; padding: 10px; display: inline-block; text-align: center; font-style: italic; font-weight: bold; border-radius: 5px;">
          Nachu Junior School<br>
          P.O. Box 561-00902 Kikuyu<br>
          Date: ${date}
        </div>
      </div>

      <div style="margin-top: 20px; text-align: center; font-size: 12px; page-break-inside: avoid; color: #000;">
        Printed on: ${footerDate} ‚Ä¢ End of Report<br>
        <span style="font-style: italic;">Generated by Rasmtech</span>
      </div>
    `;

    container.appendChild(report);
  });

    // Add Print Button
    const printButton = document.createElement("button");
    printButton.textContent = `Print Reports for ${selectedGrade || "All Grades"}`;
    printButton.style.marginTop = "20px";
    printButton.style.padding = "10px 20px";
    printButton.style.background = "#007BFF";
    printButton.style.color = "#FFF";
    printButton.style.border = "none";
    printButton.style.borderRadius = "5px";
    printButton.style.cursor = "pointer";

    printButton.addEventListener("click", function () {
        const printContent = container.innerHTML;
        const originalContent = document.body.innerHTML;

        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
        location.reload(); // Reload to reset the page
    });

    container.appendChild(printButton);
    container.scrollIntoView({ behavior: "smooth" });
}


const subjectList = [
    "English", "Mathematics", "Pre-Technical Studies", "Kiswahili",
    "Integrated Science", "Social Studies", "Agriculture",
    "Religious Education", "Creative Arts & Sports"
];
let subjectTeachers = {};

document.getElementById("generateAssessmentReportsBtn").addEventListener("click", showTeacherModal);

function showTeacherModal() {
    const modal = document.getElementById("teacherModal");
    const inputArea = document.getElementById("teacherInputs");
    inputArea.innerHTML = "";

    // Add inputs for subject teachers
    subjectList.forEach(subject => {
        inputArea.innerHTML += `
            <div class="form-group">
                <label for="${subject}">${subject} Teacher</label>
                <input type="text" id="${subject}" name="${subject}" required>
            </div>`;
    });

    // Add inputs for term details
    inputArea.innerHTML += `
        <div class="form-group">
 
        </div>
        <div class="form-group">
            
        </div>`;
    
    modal.style.display = "flex";
}

document.getElementById("teacherForm").addEventListener("submit", function (e) {
    e.preventDefault();

    // Collect subject teachers
    subjectTeachers = {};
    subjectList.forEach(subject => {
        const value = document.getElementById(subject).value.trim();
        subjectTeachers[subject] = value || "N/A";
    });

    // Collect term details
    const year = document.getElementById("year").value.trim();
    const term = document.getElementById("term").value.trim();
    const closingDate = document.getElementById("closingDate").value.trim();
    const openingDate = document.getElementById("openingDate").value.trim();
    const classTeacherSignature = document.getElementById("classTeacherSignature").value.trim();
    const principalSignature = document.getElementById("principalSignature").value.trim();

    // Validation for term details
    if (!year || !term || !closingDate || !openingDate || !classTeacherSignature || !principalSignature) {
        alert("Please fill in all required fields.");
        return;
    }

    // Create term details object
    const termDetails = { year, term, closingDate, openingDate, classTeacherSignature, principalSignature };

    closeTeacherModal();

    // Generate reports with both teacher and term details
    generateLearnerAssessmentReports(termDetails);
});

function closeTeacherModal() {
    document.getElementById("teacherModal").style.display = "none";
}


function getInitials(name) {
    return name
        .split(" ")
        .filter(Boolean)
        .map(word => word.charAt(0).toUpperCase())
        .join("");
}
function getPerformanceLevel(totalMarks) {
    if (totalMarks >= 1 && totalMarks <= 112) return "Below Expectations Two";
    if (totalMarks >= 113 && totalMarks <= 225) return "Below Expectations One";
    if (totalMarks >= 226 && totalMarks <= 337) return "Approaching Expectations Two";
    if (totalMarks >= 338 && totalMarks <= 450) return "Approaching Expectations One";
    if (totalMarks >= 451 && totalMarks <= 562) return "Meeting Expectations Two";
    if (totalMarks >= 563 && totalMarks <= 675) return "Meeting Expectations One";
    if (totalMarks >= 676 && totalMarks <= 787) return "Exceeding Expectations Two";
    if (totalMarks >= 788 && totalMarks <= 900) return "Exceeding Expectations One";
    return "Invalid";
}

 function getComment(totalMarks) {
           if (totalMarks >= 0 && totalMarks <= 20) 
    return "Needs significant improvement. Should seek help and put in extra effort.";
if (totalMarks >= 21 && totalMarks <= 30) 
    return "Shows some understanding but needs to work harder and focus on their studies.";
if (totalMarks >= 31 && totalMarks <= 50) 
    return "Displays potential but requires more dedication to reach higher performance.";
if (totalMarks >= 51 && totalMarks <= 70) 
    return "Making steady progress. Should maintain focus to improve further.";
if (totalMarks >= 71 && totalMarks <= 85) 
    return "Demonstrates good understanding but should aim for consistent excellence.";
if (totalMarks >= 86 && totalMarks <= 140) 
    return "Shows dedication and effort but can aim for even higher performance.";
if (totalMarks >= 141 && totalMarks <= 199) 
    return "Displays self-discipline; however, should put extra effort to achieve higher scores.";
if (totalMarks >= 200 && totalMarks <= 205)  
    return "Shows enthusiasm for learning but needs to focus on grasping foundational concepts. Encouraged to seek clarification when in doubt.";  
if (totalMarks >= 206 && totalMarks <= 215)  
    return "Demonstrates interest in academics but requires more consistency in applying knowledge. Should practice regularly to build confidence.";  
if (totalMarks >= 216 && totalMarks <= 225)  
    return "Has potential to improve but needs to work on time management and study habits. Encouraged to engage more in revision and discussions.";  
if (totalMarks >= 226 && totalMarks <= 235)  
    return "Engages with class activities but should refine problem-solving techniques. Needs to develop a structured approach to answering questions.";  
if (totalMarks >= 236 && totalMarks <= 245)  
    return "Displays curiosity and willingness to learn but struggles with applying concepts. Should focus on understanding rather than memorization.";  
if (totalMarks >= 246 && totalMarks <= 255)  
    return "Puts in effort but must aim for greater accuracy in assignments and tests. Reviewing mistakes carefully will enhance performance.";  
if (totalMarks >= 256 && totalMarks <= 265)  
    return "Shows eagerness to learn but needs to work on building confidence when answering questions. Should participate more in class discussions.";  
if (totalMarks >= 266 && totalMarks <= 275)  
    return "Participates in class activities but requires a stronger grasp of core subjects. Encouraged to ask more questions and seek additional resources.";  
if (totalMarks >= 276 && totalMarks <= 285)  
    return "Makes steady progress and shows improvement in understanding concepts. Should challenge themselves further by attempting advanced problems.";  
if (totalMarks >= 286 && totalMarks <= 295)  
    return "Displays motivation and a desire to improve. Needs to focus on critical thinking and applying knowledge to real-world scenarios.";  
if (totalMarks >= 296 && totalMarks <= 300)  
    return "Committed to learning and shows perseverance. Should refine study techniques for better retention and comprehension.";  
if (totalMarks >= 301 && totalMarks <= 350)  
    return "Actively participates in class discussions and collaborates well with peers. Demonstrates growing confidence in expressing ideas.";  
if (totalMarks >= 351 && totalMarks <= 400)  
    return "Shows steady academic progress and a willingness to learn. Encouraged to maintain a consistent study schedule to reinforce learning.";  
if (totalMarks >= 401 && totalMarks <= 449)  
    return "Consistently performs above expectations, demonstrating strong analytical and problem-solving skills. A well-rounded student.";  
if (totalMarks >= 450 && totalMarks <= 500)  
    return "Exhibits leadership qualities and a solid grasp of concepts. Should continue exploring challenging material to push beyond comfort zones.";  
if (totalMarks >= 501 && totalMarks <= 550)  
    return "A high-achieving student who takes initiative in group discussions. Sets a great example for peers through disciplined study habits.";  
if (totalMarks >= 551 && totalMarks <= 599)  
    return "Excels academically and demonstrates a strong ability to grasp new concepts. Should continue nurturing curiosity and exploring deeper learning.";  
if (totalMarks >= 600 && totalMarks <= 630)  
    return "A highly motivated learner who consistently delivers outstanding results. Shows great potential for further academic excellence.";  
if (totalMarks >= 631 && totalMarks <= 670)  
    return "Displays deep subject mastery and strong analytical skills. Should take on advanced challenges to further enhance learning.";  
if (totalMarks >= 671 && totalMarks <= 700)  
    return "Demonstrates critical thinking and a keen ability to apply knowledge. Shows promise in problem-solving and independent learning.";  
if (totalMarks >= 701 && totalMarks <= 750)  
    return "Achieves remarkable academic performance with a strong work ethic. Should continue to challenge themselves with complex concepts.";  
if (totalMarks >= 751 && totalMarks <= 800)  
    return "Displays outstanding problem-solving skills and an in-depth understanding of subjects. A top performer with great potential.";  
if (totalMarks >= 801 && totalMarks <= 850)  
    return "Excels in all areas and consistently exceeds expectations. Should consider mentoring peers to reinforce knowledge.";  
if (totalMarks >= 851 && totalMarks <= 900)  
    return "An exceptional learner who sets a high standard for academic excellence. Demonstrates leadership, discipline, and an advanced understanding of concepts.";  
return "";


}
document.getElementById("combineMarksByGradeBtn").addEventListener("click", () => {
    document.getElementById("customPrompt").style.display = "flex";
    document.getElementById("gradeInput").value = ""; // clear any previous input
    document.getElementById("gradeInput").focus();
});

document.getElementById("confirmGradeBtn").addEventListener("click", () => {
  const selectedGrade = document.getElementById("gradeInput").value.trim();
  const examPeriod = document.getElementById("reportExamPeriodSelect").value;

  if (!selectedGrade) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please enter a valid grade.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  if (!examPeriod || examPeriod === "Select Exam Period") {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select a valid exam period.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  document.getElementById("customPrompt").style.display = "none";
  combineMarksByGradeWithDetails(selectedGrade, examPeriod);
});


document.getElementById("cancelGradeBtn").addEventListener("click", () => {
    document.getElementById("customPrompt").style.display = "none";
});
function combineMarksByGradeWithDetails(mainGrade, selectedPeriod) {
    const rows = document.querySelectorAll("#marksList tr");
    const learnersData = [];
    const totals = {
        eng: 0, math: 0, preTech: 0, kiswahili: 0,
        science: 0, social: 0, agriculture: 0, cre: 0, creativeArt: 0, totalMarks: 0, totalLevel: 0
    };
    let learnerCount = 0;

    rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length < 20) return;

        const gradeText = cells[2]?.textContent?.trim()?.toLowerCase();
        const periodAttr = row.getAttribute("data-exam-period")?.trim()?.toLowerCase();
        const normalizedMainGrade = mainGrade.trim().toLowerCase();
        const normalizedPeriod = selectedPeriod.trim().toLowerCase();
        const gradeMatches = gradeText === normalizedMainGrade || gradeText.includes(normalizedMainGrade);

        if (gradeMatches && periodAttr === normalizedPeriod) {
            const learnerData = {
                name: cells[1].textContent.trim(),
                grade: cells[2].textContent.trim(),
                eng: parseFloat(cells[3].textContent) || 0,
                math: parseFloat(cells[5].textContent) || 0,
                preTech: parseFloat(cells[7].textContent) || 0,
                kiswahili: parseFloat(cells[9].textContent) || 0,
                science: parseFloat(cells[11].textContent) || 0,
                social: parseFloat(cells[13].textContent) || 0,
                agriculture: parseFloat(cells[15].textContent) || 0,
                cre: parseFloat(cells[17].textContent) || 0,
                creativeArt: parseFloat(cells[19].textContent) || 0
            };

            learnerData.totalMarks = Object.values(learnerData).slice(2).reduce((sum, mark) => sum + mark, 0);
            learnerData.totalLevel = 
                getLevel(learnerData.eng) + getLevel(learnerData.math) + getLevel(learnerData.preTech) +
                getLevel(learnerData.kiswahili) + getLevel(learnerData.science) + getLevel(learnerData.social) +
                getLevel(learnerData.agriculture) + getLevel(learnerData.cre) + getLevel(learnerData.creativeArt);

            learnersData.push(learnerData);
            for (let key in totals) totals[key] += learnerData[key];
            learnerCount++;
        }
    });

    if (learnersData.length === 0) {
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'info',
            title: `No data found for grade ${mainGrade} and period ${selectedPeriod}.`,
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
        return;
    }

    learnersData.sort((a, b) => b.totalMarks - a.totalMarks);
    const top20 = learnersData.slice(0, 20);

    const year = new Date().getFullYear();
    const avg = val => (learnerCount ? (val / learnerCount).toFixed(2) : "0.00");

    let html = `
    <div style="text-align:center; margin-bottom:20px;">
        <img src="https://i.imgur.com/VSAh48K.jpeg" alt="Logo" style="display:block; margin:0 auto 10px; width:80px;">
        <h2 style="margin:0;">NACHU JUNIOR SCHOOL COMBINED MARKS REPORT</h2>
        <p>Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
        <p>Motto: "My Talent My Passion"</p>
        <p>Year: ${year}</p>
        <p>Grade: ${mainGrade}</p>
        <p>Exam Period: ${selectedPeriod}</p>
    </div>
    <table style="width:100%; border-collapse:collapse; font-size:15px;">
        <thead>
            <tr style="background:#f2f2f2;">
                <th style="border:3px solid black;">No.</th>
                <th style="border:3px solid black;">Name</th>
                <th style="border:3px solid black;">Grade</th>
                ${['Eng','Math','Pre-Tech','Kisw','Scie','SST','Agric','CRE','C/A'].map(sub => `
                <th style="border:3px solid black;">${sub}</th>
                <th style="border:3px solid black;">Level</th>`).join('')}
                <th style="border:3px solid black;">Total</th>
                <th style="border:3px solid black;">Total Level</th> <!-- Added Total Level column -->
            </tr>
        </thead>
        <tbody>`;

    learnersData.forEach((l, i) => {
        html += `<tr>
            <td style="border:3px solid black;">${i + 1}</td>
            <td style="border:3px solid black;">${l.name}</td>
            <td style="border:3px solid black;">${l.grade}</td>
            ${['eng','math','preTech','kiswahili','science','social','agriculture','cre','creativeArt']
            .map(k => `<td style="border:3px solid black;">${l[k]}</td><td style="border:3px solid black;">${getLevel(l[k])}</td>`).join('')}
            <td style="border:3px solid black;">${l.totalMarks}</td>
            <td style="border:3px solid black;">${l.totalLevel}</td> <!-- Added Total Level value -->
        </tr>`;
    });

    html += `
    <tr style="background:#e6f7ff; font-weight:bold;">
        <td colspan="3" style="border:3px solid black;">TOTAL</td>
        ${['eng','math','preTech','kiswahili','science','social','agriculture','cre','creativeArt']
        .map(k => `<td style="border:3px solid black;">${totals[k]}</td><td style="border:3px solid black;"></td>`).join('')}
        <td style="border:3px solid black;">${totals.totalMarks}</td>
        <td style="border:3px solid black;">${totals.totalLevel}</td> <!-- Added Total Level value -->
    </tr>
    <tr style="background:#fcf8e3; font-weight:bold;">
        <td colspan="3" style="border:3px solid black;">AVERAGE</td>
        ${['eng','math','preTech','kiswahili','science','social','agriculture','cre','creativeArt']
        .map(k => `<td style="border:3px solid black;">${avg(totals[k])}</td><td style="border:3px solid black;"></td>`).join('')}
        <td style="border:3px solid black;">${avg(totals.totalMarks)}</td>
        <td style="border:3px solid black;">${avg(totals.totalLevel)}</td> <!-- Added Average Level value -->
    </tr></tbody></table>`;

    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = html;

    // Print Button
    let printButton = document.getElementById("printCombinedMarksBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printCombinedMarksBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const today = new Date();
            const printDate = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html><head><title>Combined Marks Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    table, th, td { border: 3px solid black; border-collapse: collapse; padding: 8px; }
                    th { background-color: #f4f4f4; }
                    .stamp {
                        border: 2px solid blue;
                        color: blue; width: 200px; height: 70px;
                        display: flex; align-items: center; justify-content: center;
                        margin: 30px auto; font-weight: bold; font-size: 14px;
                    }
                    @media screen {.stamp { display: none; }}
                </style>
                </head><body>${reportOutput.innerHTML}
                <div class="stamp">Nachu Junior School<br>P.O. Box 561-00902, Kikuyu<br>Exam Department<br>Date: ${printDate}</div>
                </body></html>`);
            printWindow.document.close();
            printWindow.print();
        });
    }

    // üéâ Styles & Effects
    if (!document.getElementById("perfCelebrationStyles")) {
        const s = document.createElement("style");
        s.id = "perfCelebrationStyles";
        s.textContent = `
            @keyframes floatUpP {0%{transform:translateY(0) scale(1);}100%{transform:translateY(-150px) scale(1.5);opacity:0;}}
            @keyframes zoomInFade {from{transform:scale(0.5);opacity:0;} to{transform:scale(1);opacity:1;}}
            @keyframes fadeOut {from{opacity:1;}to{opacity:0;}}
        `;
        document.head.appendChild(s);
    }

    function showEmojis() {
        const list = ['üéá','üéâ','ü•á','üí´','üèÜ','üåü','ü•à','ü•â','‚ú®'];
        for (let i = 0; i < 60; i++) {
            const e = document.createElement("span");
            const em = list[Math.floor(Math.random() * list.length)];
            const size = 20 + Math.random() * 20;
            e.textContent = em;
            e.style = `position:fixed;left:${Math.random()*100}vw;top:${Math.random()*100}vh;
                       font-size:${size}px;color:hsl(${Math.random()*360},100%,60%);
                       animation:floatUpP 3s ease-out forwards;pointer-events:none;z-index:9999`;
            document.body.appendChild(e);
            setTimeout(() => e.remove(), 10000);
        }
    }

    function showPopup(index) {
        if (index >= top20.length) return;
        const learner = top20[index];
        const popup = document.createElement("div");
        popup.style = `
            position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
            background:linear-gradient(to right,#fff8dc,#ffe680);
            border:4px solid gold;padding:25px;border-radius:20px;
            font:bold 20px sans-serif;box-shadow:0 0 25px gold;
            animation:zoomInFade 1s ease;z-index:10000;text-align:center;
        `;
        popup.innerHTML = `<div>üèÖ <strong>#${index + 1} ${learner.name}</strong><br>Total Marks: ${learner.totalMarks}</div>`;
        document.body.appendChild(popup);

        let timeout = setTimeout(() => {
            popup.remove();
            showPopup(index + 1);
        }, 5000);

        popup.addEventListener("mousedown", () => clearTimeout(timeout));
        popup.addEventListener("mouseup", () => {
            timeout = setTimeout(() => {
                popup.remove();
                showPopup(index + 1);
            }, 1000);
        });
    }

    showEmojis();
    showPopup(0);
}




const filterGender = document.getElementById('filterGender');

filterGender.addEventListener('change', () => {
  const selectedGender = filterGender.value;
  const rows = tableBody.querySelectorAll('tr');

  rows.forEach(row => {
    const learnerGender = row.cells[3].textContent.trim();
    if (selectedGender === "" || learnerGender === selectedGender) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
});
document.getElementById("printGroupedByGenderButton").addEventListener("click", () => {
  const schoolName = "Your School Name";
  const year = "2025";
  const term = "Term 2";
  const selectedGender = filterGender.value;

  const learners = [];

  tableBody.querySelectorAll("tr").forEach(row => {
    const learnerGender = row.cells[3].textContent.trim();

    // If a gender is selected, skip rows not matching it
    if (selectedGender && learnerGender !== selectedGender) return;

    const learner = {
      name: row.cells[2].textContent,
      gender: learnerGender,
      grade: row.cells[4].textContent,
      age: row.cells[5].textContent,
      parentName: row.cells[6].textContent,
      phone: row.cells[7].textContent,
      birthCertificateNo: row.cells[8].textContent,
      admissionNumber: row.cells[9].textContent,
      photo: row.cells[1].querySelector("img").src
    };

    learners.push(learner);
  });

  if (learners.length === 0) {
    alert("No learners found for the selected gender.");
    return;
  }

  printLearnersByGender(schoolName, year, term, selectedGender, learners);
});
function printLearnersByGender(schoolName, year, term, gender, learners) {
  const logoUrl = "https://i.imgur.com/VSAh48K.jpeg";
  const today = new Date();
  const printDate = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;

  const tableHtml = `
    <h3 style="margin-top:30px;">${gender ? gender : "All Learners"}</h3>
    <table class="learners-table" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="border: 1px solid black;">No.</th>
          <th style="border: 1px solid black;">Photo</th>
          <th style="border: 1px solid black;">Name</th>
          <th style="border: 1px solid black;">Grade</th>
          <th style="border: 1px solid black;">Age</th>
          <th style="border: 1px solid black;">Parent Name</th>
          <th style="border: 1px solid black;">Phone</th>
          <th style="border: 1px solid black;">Birth Cert No</th>
          <th style="border: 1px solid black;">Admission No</th>
        </tr>
      </thead>
      <tbody>
        ${learners.map((l, i) => `
          <tr>
            <td style="border: 1px solid black;">${i + 1}</td>
            <td style="border: 1px solid black;"><img src="${l.photo}" alt="Photo" width="50" height="50"></td>
            <td style="border: 1px solid black;">${l.name}</td>
            <td style="border: 1px solid black;">${l.grade}</td>
            <td style="border: 1px solid black;">${l.age}</td>
            <td style="border: 1px solid black;">${l.parentName}</td>
            <td style="border: 1px solid black;">${l.phone}</td>
            <td style="border: 1px solid black;">${l.birthCertificateNo}</td>
            <td style="border: 1px solid black;">${l.admissionNumber}</td>
          </tr>`).join("")}
      </tbody>
    </table>`;

  const printWindow = window.open("", "_blank");
  printWindow.document.write(`
    <html>
      <head>
        <title>${gender ? gender : "Learners"} List</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; color: #000; }
          h2, h3 { text-align: left; margin-bottom: 5px; }
          .learners-table th, .learners-table td { border: 1px solid black; padding: 8px; text-align: center; }
          .header { margin-bottom: 20px; }
          .header img { height: 50px; vertical-align: middle; }
          .header h2 { display: inline-block; margin-left: 10px; vertical-align: middle; }
          .stamp {
            border: 2px solid blue;
            color: blue;
            width: 200px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            text-align: center;
            font-weight: bold;
            line-height: 1.2;
            font-size: 13px;
            flex-direction: column;
          }
        </style>
      </head>
      <body>
        <div class="header">
          <img src="${logoUrl}" alt="Logo">
          <h2>${schoolName}</h2>
          <p><strong>Year:</strong> ${year} &nbsp;&nbsp; <strong>Term:</strong> ${term}</p>
        </div>

        ${tableHtml}

        <div class="stamp">
          <div>NACHU JUNIOR SCHOOL</div>
          <div>P.O. Box 561-00902, Kikuyu</div>
          <div>ICT Department</div>
          <div>Date: ${printDate}</div>
        </div>
      </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.print();
}



// Populate grade dropdown from existing grades
onValue(learnersRef, (snapshot) => {
    const classListGradeSelect = document.getElementById("classListGradeSelect");
    const grades = new Set();
    snapshot.forEach(childSnapshot => {
        const data = childSnapshot.val();
        grades.add(data.grade);
    });

    classListGradeSelect.innerHTML = `<option value="">Select Grade</option>`;
    grades.forEach(grade => {
        const option = document.createElement("option");
        option.value = grade;
        option.textContent = grade;
        classListGradeSelect.appendChild(option);
    });
});

// Function to generate class list tables with print button
function generateClassList(selectedGrade) {
    onValue(learnersRef, (snapshot) => {
        const boys = [];
        const girls = [];

        snapshot.forEach(childSnapshot => {
            const learner = childSnapshot.val();
            if (learner.grade === selectedGrade) {
                if (learner.gender.toLowerCase() === "male") {
                    boys.push(learner.name);
                } else if (learner.gender.toLowerCase() === "female") {
                    girls.push(learner.name);
                }
            }
        });

        let html = `
        <h3 style="text-align:center;">Class List - ${selectedGrade}</h3>
        <button class="print-button" onclick="printClassList()">Print Class List</button>
        <div style="display: flex; gap: 30px; margin-top: 20px;">
            <div style="flex:1;">
                <h4>Boys</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead><tr><th style="border: 1px solid black; padding: 8px;">No.</th><th style="border: 1px solid black; padding: 8px;">Name</th></tr></thead>
                    <tbody>
                        ${boys.map((name, index) => `<tr><td style="border: 1px solid black; padding: 8px;">${index + 1}</td><td style="border: 1px solid black; padding: 8px;">${name}</td></tr>`).join('')}
                    </tbody>
                </table>
            </div>
            <div style="flex:1;">
                <h4>Girls</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead><tr><th style="border: 1px solid black; padding: 8px;">No.</th><th style="border: 1px solid black; padding: 8px;">Name</th></tr></thead>
                    <tbody>
                        ${girls.map((name, index) => `<tr><td style="border: 1px solid black; padding: 8px;">${index + 1}</td><td style="border: 1px solid black; padding: 8px;">${name}</td></tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>`;

        document.getElementById("classListOutput").innerHTML = html;
    });
}

window.printClassList = function() {
    const content = document.getElementById("classListOutput").innerHTML;
    const selectedGrade = document.getElementById("classListGradeSelect").value;
    const year = new Date().getFullYear();
    const today = new Date();
    const printDate = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;
    const logoUrl = "https://i.imgur.com/UW65hfv.png";

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Class List - ${selectedGrade}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; color: #000; }
                    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                    th, td { border: 1px solid black; padding: 8px; text-align: left; }
                    h3, h4 { text-align: center; margin: 5px 0; }
                    button { display: none; }
                    .header { text-align: center; margin-bottom: 20px; }
                    .header img { height: 80px; margin-bottom: 5px; }
                    .header h2, .header p { margin: 2px 0; }

                    .stamp {
                        border: 2px solid blue;
                        color: blue;
                        width: 250px;
                        padding: 12px;
                        text-align: center;
                        margin: 40px auto 0;
                        font-weight: bold;
                        line-height: 1.4;
                        font-size: 14px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                    }

                    .stamp span {
                        display: block;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <img src="${logoUrl}" alt="School Logo">
                    <h2>NACHU JUNIOR SCHOOL</h2>
                    <p>PO BOX 561-00902 KIKUYU</p>
                    <h3>Learner List</h3>
                    <h4>${selectedGrade} - ${year}</h4>
                </div>

                ${content}

                <div class="stamp">
                    <span>NACHU JUNIOR SCHOOL</span>
                    <span>P.O. Box 561-00902, Kikuyu</span>
                    <span>ICT Department</span>
                    <span>Date: ${printDate}</span>
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
};

// Button click event listener
document.getElementById("generateClassListBtn").addEventListener("click", () => {
  const selectedGrade = document.getElementById("classListGradeSelect").value;
  if (!selectedGrade) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select a grade.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  generateClassList(selectedGrade);
});

document.getElementById("generateParentsListBtn").addEventListener("click", () => {
    const selectedGrade = document.getElementById("filterGrade").value;
    if (!selectedGrade) {
        showToast("Please select a grade from the dropdown to generate the parents list.", "error");
        return;
    }


    const currentYear = new Date().getFullYear();

    // Collect learners data from the table for the selected grade
    const parents = [];
    document.querySelectorAll("#learnersList tr").forEach(row => {
        if (row.getAttribute("data-grade") === selectedGrade) {
            const learnerName = row.cells[2].textContent;
            const parentName = row.cells[6].textContent;
            const phone = row.cells[7].textContent;
            parents.push({ parentName, learnerName, phone });
        }
    });

    // Build printable table
    const tableHtml = `
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
                <tr>
                    <th style="border: 1px solid black; padding: 8px;">No.</th>
                    <th style="border: 1px solid black; padding: 8px;">Parent Name</th>
                    <th style="border: 1px solid black; padding: 8px;">Learner Name</th>
                    <th style="border: 1px solid black; padding: 8px;">Phone Number</th>
                    <th style="border: 1px solid black; padding: 8px;">Signature</th>
                </tr>
            </thead>
            <tbody>
                ${parents.map((p, i) => `
                    <tr>
                        <td style="border: 1px solid black; padding: 8px;">${i + 1}</td>
                        <td style="border: 1px solid black; padding: 8px;">${p.parentName}</td>
                        <td style="border: 1px solid black; padding: 8px;">${p.learnerName}</td>
                        <td style="border: 1px solid black; padding: 8px;">${p.phone}</td>
                        <td style="border: 1px solid black; padding: 8px;">&nbsp;</td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
    `;

    // Build printable header
    const headerHtml = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="school-logo.png" alt="School Logo" style="height: 80px; margin-bottom: 10px;"><br>
            <strong style="font-size: 22px;">NACHU PRIMARY AND JUNIOR  SCHOOL</strong><br>
            <strong style="font-size: 20px;">PARENTS ATTENDANCE REGISTER</strong><br>
            <div style="margin-top: 5px; font-size: 14px;">
                ADDRESS: PO BOX 561-00902 KIKUYU, KENYA<br>
                Phone: +254-700-123456<br>
                School Motto: <em>"MY TALENT MY PASSION"</em><br>
                Year: ${currentYear} / GRADE: <strong>${selectedGrade}</strong>
            </div>
        </div>
    `;

    // Open print window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Parents List - ${selectedGrade}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
            </style>
        </head>
        <body>
            ${headerHtml}
            ${tableHtml}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
});

document.getElementById("groupByPathwaysBtn").addEventListener("click", () => {
  const grade = document.getElementById("reportGradeSelect").value;
  const examPeriod = document.getElementById("reportExamPeriodSelect").value;

  if (!grade || grade === "Select Grade") {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select a grade.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  if (!examPeriod || examPeriod === "Select Exam Period") {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select an exam period.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  generatePathwayGrouping(grade, examPeriod);
});

function generatePathwayGrouping(selectedGrade, selectedExamPeriod) {
    const pathways = {
        STEM: ['eng', 'math', 'preTech', 'kiswahili', 'science', 'agriculture'],
        SocialSciences: ['kiswahili', 'eng', 'social', 'cre'],
        SportsScience: ['kiswahili', 'eng', 'creativeArt']
    };

    const subjectMap = {
        'eng': 3, 'math': 5, 'preTech': 7, 'kiswahili': 9,
        'science': 11, 'social': 13, 'agriculture': 15,
        'cre': 17, 'creativeArt': 19
    };

    const learners = [];
    const summary = { STEM: 0, 'Social Sciences': 0, 'Sports Science': 0 };

    marksTableBody.querySelectorAll("tr").forEach(row => {
        if (selectedGrade && row.getAttribute("data-grade") !== selectedGrade) return;
        if (selectedExamPeriod && row.getAttribute("data-exam-period") !== selectedExamPeriod) return;

        const name = row.cells[1].textContent;
        const grade = row.cells[2].textContent;

        const getScores = (keys) => keys.map(k => parseFloat(row.cells[subjectMap[k]].textContent) || 0);

        const stemScores = getScores(pathways.STEM);
        const socialScores = getScores(pathways.SocialSciences);
        const sportsScores = getScores(pathways.SportsScience);

        const avg = (scores) => (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);

        const stemAvg = avg(stemScores);
        const socialAvg = avg(socialScores);
        const sportsAvg = avg(sportsScores);

        const averages = { STEM: stemAvg, 'Social Sciences': socialAvg, 'Sports Science': sportsAvg };
        const bestPathway = Object.keys(averages).reduce((a, b) => averages[a] > averages[b] ? a : b);

        summary[bestPathway]++;

        learners.push({
            name, grade,
            stemScores, socialScores, sportsScores,
            stemAvg, socialAvg, sportsAvg,
            bestPathway
        });
    });

    const year = new Date().getFullYear();
    const now = new Date();
    const today = now.toLocaleDateString('en-KE', { year: 'numeric', month: 'long', day: 'numeric' });
    const time = now.toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit', hour12: true });
    const examinerName = "Mr......."; // You can change or make dynamic later

    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="  https://i.imgur.com/VSAh48K.jpeg"" alt="School Logo" style="display: block; margin: 0 auto 10px; width: 80px; height: 80px;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL PATHWAY REPORT</h2>
            <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p style="margin: 5px 0;">Phone: +254-700-123456</p>
            <p style="margin: 5px 0;">School Motto: "Excellence Through Knowledge"</p>
            <p style="margin: 5px 0;">Year: ${year}</p>
            <p style="margin: 5px 0;">Grade: ${selectedGrade || 'All'} | Period: ${selectedExamPeriod || 'All'}</p>
        </div>`;

    html += `<h3 style="text-align:center;">Career Pathway Report - Grade ${selectedGrade || 'All'}</h3>`;
    html += `<table style="width:100%; border-collapse: collapse; margin-top:10px;">
        <thead>
            <tr>
                <th style="border:1px solid #000; padding:6px;">No.</th>
                <th style="border:1px solid #000; padding:6px;">Name</th>
                <th style="border:1px solid #000; padding:6px;">Grade</th>
                <th style="border:1px solid #000; padding:6px;">ENG</th>
                <th style="border:1px solid #000; padding:6px;">MATH</th>
                <th style="border:1px solid #000; padding:6px;">PRETECH</th>
                <th style="border:1px solid #000; padding:6px;">KISW</th>
                <th style="border:1px solid #000; padding:6px;">SCIE</th>
                <th style="border:1px solid #000; padding:6px;">AGRIC</th>
                <th style="border:1px solid #000; padding:6px; background:#fff8c6;">STEM Avg</th>
                <th style="border:1px solid #000; padding:6px;">KISWA</th>
                <th style="border:1px solid #000; padding:6px;">ENG</th>
                <th style="border:1px solid #000; padding:6px;">SST</th>
                <th style="border:1px solid #000; padding:6px;">CRE</th>
                <th style="border:1px solid #000; padding:6px; background:#fff8c6;">Social Avg</th>
                <th style="border:1px solid #000; padding:6px;">KISWA</th>
                <th style="border:1px solid #000; padding:6px;">ENG</th>
                <th style="border:1px solid #000; padding:6px;">C/A</th>
                <th style="border:1px solid #000; padding:6px; background:#fff8c6;">Sports Avg</th>
                <th style="border:1px solid #000; padding:6px; background:#fff8c6;">Best Pathway</th>
            </tr>
        </thead><tbody>`;

    learners.forEach((learner, i) => {
        html += `<tr>
            <td style="border:1px solid #000; padding:6px;">${i + 1}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.name}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.grade}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.stemScores[0]}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.stemScores[1]}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.stemScores[2]}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.stemScores[3]}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.stemScores[4]}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.stemScores[5]}</td>
            <td style="border:1px solid #000; padding:6px; background:#fff8c6;">${learner.stemAvg}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.socialScores[0]}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.socialScores[1]}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.socialScores[2]}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.socialScores[3]}</td>
            <td style="border:1px solid #000; padding:6px; background:#fff8c6;">${learner.socialAvg}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.sportsScores[0]}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.sportsScores[1]}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.sportsScores[2]}</td>
            <td style="border:1px solid #000; padding:6px; background:#fff8c6;">${learner.sportsAvg}</td>
            <td style="border:1px solid #000; padding:6px; background:#fff8c6;">${learner.bestPathway}</td>
        </tr>`;
    });

    html += `</tbody></table>`;

    html += `<h4 style="margin-top:20px;">Pathway Summary</h4>`;
    html += `<table style="width:50%; border-collapse: collapse; margin-top:5px;">
        <thead>
            <tr>
                <th style="border:1px solid #000; padding:6px;">Pathway</th>
                <th style="border:1px solid #000; padding:6px;">Number of Learners</th>
            </tr>
        </thead>
        <tbody>
            <tr><td style="border:1px solid #000; padding:6px;">STEM</td><td style="border:1px solid #000; padding:6px;">${summary.STEM}</td></tr>
            <tr><td style="border:1px solid #000; padding:6px;">Social Sciences</td><td style="border:1px solid #000; padding:6px;">${summary['Social Sciences']}</td></tr>
            <tr><td style="border:1px solid #000; padding:6px;">Sports Science</td><td style="border:1px solid #000; padding:6px;">${summary['Sports Science']}</td></tr>
        </tbody>
    </table>`;
html += `<div class="stamp print-only">
    Nachu Junior School<br>
    P.O. Box 561-00902<br>
    Kikuyu...Exam Department<br>
    Examiner: ${examinerName}<br>
    Date: ${today}<br>
    Time: ${time}
</div>`;


    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = html;

    let printButton = document.getElementById("printPathwayGroupingBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printPathwayGroupingBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Pathway Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            table, th, td { border: 1px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; }
                            img { max-width: 100px; }
                            .print-only { display: none; }
                            @media print {
                                .print-only {
                                    display: flex;
                                    border: 2px solid blue;
                                    color: blue;
                                    width: 220px;
                                    height: auto;
                                    align-items: center;
                                    justify-content: center;
                                    margin: 30px auto 0 auto;
                                    text-align: center;
                                    font-weight: bold;
                                    flex-direction: column;
                                    padding: 8px;
                                    font-size: 14px;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}


document.addEventListener("DOMContentLoaded", function () {
  // Hide both sections on page load
  document.getElementById("classListSection").style.display = "none";
  document.getElementById("recordMarksSection").style.display = "none";
  document.getElementById("performanceReportsSection").style.display = "none";

  // Toggle Class List Section
  document.getElementById("toggleClassListSectionBtn").addEventListener("click", () => {
    const section = document.getElementById("classListSection");
    section.style.display = section.style.display === "none" ? "block" : "none";
  });

  // Toggle Record Marks Section
  document.getElementById("toggleMarksSectionBtn").addEventListener("click", () => {
    const section = document.getElementById("recordMarksSection");
    section.style.display = section.style.display === "none" ? "block" : "none";
  });

  // Toggle Performance Reports Section
  document.getElementById("togglePerformanceReportsBtn").addEventListener("click", () => {
    const section = document.getElementById("performanceReportsSection");
    const icon = document.querySelector("#togglePerformanceReportsBtn i");

    const isHidden = section.style.display === "none";
    section.style.display = isHidden ? "block" : "none";

    // Toggle icon between down and up chevron
    icon.className = isHidden ? "fas fa-chevron-up" : "fas fa-chevron-down";
  });
  
  // Marks Section Toggle with icon update
  const toggleMarksBtn = document.getElementById("toggleMarksSectionBtn");
  const marksSection = document.getElementById("marksSection");
  const icon = toggleMarksBtn.querySelector("i");

  toggleMarksBtn.addEventListener("click", () => {
    const isHidden = marksSection.style.display === "none";
    
    // Toggle display style
    marksSection.style.display = isHidden ? "block" : "none";
    
    // Toggle icon between down and up chevron
    icon.classList.toggle("fa-chevron-down", !isHidden);
    icon.classList.toggle("fa-chevron-up", isHidden);
  });
});
const toggleBtn = document.getElementById('toggleFormBtn');
  const formContainer = document.getElementById('registrationContainer');

  toggleBtn.addEventListener('click', () => {
    const isHidden = formContainer.style.display === 'none';
    // toggle visibility
    formContainer.style.display = isHidden ? 'block' : 'none';
    // update button text
    toggleBtn.textContent = isHidden ? ' Registration ' : ' Registration';
  });
const toggleTableBtn = document.getElementById('toggleTableBtn');
  const tableContainer  = document.getElementById('tableContainer');

  toggleTableBtn.addEventListener('click', () => {
    const hidden = tableContainer.style.display === 'none';
    tableContainer.style.display = hidden ? 'block' : 'none';
    toggleTableBtn.textContent = hidden
      ? ' Registered Learners'
      : 'Registered Learners';
  });
const masterBtn = document.getElementById('masterToggleBtn');
const wrapper = document.getElementById('learnersButtons');
const otherWrapper = document.getElementById('reportsControls');
const otherBtn = document.getElementById('masterReportsBtn');

// Toggle for Learners Database
masterBtn.addEventListener('click', () => {
  const hidden = wrapper.style.display === 'none';

  // Toggle this one
  wrapper.style.display = hidden ? 'block' : 'none';
  masterBtn.textContent = hidden ? ' Learners Database' : 'Learners Database';
  masterBtn.insertAdjacentHTML(
    'afterbegin',
    '<i class="fas fa-database" style="margin-right: 8px; font-size: 1.2em;"></i>'
  );

  // Hide the other one
  otherWrapper.style.display = 'none';
  const otherLabel = otherBtn.querySelector('.btn-label');
  if (otherLabel) otherLabel.textContent = 'Exam & Marks Controls';
});

/**
 * Sets up a show/hide toggle.
 * @param {string} masterBtnId   ID of the toggle button
 * @param {string} wrapperId   ID of the element to show/hide
 * @param {string} showText   Text to show when collapsed
 * @param {string} hideText   Text to show when expanded
 */
function setupToggle(masterBtnId, wrapperId, showText, hideText) {
  const btn = document.getElementById(masterBtnId);
  const wrapper = document.getElementById(wrapperId);
  const label = btn.querySelector('.btn-label');

  // Ensure wrapper starts hidden
  wrapper.style.display = wrapper.style.display || 'none';

  btn.addEventListener('click', () => {
    const isHidden = wrapper.style.display === 'none';
    // Toggle visibility
    wrapper.style.display = isHidden ? 'block' : 'none';
    label.textContent = isHidden ? hideText : showText;

    // Also hide the other section if open
    if (wrapperId === 'reportsControls') {
      document.getElementById('learnersButtons').style.display = 'none';
      document.getElementById('masterToggleBtn').textContent = ' Learners Database';
      document.getElementById('masterToggleBtn').insertAdjacentHTML(
        'afterbegin',
        '<i class="fas fa-database" style="margin-right: 8px; font-size: 1.2em;"></i>'
      );
    }
  });
}

// Wire up your Reports controls
setupToggle(
  'masterReportsBtn',
  'reportsControls',
  'Exam & Marks Controls',
  'Hide Exam & Marks Controls'
);
// Default login values
let validUsername = "Nachu";
let validPassword = "1";

document.getElementById("loginForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const user = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();

  if (user === validUsername && pass === validPassword) {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    
    // ‚úÖ Clear the error if shown
    document.getElementById("loginError").style.display = "none";

    // ‚úÖ Success message
    if (typeof Swal !== "undefined") {
      Swal.fire({
        title: "Login Successful",
        text: "Welcome, Nachu!",
        icon: "success",
        confirmButtonText: "Continue"
      }).then(() => {
        // üéÑ Holiday popup after user clicks "Continue"
        Swal.fire({
          title: "üéâ Happy December Holidays!",
          text: "RASM wishes you joy, peace, and success this festive season!",
          icon: "info",
          background: "#fffbe6",
          color: "#333",
          confirmButtonText: "Thank You!",
          confirmButtonColor: "#3085d6"
        });
      });
    }
  } else {
    document.getElementById("loginError").style.display = "block";
  }
});
document.getElementById("printFilteredMarksBtn").addEventListener("click", () => {
  const visibleRows = Array.from(document.querySelectorAll("#marksList tr"))
    .filter(row => row.style.display !== "none");

  if (visibleRows.length === 0) {
    const alertBox = document.createElement("div");
    alertBox.innerHTML = "No marks to print. Please adjust your filters.";
    alertBox.style.position = "fixed";
    alertBox.style.top = "20px";
    alertBox.style.right = "20px";
    alertBox.style.backgroundColor = "#ffcccb";
    alertBox.style.color = "#b71c1c";
    alertBox.style.padding = "15px";
    alertBox.style.border = "1px solid #b71c1c";
    alertBox.style.borderRadius = "8px";
    alertBox.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
    alertBox.style.fontFamily = "Arial, sans-serif";
    alertBox.style.fontSize = "16px";
    alertBox.style.zIndex = "1000";

    document.body.appendChild(alertBox);

    setTimeout(() => {
      document.body.removeChild(alertBox);
    }, 5000);
    return;
  }

  const selectedGrade = document.getElementById("filterMarksGrade").value || "All";
  const year = new Date().getFullYear();
  const term = document.getElementById("term")?.value || "Term 2";

  // Extract row data excluding Delete button
  let totalMarksSum = 0;
  let totalLevelsSum = 0;

  const scoreColumns = [3, 5, 7, 9, 11, 13, 15, 17, 19]; // Score indices
  const totals = Array(scoreColumns.length).fill(0);

  const cleanedRows = visibleRows.map(row => {
    const cells = Array.from(row.cells);
    const filteredCells = cells.slice(0, cells.length - 1); // exclude delete btn

    // Extract and sum marks
    let rowTotal = 0;
    scoreColumns.forEach((index, i) => {
      const mark = parseFloat(cells[index].innerText) || 0;
      totals[i] += mark;
      rowTotal += mark;
    });
    totalMarksSum += rowTotal;

    // Extract and sum total level from 2nd-last cell (before delete btn)
    const totalLevel = parseInt(cells[cells.length - 2]?.innerText) || 0;
    totalLevelsSum += totalLevel;

    return `<tr>${filteredCells.map(cell => `<td>${cell.innerHTML}</td>`).join("")}</tr>`;
  });

  const learnerCount = visibleRows.length;

  const totalsRow = `
    <tr>
      <td colspan="3">Total</td>
      ${scoreColumns.map((_, i) => `<td>${totals[i]}</td><td></td>`).join("")}
      <td>${totalMarksSum}</td>
      <td>${totalLevelsSum}</td>
    </tr>`;

  const averagesRow = `
    <tr>
      <td colspan="3">Average</td>
      ${scoreColumns.map((_, i) => `<td>${(totals[i] / learnerCount).toFixed(2)}</td><td></td>`).join("")}
      <td>${(totalMarksSum / learnerCount).toFixed(2)}</td>
      <td>${(totalLevelsSum / learnerCount).toFixed(2)}</td>
    </tr>`;

  const tableHtml = `
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th>Grade</th>
          <th>Eng</th><th>Lev</th>
          <th>Math</th><th>Lev</th>
          <th>Pre-Tech</th><th>Lev</th>
          <th>Kisw</th><th>Lev</th>
          <th>Scie</th><th>Lev</th>
          <th>Sst</th><th>Lev</th>
          <th>Agric</th><th>Lev</th>
          <th>Cre</th><th>Lev</th>
          <th>C/A</th><th>Lev</th>
          <th>Total Marks</th>
          <th>Points</th>
        </tr>
      </thead>
      <tbody>
        ${cleanedRows.join("")}
        ${totalsRow}
        ${averagesRow}
      </tbody>
    </table>
  `;

const printWindow = window.open('', '_blank');
printWindow.document.write(`
  <html>
    <head>
      <title>Filtered Marks Report</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 16px; }
        th, td {
          border: 2px solid black;
          padding: 6px;
          text-align: center;
        }
        th {
          background-color: #f0f0f0;
          font-weight: bold;
        }
        .header-container {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        }
        .school-info {
          text-align: left;
        }
        .school-logo img {
          max-width: 100px;
          height: auto;
        }
      </style>
    </head>
    <body>
      <div class="header-container">
        <div class="school-info">
          <h2 style="margin: 0;">NACHU JUNIOR SCHOOL</h2>
          <p style="margin: 0;"><em>My Talent My Passion</em></p>
          <p style="margin: 5px 0 0 0;">
            <strong>Term:</strong> ${term} &nbsp;&nbsp;
            <strong>Grade:</strong> ${selectedGrade} &nbsp;&nbsp;
            <strong>Year:</strong> ${year}
          </p>
        </div>
        <div class="school-logo">
          <img src="https://i.imgur.com/VSAh48K.jpeg" alt="School Logo">
        </div>
      </div>
      ${tableHtml}
    </body>
  </html>
`);
printWindow.document.close();
printWindow.print();

});
function printAssessmentReport() {
    const reportContainer = document.getElementById("assessmentReportsContainer");

    if (!reportContainer || !reportContainer.innerHTML.trim()) {
        showToast("No assessment report available to print.", "error");
        return;
    }

    const reports = reportContainer.querySelectorAll(".single-report");
    const printWindow = window.open("", "_blank");
    const printedDate = "26/07/2025";

    let allReportsHTML = "";

    if (reports.length > 0) {
        reports.forEach(report => {
            allReportsHTML += `
                <div class="report-wrapper">
                    <div class="report-content">
                        ${report.innerHTML}
                    </div>
                    <div class="footer-section">
                        Printed on: ${printedDate} ‚Ä¢ End of Report<br>
                        <span class="generated-by">Generated by Rasmtech</span>
                    </div>
                </div>
            `;
        });
    } else {
        allReportsHTML = `
            <div class="report-wrapper">
                <div class="report-content">
                    ${reportContainer.innerHTML}
                </div>
                <div class="footer-section">
                    Printed on: ${printedDate} ‚Ä¢ End of Report<br>
                    <span class="generated-by">Generated by Rasmtech</span>
                </div>
            </div>
        `;
    }

    printWindow.document.write(`
        <html>
        <head>
            <title>Assessment Reports</title>
            <style>
                @page {
                    size: A4 portrait;
                    margin: 10mm;
                }
                html, body {
                    margin: 0;
                    padding: 0;
                    font-family: Arial, sans-serif;
                    font-size: 13px;
                    color: #333;
                }
                .report-container {
                    display: block;
                    width: 100%;
                }
                .report-wrapper {
                    page-break-inside: avoid;
                    break-inside: avoid;
                    margin-bottom: 20px;
                    padding: 10px;
                    border: 1px solid #ddd;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 10px;
                }
                th, td {
                    border: 1px solid #000;
                    padding: 6px;
                    text-align: center;
                    vertical-align: middle;
                }
                th {
                    background-color: #007bff;
                    color: white;
                }
                td {
                    background-color: #f9f9f9;
                }
                .footer-section {
                    margin-top: 12px;
                    text-align: center;
                    font-size: 12px;
                    page-break-inside: avoid;
                }
                .generated-by {
                    font-style: italic;
                    color: #555;
                }
            </style>
        </head>
        <body>
            <div class="report-container">
                ${allReportsHTML}
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.onload = () => {
        printWindow.focus();
        printWindow.print();
    };
}


// Attach event listener to the print button
document.getElementById("printAssessmentReportBtn").addEventListener("click", printAssessmentReport);
function toggleSpinner(show) {
    document.getElementById("spinner").style.display = show ? "block" : "none";
}
// Function to show a custom alert
function showCustomAlert(message, backgroundColor, textColor) {
    // Check if an alert already exists and remove it
    let existingAlert = document.getElementById("custom-alert");
    if (existingAlert) existingAlert.remove();

    // Create a new alert div
    const alertDiv = document.createElement("div");
    alertDiv.id = "custom-alert";
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: ${backgroundColor};
        color: ${textColor};
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        font-size: 16px;
        z-index: 1000;
    `;
    alertDiv.textContent = message;

    // Append the alert to the body
    document.body.appendChild(alertDiv);

    // Automatically remove the alert after 3 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// Function to validate the score format and enforce rules
function validateScoreFormat(input) {
    const value = input.value.trim(); // Get the trimmed value
    const integerRegex = /^(?:[1-9][0-9]?|100)$/; // Match integers 1-100 without leading zeros

    if (!integerRegex.test(value)) {
        // Show a custom alert with colors
        showCustomAlert(
            " Invalid score! Please enter a whole number between 1 and 100 without leading zeros or decimals.",
            "#f8d7da", // Light red background
            "#721c24"  // Dark red text
        );
        input.value = ""; // Clear the invalid input
        input.focus(); // Refocus the input field
    }
}

// Attach the validation function to all input fields for marks
document.querySelectorAll('#marksInputs input[type="number"]').forEach(input => {
    // Validate when the user leaves the input field
    input.addEventListener('blur', () => validateScoreFormat(input));
});

function countMarksStatusPerGrade() {
  if (!isAdminLoggedIn) {
    Swal.fire("Access Denied", "Only the admin can view this report.", "error");
    return;
  }

  const selectedGrade = document.getElementById('filterMarksGrade').value.trim();
  const selectedPeriod = document.getElementById('marksExamPeriodSelect').value.trim();

  if (!selectedGrade || !selectedPeriod || selectedGrade.toLowerCase().includes("select") || selectedPeriod.toLowerCase().includes("select")) {
    Swal.fire("Missing Filters", "Please select both grade and exam period to view summary.", "warning");
    return;
  }

  const gradeCounts = {
    [selectedGrade]: {
      recorded: 0,
      notRecorded: 0,
      notRecordedNames: []
    }
  };

  onValue(learnersRef, (snapshot) => {
    snapshot.forEach(childSnapshot => {
      const learner = childSnapshot.val();
      const grade = learner.grade?.trim();
      const name = learner.name || "Unknown";
      const marks = learner.marks || {};

      if (grade !== selectedGrade) return;

      const hasMarksForPeriod = marks.hasOwnProperty(selectedPeriod);

      if (hasMarksForPeriod) {
        gradeCounts[selectedGrade].recorded++;
      } else {
        gradeCounts[selectedGrade].notRecorded++;
        gradeCounts[selectedGrade].notRecordedNames.push(name);
      }
    });

    const counts = gradeCounts[selectedGrade];
    const total = counts.recorded + counts.notRecorded;
    const remarks = counts.notRecorded === 0
      ? "All marks recorded"
      : counts.recorded === 0
        ? "No marks recorded"
        : "Partial marks recorded";

    const learnersWithNoMarks = counts.notRecordedNames.join(", ") || "None";

    let html = `
      <h3 style="color: black;">Marks Recording Summary for ${selectedGrade} (${selectedPeriod})</h3>
      <table id="marksSummaryTable" style="width: 100%; border-collapse: collapse; margin-top: 10px; color: black;">
        <thead>
          <tr style="background-color: #007bff; color: white;">
            <th style="border: 3px solid black; padding: 8px;">No</th>
            <th style="border: 3px solid black; padding: 8px;">Grade</th>
            <th style="border: 3px solid black; padding: 8px;">Number of Learners</th>
            <th style="border: 3px solid black; padding: 8px;">Recorded Marks</th>
            <th style="border: 3px solid black; padding: 8px;">Not Recorded</th>
            <th style="border: 3px solid black; padding: 8px;">Learners with No Marks</th>
            <th style="border: 3px solid black; padding: 8px;">Remarks</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border: 3px solid black; padding: 8px; text-align: center;">1</td>
            <td style="border: 3px solid black; padding: 8px; text-align: center;">${selectedGrade}</td>
            <td style="border: 3px solid black; padding: 8px; text-align: center;">${total}</td>
            <td style="border: 3px solid black; padding: 8px; text-align: center;">${counts.recorded}</td>
            <td style="border: 3px solid black; padding: 8px; text-align: center;">${counts.notRecorded}</td>
            <td style="border: 3px solid black; padding: 8px; text-align: center;">${learnersWithNoMarks}</td>
            <td style="border: 3px solid black; padding: 8px; text-align: center;">${remarks}</td>
          </tr>
        </tbody>
      </table>
      <button id="printMarksSummaryBtn" style="margin-top: 15px; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
        <i class="fas fa-print"></i> Print Report
      </button>
    `;

    const container = document.getElementById("marksStatusSummary");
    container.innerHTML = html;

    document.getElementById("printMarksSummaryBtn").addEventListener("click", () => {
      const logoUrl = "https://i.imgur.com/VSAh48K.jpeg";
      const year = new Date().getFullYear();
      const tableHTML = document.getElementById("marksSummaryTable").outerHTML;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
        <head>
          <title>NACHU JUNIOR SCHOOL MARKS CAPTURE Report</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; color: black; }
            h2, p { text-align: center; margin: 5px 0; color: black; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; color: black; }
            th, td { border: 3px solid black; padding: 8px; text-align: center; color: black; }
            th { background-color: #007bff; color: white; }
            img.logo { display: block; margin: 0 auto 15px; width: 100px; }
            .stamp {
              border: 2px solid blue;
              color: blue;
              text-align: center;
              width: 200px;
              height: 70px;
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 10px auto;
              font-weight: bold;
            }
          </style>
        </head>
        <body>
          <img src="${logoUrl}" alt="School Logo" class="logo">
          <h2>NACHU JUNIOR SCHOOL MARKS CAPTURE Report</h2>
          <p>ADDRESS: P.O. BOX 561-00902 Kikuyu KENYA</p>
          <p>School Motto: "My Talent My Passion"</p>
          <p>Year: ${year}</p>
          ${tableHTML}
          <div class="stamp">
            Nachu Junior School<br>
            Po Box 561-00902<br>
            Kikuyu...Exam Department
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    });
  });
}

document.getElementById("showMarksStatusBtn").addEventListener("click", () => {
  if (!isAdminLoggedIn) {
    Swal.fire("Access Denied", "Only the admin can view the marks recording status.", "error");
    return;
  }

  const summaryDiv = document.getElementById("marksStatusSummary");
  const toggleButton = document.getElementById("showMarksStatusBtn");
  const toggleIcon = document.getElementById("toggleIcon");

  const selectedGrade = document.getElementById('filterMarksGrade').value.trim();
  const selectedPeriod = document.getElementById('marksExamPeriodSelect').value.trim();

  const invalidGrade = !selectedGrade || selectedGrade.toLowerCase().includes("select");
  const invalidPeriod = !selectedPeriod || selectedPeriod.toLowerCase().includes("select");

  if (invalidGrade || invalidPeriod) {
    Swal.fire("Missing Filters", "Please select both grade and exam period to view the summary.", "warning");
    return;
  }

  if (summaryDiv.style.display === "none" || !summaryDiv.style.display) {
    countMarksStatusPerGrade();
    summaryDiv.style.display = "block";
    toggleButton.textContent = " Hide Marks Recording Status Per Grade";
    toggleButton.prepend(toggleIcon);
    toggleIcon.className = "fas fa-eye-slash";
  } else {
    summaryDiv.style.display = "none";
    toggleButton.textContent = " Show Marks Recording Status Per Grade";
    toggleButton.prepend(toggleIcon);
    toggleIcon.className = "fas fa-eye";
  }
});


// Populate grade dropdown from registered learners in Firebase
function populateMeritGradeSelect() {
    const gradeDropdown = document.getElementById("meritGradeSelect");
    const gradesSet = new Set();

    onValue(learnersRef, (snapshot) => {
        snapshot.forEach(child => {
            const learner = child.val();
            if (learner.grade) {
                gradesSet.add(learner.grade.trim());
            }
        });

        gradeDropdown.innerHTML = '<option value="">Select Grade</option>';
        Array.from(gradesSet).sort().forEach(grade => {
            const option = document.createElement("option");
            option.value = grade;
            option.textContent = grade;
            gradeDropdown.appendChild(option);
        });
    }, { onlyOnce: true });
}

// Run once when page loads
window.addEventListener('load', populateMeritGradeSelect);

// Updated event listener to use new dropdown
document.getElementById("generateBlankMeritBtn").addEventListener("click", () => {
    const selectedGrade = document.getElementById("meritGradeSelect").value;

    if (!selectedGrade) {
        showCustomAlert("Please select a grade first.");
        return;
    }

    onValue(learnersRef, (snapshot) => {
        generateBlankMeritLists(snapshot, selectedGrade);
    }, { onlyOnce: true });
});
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("generateBlankMeritBtn");
    if (btn) {
        btn.addEventListener("click", () => {
            const selectedGrade = document.getElementById("reportGradeSelect").value; // ‚úÖ correct ID

            if (!selectedGrade) {
                showCustomAlert("Please select a grade first.");
                return;
            }

            onValue(learnersRef, (snapshot) => {
                generateBlankMeritLists(snapshot, selectedGrade);
            }, { onlyOnce: true });
        });
    }
});

function generateBlankMeritLists(learnersSnapshot, selectedGrade) {
    const container = document.createElement("div");
    container.style.marginTop = "20px";
    container.id = "blankMeritOutput";

    const learners = [];

    learnersSnapshot.forEach(childSnapshot => {
        const learner = childSnapshot.val();
        if (learner.grade === selectedGrade) {
            learners.push(learner);
        }
    });

    if (learners.length === 0) {
        container.innerHTML = `<h2>Blank Merit List for Grade ${selectedGrade}</h2><p>No learners found.</p>`;
        document.getElementById("reportOutput").innerHTML = "";
        document.getElementById("reportOutput").appendChild(container);
        return;
    }

    const term = "Term ";
    const year = new Date().getFullYear();
    const schoolName = "NACHU JUNIOR SCHOOL";
    const logoUrl = "https://i.imgur.com/VSAh48K.jpeg";

    // Print Button
    const printButton = document.createElement("button");
    printButton.className = "print-button";
    printButton.style.marginBottom = "10px";
    printButton.style.float = "right";
    printButton.innerHTML = `<i class="fas fa-print"></i> Print Merit List`;
    printButton.onclick = () => {
        const tableHTML = container.querySelector("table").outerHTML;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Blank Merit List - ${selectedGrade}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
                        img { width: 80px; height: auto; margin-bottom: 10px; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                        caption { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                        .header-section p { margin: 4px 0; }
                    </style>
                </head>
                <body>
                    <img src="${logoUrl}" alt="School Logo">
                    <div class="header-section">
                        <h2>${schoolName}</h2>
                        <p><strong>Grade:</strong> ${selectedGrade}</p>
                        <p><strong>Term:</strong> ${term} &nbsp;&nbsp;&nbsp;&nbsp; <strong>Year:</strong> ${year}</p>
                    </div>
                    ${tableHTML}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    };
    container.appendChild(printButton);

    // Subjects
    const subjects = [
        'Eng', 'Math', 'Pre-Tech', 'Kisw', 'Scie',
        'Sst', 'Agric', 'Cre', 'C/A'
    ];

    const table = document.createElement("table");

    // Header row: Subject and generic 'Level' column beside it
    const headerRow = `<tr>
        <th>No.</th>
        <th>Name</th>
        ${subjects.map(subject => `<th>${subject}</th><th>Level</th>`).join('')}
    </tr>`;

    // Data Rows
    const bodyRows = learners.map((learner, index) => `
        <tr>
            <td>${index + 1}</td>
            <td>${learner.name}</td>
            ${subjects.map(() => `<td></td><td></td>`).join('')}
        </tr>
    `).join('');

    table.innerHTML = `
        <caption>Grade ${selectedGrade} - Blank Merit List</caption>
        <thead>
            ${headerRow}
        </thead>
        <tbody>
            ${bodyRows}
        </tbody>
    `;

    container.appendChild(table);

    document.getElementById("reportOutput").innerHTML = "";
    document.getElementById("reportOutput").appendChild(container);
}
document.getElementById("generateSubjectRankBtn").addEventListener("click", () => {
  const selectedGrade = document.getElementById("reportGradeSelect").value;
  const selectedPeriod = document.getElementById("reportExamPeriodSelect").value;
  const selectedSubject = document.getElementById("rankingSubjectSelect").value;

  if (!selectedGrade || !selectedPeriod || !selectedSubject) {
    showToast("Please select a grade, exam period, and subject.", "error");
    return;
  }

  generateSubjectRanking(selectedGrade, selectedSubject, selectedPeriod);
});
function generateSubjectRanking(grade, subjectKey, period) {
  const subjectNames = {
    eng: "English",
    math: "Mathematics",
    preTech: "Pre-Technical Studies",
    kiswahili: "Kiswahili",
    science: "Integrated Science",
    social: "Social Studies",
    agriculture: "Agriculture",
    cre: "Religious Education",
    creativeArt: "Creative Art"
  };

  function getLevel(score) {
    if (score >= 90) return "EE 1";
    if (score >= 75) return "EE 2";
    if (score >= 58) return "ME 1";
    if (score >= 41) return "ME 2";
    if (score >= 31) return "AE 1";
    if (score >= 21) return "AE 2";
    if (score >= 11) return "BE 1";
    return "BE 2";
  }

  const learners = [];

  document.querySelectorAll("#marksList tr").forEach(row => {
    if (row.getAttribute("data-grade") !== grade) return;
    if (row.getAttribute("data-exam-period") !== period) return;

    const learnerName = row.cells[1].textContent;
    const subjectColIndex = {
      eng: 3, math: 5, preTech: 7, kiswahili: 9, science: 11,
      social: 13, agriculture: 15, cre: 17, creativeArt: 19
    }[subjectKey];

    const score = parseFloat(row.cells[subjectColIndex].textContent) || 0;
    const level = getLevel(score);
    learners.push({ name: learnerName, score, level });
  });

  learners.sort((a, b) => b.score - a.score);

  const year = new Date().getFullYear();

  let html = `
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="https://i.imgur.com/VSAh48K.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px; height: auto;">
      <h2 style="margin: 0;">NACHU JUNIOR SCHOOL SUBJECT PERFORMANCE REPORT</h2>
      <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
      <p style="margin: 5px 0;">School Motto: "My Talent My Passion"</p>
      <p style="margin: 5px 0;">Year: ${year}</p>
      <p style="margin: 5px 0;">Grade: ${grade}</p>
      <p style="margin: 5px 0;">Exam Period: ${period}</p>
    </div>

    <table style="width:100%; border-collapse: collapse; margin-top: 15px; background-color: white; color: black; font-size: 16px;">
      <thead>
        <tr style="background: #f2f2f2;">
          <th style="border: 1px solid black; padding: 10px;">Rank</th>
          <th style="border: 1px solid black; padding: 10px;">Name</th>
          <th style="border: 1px solid black; padding: 10px;">Score</th>
          <th style="border: 1px solid black; padding: 10px;">Performance Level</th>
        </tr>
      </thead>
      <tbody>`;

  learners.forEach((learner, index) => {
    html += `
      <tr>
        <td style="border: 1px solid black; padding: 10px;">${index + 1}</td>
        <td style="border: 1px solid black; padding: 10px;">${learner.name}</td>
        <td style="border: 1px solid black; padding: 10px;">${learner.score}</td>
        <td style="border: 1px solid black; padding: 10px;">${learner.level}</td>
      </tr>`;
  });

  html += `
      </tbody>
    </table>

    <div style="text-align:right; margin-top: 20px;">
      <button id="printRankingReportBtn" style="padding: 8px 16px; background: #007BFF; color: #fff; border: none; border-radius: 4px;">Print Report</button>
    </div>`;

  document.getElementById("reportOutput").innerHTML = html;

  // Print logic
  document.getElementById("printRankingReportBtn").addEventListener("click", () => {
    const content = document.getElementById("reportOutput").innerHTML;
    const printWindow = window.open("", "_blank", "width=900,height=650");
    printWindow.document.write(`
      <html>
        <head>
          <title>Subject Ranking Report</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid black; padding: 8px; }
            th { background-color: #f4f4f4; }
            button { display: none; }
            img { max-width: 100px; }
          </style>
        </head>
        <body>${content}</body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  });
}



document.getElementById("loadMarksByPeriodBtn").addEventListener("click", () => {
  const selectedExamPeriod = document.getElementById("marksExamPeriodSelect").value;
  if (!selectedExamPeriod) {
    showToast("Please select an exam period to view marks.", "error");
    return;
  }
  loadMarksTableForPeriod(selectedExamPeriod);
});
function loadMarksTableForPeriod(examPeriod) {
  marksTableBody.innerHTML = "";
  const gradeGroups = {};

  let sums = {
    eng: 0, math: 0, preTech: 0, kiswahili: 0,
    science: 0, social: 0, agriculture: 0,
    cre: 0, creativeArt: 0, totalMarks: 0, totalLevels: 0
  };

  let learnersWithMarks = 0;

  onValue(learnersRef, (snapshot) => {
    marksTableBody.innerHTML = "";

    snapshot.forEach(childSnapshot => {
      const data = childSnapshot.val();
      const marksData = data.marks || {};
      const marks = marksData[examPeriod] || null;

      if (marks) {
        const rowTotal =
          (parseFloat(marks.eng) || 0) +
          (parseFloat(marks.math) || 0) +
          (parseFloat(marks.preTech) || 0) +
          (parseFloat(marks.kiswahili) || 0) +
          (parseFloat(marks.science) || 0) +
          (parseFloat(marks.social) || 0) +
          (parseFloat(marks.agriculture) || 0) +
          (parseFloat(marks.cre) || 0) +
          (parseFloat(marks.creativeArt) || 0);

        const totalLevel =
          (parseInt(marks.engLev) || 0) +
          (parseInt(marks.mathLev) || 0) +
          (parseInt(marks.preTechLev) || 0) +
          (parseInt(marks.kiswahiliLev) || 0) +
          (parseInt(marks.scienceLev) || 0) +
          (parseInt(marks.socialLev) || 0) +
          (parseInt(marks.agricultureLev) || 0) +
          (parseInt(marks.creLev) || 0) +
          (parseInt(marks.creativeArtLev) || 0);

        const learnerObj = {
          key: childSnapshot.key,
          data,
          marks,
          rowTotal,
          totalLevel
        };

        const grade = data.grade;
        if (!gradeGroups[grade]) {
          gradeGroups[grade] = [];
        }
        gradeGroups[grade].push(learnerObj);
      }
    });

    Object.keys(gradeGroups).forEach(grade => {
      const learners = gradeGroups[grade];
      learners.sort((a, b) => b.rowTotal - a.rowTotal);

      learners.forEach((learner, i) => {
        learnersWithMarks++;

        const { data, marks, rowTotal, totalLevel } = learner;

        sums.eng += (parseFloat(marks.eng) || 0);
        sums.math += (parseFloat(marks.math) || 0);
        sums.preTech += (parseFloat(marks.preTech) || 0);
        sums.kiswahili += (parseFloat(marks.kiswahili) || 0);
        sums.science += (parseFloat(marks.science) || 0);
        sums.social += (parseFloat(marks.social) || 0);
        sums.agriculture += (parseFloat(marks.agriculture) || 0);
        sums.cre += (parseFloat(marks.cre) || 0);
        sums.creativeArt += (parseFloat(marks.creativeArt) || 0);
        sums.totalMarks += rowTotal;
        sums.totalLevels += totalLevel;

        const row = document.createElement("tr");
        row.setAttribute("data-grade", data.grade);
        row.setAttribute("data-exam-period", examPeriod);
        row.setAttribute("data-key", learner.key);

        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${data.name}</td>
          <td>${data.grade}</td>
          <td data-editable="true">${marks.eng}</td><td>${marks.engLev || ''}</td>
          <td data-editable="true">${marks.math}</td><td>${marks.mathLev || ''}</td>
          <td data-editable="true">${marks.preTech}</td><td>${marks.preTechLev || ''}</td>
          <td data-editable="true">${marks.kiswahili}</td><td>${marks.kiswahiliLev || ''}</td>
          <td data-editable="true">${marks.science}</td><td>${marks.scienceLev || ''}</td>
          <td data-editable="true">${marks.social}</td><td>${marks.socialLev || ''}</td>
          <td data-editable="true">${marks.agriculture}</td><td>${marks.agricultureLev || ''}</td>
          <td data-editable="true">${marks.cre}</td><td>${marks.creLev || ''}</td>
          <td data-editable="true">${marks.creativeArt}</td><td>${marks.creativeArtLev || ''}</td>
          <td><strong>${rowTotal}</strong></td>
          <td><strong>${totalLevel}</strong></td>
          <td>
            <button class="deleteMarksBtn" data-key="${learner.key}" data-exam="${examPeriod}">Delete</button>
          </td>
        `;

        marksTableBody.appendChild(row);
      });
    });

    const divisor = learnersWithMarks > 0 ? learnersWithMarks : 1;

    document.getElementById("totalsRow").innerHTML = `
      <td colspan="3"><strong>Totals</strong></td>
      <td>${sums.eng}</td><td></td>
      <td>${sums.math}</td><td></td>
      <td>${sums.preTech}</td><td></td>
      <td>${sums.kiswahili}</td><td></td>
      <td>${sums.science}</td><td></td>
      <td>${sums.social}</td><td></td>
      <td>${sums.agriculture}</td><td></td>
      <td>${sums.cre}</td><td></td>
      <td>${sums.creativeArt}</td><td></td>
      <td><strong>${sums.totalMarks}</strong></td>
      <td><strong>${sums.totalLevels}</strong></td>
      <td></td>
    `;

    document.getElementById("averagesRow").innerHTML = `
      <td colspan="3"><strong>Averages</strong></td>
      <td>${(sums.eng / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.math / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.preTech / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.kiswahili / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.science / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.social / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.agriculture / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.cre / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.creativeArt / divisor).toFixed(2)}</td><td></td>
      <td><strong>${(sums.totalMarks / divisor).toFixed(2)}</strong></td>
      <td><strong>${(sums.totalLevels / divisor).toFixed(2)}</strong></td>
      <td></td>
    `;

    if (isAdminLoggedIn) enableMarksEditing();
  });
}

function showToast(message, type = 'info') {
  const toast = document.getElementById("toast");
  toast.className = `toast show ${type}`;
  toast.innerHTML = message;

  setTimeout(() => {
    toast.className = toast.className.replace("show", "");
  }, 3000);
}

document.getElementById("subjectRankingReportBtn").addEventListener("click", () => {
  const grade = document.getElementById("reportGradeSelect").value;
  const examPeriod = document.getElementById("reportExamPeriodSelect").value;

  if (!grade || !examPeriod) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select both grade and exam period.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  generateSubjectRankingPerLearner(grade, examPeriod);
});


function generateSubjectRankingPerLearner(selectedGrade, selectedPeriod) {
    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];
    const subjectKeys = [
        'eng', 'math', 'preTech',
        'kiswahili', 'science', 'social',
        'agriculture', 'cre', 'creativeArt'
    ];

    const year = new Date().getFullYear();
    const learners = [];

    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/VSAh48K.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL LEARNER SUBJECT TRACKER REPORT</h2>
            <p>Address: P.O. Box 561-00902, Kikuyu, Kenya | Motto: "My Talent My Passion"</p>
            <p>Year: ${year} | Grade: ${selectedGrade} | Exam Period: ${selectedPeriod}</p>
        </div>

        <table style="width:100%; border-collapse: collapse; margin-top: 15px;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid black; padding: 8px;">No.</th>
                <th style="border: 1px solid black; padding: 8px;">Learner Name</th>
                <th style="border: 1px solid black; padding: 8px;">Subject</th>
                <th style="border: 1px solid black; padding: 8px;">Score</th>
                <th style="border: 1px solid black; padding: 8px;">Rank</th>
            </tr>
        </thead>
        <tbody>
    `;

    let learnerCount = 1;

    document.querySelectorAll("#marksList tr").forEach(row => {
        if (row.getAttribute("data-grade") !== selectedGrade) return;
        if (row.getAttribute("data-exam-period") !== selectedPeriod) return;

        const learnerName = row.cells[1].textContent;
        const scores = subjectKeys.map((key, i) => ({
            subject: subjects[i],
            score: parseFloat(row.cells[3 + i * 2].textContent) || 0
        }));
        scores.sort((a, b) => b.score - a.score);
        const top5 = scores.slice(0, 5);
        const total = top5.reduce((sum, s) => sum + s.score, 0);

        learners.push({ name: learnerName, topSubjects: top5, total });

        scores.forEach((entry, idx) => {
            html += `
                <tr>
                    <td style="border: 1px solid black; padding: 8px;">${learnerCount}</td>
                    <td style="border: 1px solid black; padding: 8px;">${learnerName}</td>
                    <td style="border: 1px solid black; padding: 8px;">${entry.subject}</td>
                    <td style="border: 1px solid black; padding: 8px;">${entry.score}</td>
                    <td style="border: 1px solid black; padding: 8px;">${idx + 1}</td>
                </tr>
            `;
        });

        learnerCount++;
    });

    html += `</tbody></table>
        <div style="text-align:right; margin-top: 20px;">
            <button id="printLearnerSubjectRankBtn" style="padding: 8px 16px; background: #007BFF; color: white; border: none; border-radius: 4px;">Print Report</button>
        </div>`;

    document.getElementById("reportOutput").innerHTML = html;

    // üéâ Celebration Styles
    if (!document.getElementById("perfCelebrationStyles")) {
        const s = document.createElement("style");
        s.id = "perfCelebrationStyles";
        s.textContent = `
            @keyframes floatUpP {0%{transform:translateY(0) scale(1);}100%{transform:translateY(-150px) scale(1.5);opacity:0;}}
            @keyframes zoomInFade {from{transform:scale(0.5);opacity:0;} to{transform:scale(1);opacity:1;}}
            @keyframes fadeOut {from{opacity:1;}to{opacity:0;}}
        `;
        document.head.appendChild(s);
    }

    function showEmojis() {
        const list = ['üéá','üéâ','ü•á','üí´','üèÜ','üåü','ü•à','ü•â','‚ú®'];
        for (let i = 0; i < 60; i++) {
            const e = document.createElement("span");
            const em = list[Math.floor(Math.random() * list.length)];
            const size = 20 + Math.random() * 20;
            e.textContent = em;
            e.style = `position:fixed;left:${Math.random()*100}vw;top:${Math.random()*100}vh;
                       font-size:${size}px;color:hsl(${Math.random()*360},100%,60%);
                       animation:floatUpP 3s ease-out forwards;pointer-events:none;z-index:9999`;
            document.body.appendChild(e);
            setTimeout(() => e.remove(), 10000);
        }
    }

    function showPopup(index, list) {
    if (index >= list.length) return;

    const learner = list[index];
    const popup = document.createElement("div");
    popup.style = `
        position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
        background:linear-gradient(to right,#fff8dc,#ffe680);
        border:4px solid gold;padding:25px;border-radius:20px;
        font:bold 20px sans-serif;box-shadow:0 0 25px gold;
        animation:zoomInFade 1s ease;
        z-index:10000;text-align:center;
        transition: opacity 1s;
    `;
    popup.innerHTML = `<div>üåü Top 5 Subjects for <strong>${learner.name}</strong> üåü<br><br>${
        learner.topSubjects.map((s, i) => `${i+1}. <strong>${s.subject}</strong>: ${s.score}`).join("<br>")
    }</div>`;
    document.body.appendChild(popup);

    let timeoutId;
    let released = false;

    function startTimer() {
        timeoutId = setTimeout(() => {
            popup.remove();
            showPopup(index + 1, list);
        }, 5000);
    }

    function clearTimer() {
        clearTimeout(timeoutId);
    }

    // Pause on hold
    popup.addEventListener('mousedown', clearTimer);
    popup.addEventListener('touchstart', clearTimer);

    // Resume on release
    popup.addEventListener('mouseup', () => {
        if (!released) {
            released = true;
            startTimer();
        }
    });
    popup.addEventListener('touchend', () => {
        if (!released) {
            released = true;
            startTimer();
        }
    });

    // Start initial timer
    startTimer();
}


    showEmojis();
    showPopup(0, learners);

    document.getElementById("printLearnerSubjectRankBtn").addEventListener("click", () => {
        const printContent = document.getElementById("reportOutput").innerHTML;
        const printWindow = window.open("", "_blank", "width=900,height=650");

        printWindow.document.write(`
            <html>
                <head>
                    <title>Subject Ranking Report Per Learner</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid black; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        img { max-width: 100px; }
                        button { display: none; }
                    </style>
                </head>
                <body>${printContent}</body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    });
}

  
 function enableEnterAsTab(containerSelector) {
    const container = document.querySelector(containerSelector);
    if (!container) return;

    container.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault(); // Prevent Enter from triggering default behavior

        const focusable = Array.from(container.querySelectorAll('input, select, button, [tabindex]'))
          .filter(el => !el.disabled && el.tabIndex >= 0 && el.offsetParent !== null);

        const index = focusable.indexOf(document.activeElement);
        if (index > -1 && index < focusable.length - 1) {
          focusable[index + 1].focus();
        }
      }
    });
  }

  // Enable Enter-as-Tab behavior in these sections
  enableEnterAsTab('#learnerForm');      // Registration form
  enableEnterAsTab('#marksForm');        // Marks form
  enableEnterAsTab('#learnersList');     // Registered Learners table rows

const adminCredentials = {
  username: 'admin',
  password: 'admin123'
};

let isAdminLoggedIn = false;

document.getElementById("loginForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();

  // Check for admin login
  const isAdmin = username === adminCredentials.username && password === adminCredentials.password;

  if (isAdmin || (username === "Nachu" && password === "1")) {
    if (isAdmin) {
      isAdminLoggedIn = true;
    }

    // Hide login form, show main content
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    document.getElementById("loginError").style.display = "none";

    if (isAdmin && typeof Swal !== "undefined") {
      Swal.fire({
        icon: 'success',
        title: 'Login Successful',
        text: 'Welcome, Admin!',
        timer: 1500,
        showConfirmButton: false
      });
    }

    if (isAdmin) {
      document.getElementById("saveEditedMarksBtn").style.display = "inline-block";
      document.querySelectorAll(".admin-only").forEach(btn => btn.style.display = "inline-block");
    }

  } else {
    // Failed login
    const loginError = document.getElementById("loginError");
    if (loginError) loginError.style.display = "block";

    if (typeof Swal !== "undefined") {
      Swal.fire({
        icon: 'error',
        title: 'Login Failed',
        text: 'Incorrect username or password'
      });
    } else {
      alert("Login failed: incorrect username or password.");
    }
  }
});



function enableMarksEditing() {
  if (!isAdminLoggedIn) return;

  const cells = document.querySelectorAll("#marksList td[data-editable='true']");
  cells.forEach(cell => {
    // Enable editable style
    cell.contentEditable = true;
    cell.style.backgroundColor = "#fff8dc";
    cell.style.border = "1px solid #ff9800";

    // Auto-save on blur
    cell.addEventListener("blur", function () {
      const row = cell.closest("tr");
      const learnerKey = row.getAttribute("data-key");
      const examPeriod = marksExamPeriodSelect.value;

      // Custom additions
      const subjectName = cell.getAttribute("data-subject") || "Subject";
      const learnerName = row.querySelector(".learner-name")?.innerText || "Learner";

      if (!learnerKey || !examPeriod) return;

      const cellValues = row.querySelectorAll("td[data-editable='true']");
      if (cellValues.length < 9) {
        console.warn(`Skipping ${learnerKey} ‚Äî not enough editable cells.`);
        return;
      }

      const marks = {
        eng: parseFloat(cellValues[0].innerText) || 0,
        math: parseFloat(cellValues[1].innerText) || 0,
        preTech: parseFloat(cellValues[2].innerText) || 0,
        kiswahili: parseFloat(cellValues[3].innerText) || 0,
        science: parseFloat(cellValues[4].innerText) || 0,
        social: parseFloat(cellValues[5].innerText) || 0,
        agriculture: parseFloat(cellValues[6].innerText) || 0,
        cre: parseFloat(cellValues[7].innerText) || 0,
        creativeArt: parseFloat(cellValues[8].innerText) || 0
      };

      const learnerMarksRef = ref(database, `learners/${learnerKey}/marks/${examPeriod}`);
      update(learnerMarksRef, marks)
        .then(() => {
          // Visual feedback on the cell
          cell.style.border = "2px solid green";
          setTimeout(() => {
            cell.style.border = "1px solid #ff9800";
          }, 1500);

          // üéâ Custom message
          Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: `‚úÖ ${subjectName} updated for ${learnerName}`,
            showConfirmButton: false,
            timer: 1800
          });
        })
        .catch(error => {
          console.error(`‚ùå Error updating ${learnerKey}:`, error);
          Swal.fire({
            icon: 'error',
            title: 'Update Failed',
            text: `Could not save ${subjectName} mark for ${learnerName}.`,
            footer: 'Please check your internet or permissions.',
            timer: 3000
          });
        });
    });
  });
}

import { get, update } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

// üîÅ Promote learners in the "learners" node (admin-only)
window.promoteLearners = async function () {
  if (!isAdminLoggedIn) {
    Swal.fire({
      icon: "error",
      title: "Access Denied",
      text: "Only admins can promote learners.",
      timer: 2000,
      showConfirmButton: false
    });
    return;
  }

  try {
    const snapshot = await get(learnersRef);

    if (!snapshot.exists()) {
      Swal.fire("No learners found to promote.");
      return;
    }

    const learners = snapshot.val();
    const updates = {};
    const summary = [];

    for (const key in learners) {
      const learner = learners[key];
      const currentGrade = learner.grade;
      const nextGrade = getNextGrade(currentGrade);

      if (nextGrade) {
        updates[`learners/${key}/grade`] = nextGrade;
        summary.push(`${learner.name}: ${currentGrade} ‚Üí ${nextGrade}`);
      }
    }

    if (Object.keys(updates).length === 0) {
      Swal.fire("No valid grades found for promotion.");
      return;
    }

    await update(ref(database), updates);

    Swal.fire({
      title: "üéâ Promotion Complete",
      html: `<pre style="text-align:left">${summary.join("\n")}</pre>`,
      icon: "success"
    });

  } catch (error) {
    console.error("Error promoting learners:", error);
    Swal.fire("Error", "Something went wrong while promoting.", "error");
  }
};

window.undoPromotion = async function () {
  if (!isAdminLoggedIn) {
    Swal.fire({
      icon: "error",
      title: "Access Denied",
      text: "Only admins can undo promotions.",
      timer: 2000,
      showConfirmButton: false
    });
    return;
  }

  try {
    const snapshot = await get(learnersRef);

    if (!snapshot.exists()) {
      Swal.fire("No learners found to undo promotion.");
      return;
    }

    const learners = snapshot.val();
    const updates = {};
    const summary = [];

    for (const key in learners) {
      const learner = learners[key];
      const currentGrade = learner.grade;
      const prevGrade = getPreviousGrade(currentGrade);

      if (prevGrade) {
        updates[`learners/${key}/grade`] = prevGrade;
        summary.push(`${learner.name}: ${currentGrade} ‚Üí ${prevGrade}`);
      }
    }

    if (Object.keys(updates).length === 0) {
      Swal.fire("No valid grades to undo.");
      return;
    }

    await update(ref(database), updates);

    Swal.fire({
      title: "üîÅ Undo Complete",
      html: `<pre style="text-align:left">${summary.join("\n")}</pre>`,
      icon: "info"
    });

  } catch (error) {
    console.error("Undo error:", error);
    Swal.fire("Error", "Something went wrong during undo.", "error");
  }
};

function getPreviousGrade(currentGrade) {
  const match = currentGrade.match(/(\d+)([A-Z]?)/i);
  if (!match) return null;

  const number = parseInt(match[1]);
  if (number <= 1) return null; // Avoid going below Grade 1

  const letter = match[2] || "";
  return `Grade ${number - 1}${letter.toUpperCase()}`;
}
function getNextGrade(currentGrade) {
  if (!currentGrade || typeof currentGrade !== "string") return null;

  const match = currentGrade.trim().match(/(\d+)([A-Z]?)/i);
  if (!match) return null;

  const number = parseInt(match[1]);
  const letter = match[2]?.toUpperCase() || "";

  return `Grade ${number + 1}${letter}`;
}
document.getElementById('searchMarksInput').addEventListener('input', function () {
  const searchValue = this.value.toLowerCase();
  const rows = document.querySelectorAll('#marksList tr');

  rows.forEach(row => {
    const name = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
    const adm = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';

    if (name.includes(searchValue) || adm.includes(searchValue)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});

function displayLearnersCount() {
    const learnersRef = ref(db, 'learners'); // Adjust the path if needed
    get(learnersRef).then((snapshot) => {
        if (snapshot.exists()) {
            const learners = snapshot.val();
            const totalLearners = Object.keys(learners).length; // Get the number of learners
            document.getElementById('totalLearners').textContent = totalLearners;
        } else {
            document.getElementById('totalLearners').textContent = "No learners found.";
        }
    }).catch((error) => {
        console.error("Error fetching learners count: ", error);
    });
}

// Call the function to display the learners count
displayLearnersCount();

document.addEventListener("DOMContentLoaded", () => {

  const deleteGradeBtn = document.getElementById("deleteGradeBtn");

  if (!deleteGradeBtn) {
    console.error("‚ùå deleteGradeBtn not found");
    return;
  }

  deleteGradeBtn.addEventListener("click", async () => {

    if (!isAdminLoggedIn) {
      Swal.fire("Access Denied", "Admins only", "error");
      return;
    }

    // üî• USE EXISTING FILTER SELECT
    if (!filterGradeSelect) {
      Swal.fire("Error", "Grade filter not found", "error");
      return;
    }

    const selectedGrade = filterGradeSelect.value;

    if (!selectedGrade) {
      Swal.fire("Select Grade", "Please select a grade first", "warning");
      return;
    }

    if (!allLearners.length) {
      Swal.fire("Please Wait", "Learners are still loading", "info");
      return;
    }

    const learnersToDelete = allLearners.filter(
      l => String(l.grade).trim() === String(selectedGrade).trim()
    );

    if (!learnersToDelete.length) {
      Swal.fire("No Learners", "No learners found in this grade", "info");
      return;
    }

    const confirm = await Swal.fire({
      title: `Delete ALL learners in ${selectedGrade}?`,
      html: `<b>${learnersToDelete.length}</b> learners will be 
             <span style="color:red;">PERMANENTLY deleted</span>`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      confirmButtonText: "Yes, delete all"
    });

    if (!confirm.isConfirmed) return;

    try {
      showLoadingSpinner?.();

      const updates = {};
      learnersToDelete.forEach(l => {
        updates[`learners/${l.key}`] = null;
      });

      await update(ref(database), updates);

      allLearners = allLearners.filter(l => l.grade !== selectedGrade);
      filteredLearners = [...allLearners];

      currentIndex = 0;
      tableBody.innerHTML = "";
      loadNextBatch();

      hideLoadingSpinner?.();

      Swal.fire("Deleted", `${learnersToDelete.length} learners removed`, "success");

    } catch (err) {
      hideLoadingSpinner?.();
      console.error("‚ùå Bulk delete error:", err);
      Swal.fire("Error", "Bulk delete failed", "error");
    }
  });

});



</script>


</body>
</html>
  
